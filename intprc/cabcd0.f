C
C PICKS UP INTEGRALS OFF OF SORT FILE AND PUTS THEM OUT ON MOINTS.
C  FOR FULL SORTS OF <IJ|KL> TYPE QUANTITIES (ALL I,J FOR A GIVEN K,L).
C
C THIS VERSION CREATES IMMEDIATELY A SYMMETRY PACKED LIST OF INTEGRALS 
C USING THE INVERSE SYMMETRY VECTOR.         
C
C  CODED JULY/90  JG
C
      SUBROUTINE CABCD0(W,BUF,IBUF,ICHAIN,DISSIZ,NDBCK,
     &                  NBKINT,NBUCK,IRECL,NUMIRW,ISYM,
     &                  IPW,IPDIS,IPDSZ,NWDIS,IUHF,GRAD,
     &                  IRREPA,IRREPB)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      LOGICAL GRAD
      INTEGER DISSIZ,DIRPRD
      INTEGER AND
      CHARACTER*80 FNAME
      DIMENSION W(DISSIZ*NDBCK),BUF(NBKINT),IBUF(NBKINT)
      DIMENSION ICHAIN(NBUCK),ISYM(1),NUMIRW(2*NIRREP),
     &          IPW(8),IPDIS(8),IPDSZ(8) 
      DIMENSION IRREPA(*),IRREPB(*)
      COMMON /MACHSP/ IINTLN,IFLTLN,IINTFP,IALONE,IBITWD
      COMMON /FILES/ LUOUT,MOINTS
      COMMON /INFO/ NOCCO(2),NVRTO(2)
      COMMON /SYMINF/ NSTART,NIRREP,IRREPY(255,2),DIRPRD(8,8)
      IUPKI(INT)=AND(INT,IALONE)
      IUPKJ(INT)=AND(ISHFT(INT,-IBITWD),IALONE)
      IUPKK(INT)=AND(ISHFT(INT,-2*IBITWD),IALONE)
      IUPKL(INT)=AND(ISHFT(INT,-3*IBITWD),IALONE)
      INDX(I,J,N)=I+(J-1)*N
      INDXA(I,J)=I+J*(J-1)/2
      JDIS=0
      IRREPW=1
      NOCCA=NOCCO(1)
      NOCCB=NOCCO(2)
      NVRT=NVRTO(1)
C
      CALL GFNAME('SRTFL1  ',FNAME,ILENGTH)
      OPEN(UNIT=20,FILE=FNAME(1:ILENGTH),FORM='UNFORMATTED',
     &ACCESS='DIRECT',RECL=IRECL)
      CALL GFNAME('SRTFL2  ',FNAME,ILENGTH)
      OPEN(UNIT=21,FILE=FNAME(1:ILENGTH),FORM='UNFORMATTED',
     &ACCESS='DIRECT',RECL=IRECL)
C
      IF(IUHF.EQ.0.AND..NOT.GRAD) THEN
      DO 10 IDIS=1,NBUCK
       ISTART=(IDIS-1)*NDBCK+1
       DO 1 IRREP=1,NIRREP
       IRREPST=IRREP
       IF(IPDIS(IRREP).GE.ISTART) THEN
        GO TO 2
       ENDIF
1      CONTINUE
       IRREPST=IRREPST+1
2      CONTINUE
       IRREPST=IRREPST-1
       IOFFST1=IPW(IRREPST)
       NNST=NUMIRW(IRREPST+NIRREP)
       IOFFST=IOFFST1+NNST*(ISTART-1-IPDIS(IRREPST))
       CALL ZERO(W,DISSIZ*NDBCK)
5      CONTINUE
       IF(MOD(ICHAIN(IDIS),2).EQ.0) THEN
        MREC=ICHAIN(IDIS)/2
        READ(20,REC=MREC)BUF,IBUF,NUT,ICHAN
       ELSE
        MREC=ICHAIN(IDIS)/2+1
        READ(21,REC=MREC)BUF,IBUF,NUT,ICHAN
       ENDIF
       ICHAIN(IDIS)=ICHAN
       DO 30 INT=1,NUT
        I=IUPKI(IBUF(INT))
        J=IUPKJ(IBUF(INT))
        K=IUPKK(IBUF(INT))
        L=IUPKL(IBUF(INT))
        ISQ1=INDXA(I,J)
        ISQ2=INDX(K,L,NVRT)
        IRREP12=DIRPRD(IRREPA(I+NOCCA),IRREPB(J+NOCCB))
        IOFF=IPW(IRREP12)
        NN=NUMIRW(IRREP12+NIRREP)
        IADR=IOFF+ISYM(ISQ1+NWDIS)-IPDSZ(IRREP12)
     &           +NN*(ISYM(ISQ2)-1-IPDIS(IRREP12))-IOFFST
        W(IADR)=BUF(INT)
30     CONTINUE
       IF(ICHAIN(IDIS).NE.0)GOTO 5
C
C  IF WE REACH THIS POINT, THE ENTIRE BUCKET IS IN CORE. WRITE
C  THEM TO A DIRECT ACCESS FILE 
C
       IOFFW=1
       DO 40 ID=1,NDBCK
39      JDIS=JDIS+1
        IF(JDIS.GT.NUMIRW(IRREPW)) THEN
        IRREPW=IRREPW+1
        IF(IRREPW.GT.NIRREP) GO TO 35
         JDIS=0
         GO TO 39
        ENDIF
        CALL PUTLST(W(IOFFW),JDIS,1,2,IRREPW,233)
        IOFFW=IOFFW+NUMIRW(IRREPW+NIRREP)
40     CONTINUE
35     CONTINUE
10    CONTINUE
C
C  HERE UHF AND GRADIENT RUNS RHF
C
      ELSE IF(IUHF.EQ.1.OR.GRAD) THEN
      DO 110 IDIS=1,NBUCK
       ISTART=(IDIS-1)*NDBCK+1
       DO 101 IRREP=1,NIRREP
       IRREPST=IRREP
       IF(IPDIS(IRREP).GE.ISTART) THEN
        GO TO 102
       ENDIF
101    CONTINUE
       IRREPST=IRREPST+1
102    CONTINUE
       IRREPST=IRREPST-1
       IOFFST1=IPW(IRREPST)
       NNST=NUMIRW(IRREPST+NIRREP)
       IOFFST=IOFFST1+NNST*(ISTART-1-IPDIS(IRREPST))
       CALL ZERO(W,DISSIZ*NDBCK)
105    CONTINUE
       IF(MOD(ICHAIN(IDIS),2).EQ.0) THEN
        MREC=ICHAIN(IDIS)/2
        READ(20,REC=MREC)BUF,IBUF,NUT,ICHAN
       ELSE
        MREC=ICHAIN(IDIS)/2+1
        READ(21,REC=MREC)BUF,IBUF,NUT,ICHAN
       ENDIF
       ICHAIN(IDIS)=ICHAN
       DO 130 INT=1,NUT
        I=IUPKI(IBUF(INT))
        J=IUPKJ(IBUF(INT))
        K=IUPKK(IBUF(INT))
        L=IUPKL(IBUF(INT))
        ISQ1=INDX(I,J,NVRT)
        ISQ2=INDX(K,L,NVRT)
        IRREP12=DIRPRD(IRREPA(I+NOCCA),IRREPB(J+NOCCB))
        IOFF=IPW(IRREP12)
        NN=NUMIRW(IRREP12+NIRREP)
        IADR=IOFF+ISYM(ISQ1+NWDIS)-IPDSZ(IRREP12)
     &           +NN*(ISYM(ISQ2)-1-IPDIS(IRREP12))-IOFFST
        W(IADR)=BUF(INT)
130     CONTINUE
       IF(ICHAIN(IDIS).NE.0)GOTO 105
C
C  IF WE REACH THIS POINT, THE ENTIRE BUCKET IS IN CORE. WRITE
C  THEM TO A DIRECT ACCESS FILE 
C
       IOFFW=1
       DO 140 ID=1,NDBCK
139     JDIS=JDIS+1
        IF(JDIS.GT.NUMIRW(IRREPW)) THEN
        IRREPW=IRREPW+1
        IF(IRREPW.GT.NIRREP) GO TO 135
         JDIS=0
         GO TO 139
        ENDIF
        CALL PUTLST(W(IOFFW),JDIS,1,2,IRREPW,233)
        IOFFW=IOFFW+NUMIRW(IRREPW+NIRREP)
140     CONTINUE
135     CONTINUE
110    CONTINUE
       ENDIF
C
C  ALL DONE
C
      NUMREC=0
      DO 50 I=1,NIRREP
       NUMREC=NUMREC+NUMIRW(IRREP+NIRREP)*NUMIRW(IRREP)
50    CONTINUE 
      WRITE(LUOUT,300) NUMREC
300   FORMAT(T3,'@CABCD0-I, Wrote ',I10,' symmetry blocked integrals',
     &       ' to disk.')
      CLOSE(UNIT=20,STATUS='DELETE')
      CLOSE(UNIT=21,STATUS='DELETE')
      RETURN
      END
