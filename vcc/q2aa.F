      SUBROUTINE Q2AA(T,W,Z,T1A,TAU,ISPIN,POP,VRT,NOCCSQ,
     &                DISSYW,DISSYT,NUMSYW,NUMSYT,IRREP,TMP,FACT,UCC)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      LOGICAL TAU,UCC,ADC2
      INTEGER DISSYT,DISSYW,DIRPRD,POP,VRT
      DIMENSION W(DISSYW,NOCCSQ),T(DISSYT,NOCCSQ),Z(NOCCSQ)
      DIMENSION TMP(1)
      DIMENSION POP(8),VRT(8),T1A(1)
      COMMON /SYMINF/ NSTART,NIRREP,IRREPA(255),IRREPB(255),DIRPRD(8,8)
      COMMON /FLAGS/  IFLAGS(100)
      COMMON /FLAGS2/ IFLAGS2(500)

      DATA ONEM,ONE,HALF,TWO /-1.0D0,1.D0,0.5D0,2.D0/
C
      IND(I,J)=((I-2)*(I-1))/2+J

C      PICK UP FIRST THE RELEVANT T2 AND W PIECES
C
      CALL GETLST(W,1,NUMSYW,2,IRREP,ISPIN+13)
      CALL GETLST(T,1,NUMSYT,1,IRREP,ISPIN+43)

C ADC2 check; CALC=MBPT(2),EXCITE=EOMEE,EOMREF=ADC2
C
      ADC2 = .FALSE.
      ADC2 =  (IFLAGS(2) .EQ. 1 .AND. IFLAGS(87) .EQ. 3 .AND. 
     &         IFLAGS2(117) .EQ. 10)
C
      IF(TAU) THEN
        CALL FTAU(T,T1A,T1A,DISSYT,NUMSYT,POP,POP,VRT,VRT,
     &            IRREP,ISPIN,HALF)
      ENDIF
C
      CALL SYMEXP(IRREP,POP,DISSYW,W)
      CALL SYMEXP(IRREP,POP,DISSYT,T)
C
         JOFF=1
         IOFF=1
         DO 90 IRREPJ=1,NIRREP
C          
C        GET OCCUPATION NUMBER FOR JRREP     
C
           NOCCJ=POP(IRREPJ)
C
C
C        IF ZERO, NOTHING TO COMPUTE
C
           IF(NOCCJ.EQ.0) GO TO 90
C
C        DETERMINE IRREPI WHOSE DIRECT PRODUCT WITH JRREP GIVES IRREP
C
           IRREPI=DIRPRD(IRREP,IRREPJ)
C
C        GET OCCUPATION NUMBER FOR IRREPI
C
           NOCCI=POP(IRREPI)
C
C        IF ZERO, NOTHING TO COMPUTE
C
           IF(NOCCI.EQ.0) GO TO 80
C
            CALL XGEMM('T','N',NOCCJ,NOCCJ,DISSYW*NOCCI,FACT,
     &                 W(1,JOFF),NOCCI*DISSYW,T(1,JOFF),      
     &                 NOCCI*DISSYW,ONE,Z(IOFF),NOCCJ)
            IF(UCC) CALL DT(ONE,Z(IOFF),NOCCJ,NOCCJ,'ADD',Z(IOFF))
C
           JOFF=JOFF+NOCCJ*NOCCI 
C
C The ADC(2) variants needs symmetrization of this contribution. So,
C check whether we are doing EOM-MBPT(2) with the EOM-REF=ADC(2).
C 
C            IF (ADC2) CALL SYMMET2(Z(IOFF), NOCCJ)
C      

80         CONTINUE
C
C         UPDATE THE OFFSET FOR THE INTERMEDIATE Z
C
            IOFF=IOFF+POP(IRREPJ)**2
90        CONTINUE
C
      RETURN
      END
