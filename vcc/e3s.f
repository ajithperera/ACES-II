      SUBROUTINE E3S(ICORE,MAXCOR,IUHF,SE4)
C
C  THIS ROUTINE IS THE DRIVER FOR THE CONTRIBUTION OF THE DOUBLES
C  TO THE SECOND ORDER SINGLES FOR NON-HF PERTURBATION THEORY.  IT IS 
C  SIMPLY A HACKED-UP VERSION OF E4S.
C
CEND
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      INTEGER DIRPRD,POP1,POP2,VRT1,VRT2
      LOGICAL LAMBDA,NONHF
      LOGICAL MBPT3,MBPT4,CC,TRPEND,SNGEND,GRAD,MBPTT,SING1,QCISD,UCC
      EQUIVALENCE(IFLAGS(2),METHOD)
      DIMENSION ICORE(MAXCOR)
      COMMON/SWITCH/MBPT3,MBPT4,CC,TRPEND,SNGEND,GRAD,MBPTT,SING1,
     &              QCISD,UCC
      COMMON/SYM/ POP1(8),POP2(8),VRT1(8),VRT2(8),NTAA,NTBB,NF1AA,
     &            NF1BB,NF2AA,NF2BB
      COMMON /MACHSP/ IINTLN,IFLTLN,IINTFP,IALONE,IBITWD
      COMMON /FILES/ LUOUT,MOINTS
      COMMON /FLAGS/ IFLAGS(100)
      COMMON /INFO/ NOCCO(2),NVRTO(2)
      COMMON /NHFREF/ NONHF
C
      COMMON/SYMINF/NSTART,NIRREP,IRREPA(255),IRREPB(255),
     &DIRPRD(8,8)
      DATA ONE /1.0/
C
C
C  FLAG IF LAMBDA OR CC EQUATIONS ARE SOLVED
C
      LAMBDA=.FALSE.
C
      NOCCA=NOCCO(1)
      NOCCB=NOCCO(2)
      NVRTA=NVRTO(1)
      NVRTB=NVRTO(2)
      NWAA=NTAA
      NWBB=NTBB
C
      ITAA=MAXCOR+1-NWAA*IINTFP
      MXCOR=MAXCOR+1-NWAA*IINTFP
      IF(IUHF.EQ.0) THEN
       ITBB=ITAA
      ELSE
       ITBB=ITAA-NWBB*IINTFP
       MXCOR=MXCOR-NWBB*IINTFP
      ENDIF
C
      IF (NONHF) THEN
          CALL GETLST(ICORE(ITAA),1,1,1,3,90)
          IF(IUHF.EQ.1) CALL GETLST(ICORE(ITBB),1,1,1,4,90)
      ENDIF 
C
C  WITHIN THE SPIN ADAPTED RHF CODE NO CALL TO T2t1AA2 IS NECESSARY
C
      IF(IUHF.EQ.1) THEN
       CALL T2T1AA2(ICORE(ITAA),ICORE,MXCOR,POP1,VRT1,1,LAMBDA,0)
C
       CALL T2T1AA2(ICORE(ITBB),ICORE,MXCOR,POP2,VRT2,2,LAMBDA,0)
      ENDIF
C
C
      CALL T2T1AB2(ICORE(ITAA),ICORE,MXCOR,POP1,POP2,VRT1,VRT2,1,
     &             IUHF,LAMBDA,0)
C
      IF(IUHF.EQ.1) THEN
      CALL T2T1AB2(ICORE(ITBB),ICORE,MXCOR,POP2,POP1,VRT2,VRT1,2,
     &             IUHF,LAMBDA,0)
      ENDIF
C
C  WITHIN THE SPIN ADAPTED RHF CODE NO CALL TO T2T1AA1 IS NECESSARY
C
      IF(IUHF.EQ.1) THEN
       CALL T2T1AA1(ICORE(ITAA),ICORE,MXCOR,POP1,VRT1,1,LAMBDA,0)
C
       CALL T2T1AA1(ICORE(ITBB),ICORE,MXCOR,POP2,VRT2,2,LAMBDA,0)
      ENDIF
C
C
      CALL T2T1AB1(ICORE(ITAA),ICORE,MXCOR,POP1,POP2,VRT1,VRT2,1,
     &             IUHF,LAMBDA,0)
C
      IF(IUHF.EQ.1) THEN
      CALL T2T1AB1(ICORE(ITBB),ICORE,MXCOR,POP2,POP1,VRT2,VRT1,2,
     &             IUHF,LAMBDA,0)
      ENDIF
C
C     NOW UPDATE THE T1 AREA
C
      CALL PUTLST(ICORE(ITAA),1,1,1,3,90)
      IF(IUHF.EQ.1) CALL PUTLST(ICORE(ITBB),1,1,1,4,90)

      SING1 = .TRUE.
      RETURN
      END
