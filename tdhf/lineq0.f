      SUBROUTINE LINEQ0(IVRT,IOCC,IVRTS,IOCCS,OMEGA,NPERT,IPN,APMAT
     X ,AMMAT,BIAP,BIAM,BIPNEW,BIMNEW,UPDATE,ASMALL,ASQUARE,ASCALE
C    X ,ICONV,EVAL,EVEC,NUMSCF,NIREP,FP,FM,DENP,DENM,CONV,N,KMAX)
     X ,ICONV,EVAL,EVEC,NSIZ1,NIREP,FP,FM,DENP,DENM,CONV,N,KMAX
     X ,XX,IX,IA,NINTMX) 
C
C  THIS PROGRAM SOLVES THE LINEAR CPHF EQUATION
C
C  SUM A I (A(AI,BJ)/(EA-EI) -  DELTA(BA)*DELTA(IJ)) U(BJ)  = -X(A,I)
C
C  USING AN ITERATIVE EXPANSION IN A SUBSPACE SPANNED BY THE
C  VECTORS B(AI) A'**N (BJ,AI). THE METHOD HAS BEEN FIRST USED
C  BY POPLE AND COWORKERS FOR SOLVING THE CPHF-EQUATIONS AND
C 
C
C  NPERT ... NUMBER OF PERTURBATIONS TREATED
C  AMAT .... CONTAINS THE MODIFIED A-MATRIX AS PROVIDED BY MKARHF
C  BIA  .... B(AI) AS INPUT, U(AI) AS OUTPUT
C  BIANEW .. SCRATCH VECTOR OF LENGTH MAX(N,2*KMAX)
C  UPDATE .. CONTAINS ALL THE EXPANSION VECTOR (LENGTH KMAX*N*NPERT)
C  ASMALL .. THE A MATRIX WITHIN THE ITERATIVE SUBSPACE ( LENGTH 
C            KMAX**2)*NPERT
C  ASQUARE . A VECTOR OF LENGTH (KMAX+1)*NPERT  WHICH HOLDS THE NORMS OF THE 
C            EXPANSION VECTORS
C  ASCALE .. A VECTOR OF LENGTH NPERT WHICH HOLDS SOME SCALING FACTORS
C  ICONV ... A VECTOR HOLDING THE NUMBER OF ITERATIONS REQUIRED TO 
C            CONVERGE A SINGLE PERTURBATION (LENGTH NPERT)
C  EVAL .... EIGENVALUES
C  CONV .... CONVERGENCE CRITERION
C  N ....... NUMBER OF ELEMENTS IN B(AI) OR U(AI)
C  KMAX .... MAXIMUM NUMBER OF ITERATION ALLOWED IN THE ITERATIVE EXPANSION
C
CEND
C 
C modified from LINEQ1 by HS April/91
C
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
C     INTEGER DIRPRD,POP,VRT
      DIMENSION APMAT(1),AMMAT(1),BIAP(N,NPERT),BIAM(N,NPERT),
     X          BIPNEW(N,NPERT),BIMNEW(N,NPERT),
     &          UPDATE(N,NPERT,KMAX,2),ASMALL(KMAX,KMAX,NPERT),
     &          ASQUARE(KMAX+1,NPERT),ASCALE(NPERT),
     &          EVAL(1),ICONV(NPERT)
      DIMENSION IVRT(N),IOCC(N),IVRTS(N,NIREP),IOCCS(N,NIREP)
C  ............ AO algorithm .................................
      DIMENSION FP(NSIZ1,NSIZ1),FM(NSIZ1,NSIZ1),DENP(1),DENM(1)
     X ,EVEC(1)
      DIMENSION XX(NINTMX),IX(NINTMX),IA(1)
      COMMON/MACHSP/IINTLN,IFLTLN,IINTFP,IALONE,IBITWD
      COMMON/SWPPP/INP,IAMO,IFAMO,IINDO,IORTH               
      COMMON/INFOA/NBASIS,NUMSCF,NX,NMO2,NOC,NVT,NVO     
      COMMON/INFSYM/NSYMHF,NSO(8),NOCS(8),NVTS(8),IDPR(8,8),NVOS(8)
     X ,NIJS(8),NIJS2(8),NRDS(8),NIJSR(8)
      COMMON/INFPRS/IPRSYM(12),NPRSYM(8),JPRSYM(8,12)
      DATA AZERO,ONE,SMALL/0.D+0,1.0D+0,1.D-24/
C
      write(6,*) ' here we are in LINEQ0 '
      CUTOFF=CONV*CONV
      TOL=AZERO
      write(6,*) ' N,NPERT,KMAX ',N,NPERT,KMAX
C
C     CLEAR SMALL A MATRIX
C
      CALL IZERO(ICONV,NPERT)
      CALL ZERO(ASMALL,KMAX*KMAX*NPERT)
C
C     NORMALIZE INITIAL VECTOR BIAP-BIAM AND COPY INTIAL VECTOR TO UPDATE
C
      DO 10 IPERT=1,NPERT
      MCOMS=IPRSYM(IPERT+IPN)
      NVOSYM=NVOS(MCOMS)
CCC     ANORM1 =SDOT(N,BIAP(1,IPERT),1,BIAP(1,IPERT),1)
      ANORM1 =SDOT(NVOSYM,BIAP(1,IPERT),1,BIAP(1,IPERT),1)
CCC      ANORM2 =  SDOT(N,BIAM(1,IPERT),1,BIAM(1,IPERT),1)
      ANORM2 =  SDOT(NVOSYM,BIAM(1,IPERT),1,BIAM(1,IPERT),1)
      ANORM = ANORM1 + ANORM2
C
C     DETERMINE SCALE FACTOR
C
      ASCALE(IPERT)=SQRT(ANORM)
C
C  IF INITIAL VECTOR EQUAL ZERO, WRITE WARNING
C
CCC     IF(ASCALE(IPERT)/N.LT.CUTOFF)
      IF(ASCALE(IPERT)/NVOSYM.LT.CUTOFF)
     X THEN
       WRITE(6,*) ' Warning from Lineq0 : The initial vector is zero.'
       ASCALE(IPERT)=ONE
      ENDIF
C
C     SCALE INITIAL VECTOR WITH ASCALE
C
      SCALE=ONE/ASCALE(IPERT)
      write(6,*) ' SCALE = ',SCALE,' for ',IPERT
C     write(6,*) ' ANORM1,ANORM2,ANORM ',ANORM1,ANORM2,ANORM
CCC     CALL SSCAL(N,SCALE,BIAP(1,IPERT),1)
      CALL SSCAL(NVOSYM,SCALE,BIAP(1,IPERT),1)
CCC     CALL SSCAL(N,SCALE,BIAM(1,IPERT),1)
      CALL SSCAL(NVOSYM,SCALE,BIAM(1,IPERT),1)
C
      ASQUARE(1,IPERT)=ONE
   10 CONTINUE
C
C     write(6,*) ' IINTFP ',IINTFP
C     DO 93 I=1,N
C  93 WRITE(6,*) IOCC(I),IVRT(I),BIAP(I,3),BIAM(I,3)
C    X ,EVAL(IOCC(I)),EVAL(IVRT(I))
c YAU : old
c     CALL ICOPY(IINTFP*N*NPERT,BIAP(1,1),1,UPDATE(1,1,1,1),1)
c     CALL ICOPY(IINTFP*N*NPERT,BIAM(1,1),1,UPDATE(1,1,1,2),1)
c YAU : new
      CALL DCOPY(N*NPERT,BIAP(1,1),1,UPDATE(1,1,1,1),1)
      CALL DCOPY(N*NPERT,BIAM(1,1),1,UPDATE(1,1,1,2),1)
c YAU : end
C
C    LOOP OVER K UNTIL THE NEW VECTOR IS LINEAR DEPENDENT OR
C    KMAX IS REACHED
C
      DO 1000 K=1,KMAX
C
      write(6,*) ' iteration = ',K
      IF(IFAMO.EQ.0) THEN
      DO 91 IP=1,NPERT
      MCOMS=IPRSYM(IP+IPN)
      NVOSYM=NVOS(MCOMS)
C     CALL XGEMM('N','N',N,NPERT,N,ONE,APMAT,N,BIAP,N,AZERO,BIPNEW,N)
      CALL XGEMM('N','N',NVOS(MCOMS),1,NVOS(MCOMS),ONE,
     X APMAT(NIJS2(MCOMS)+1),NVOS(MCOMS),BIAP(1,IP),NVOS(MCOMS),AZERO,
     X BIPNEW(1,IP),NVOS(MCOMS))
CCC     CALL VMXM(APMAT(NIJS2(MCOMS)+1),BIAP(1,IP),BIPNEW(1,IP),NVOSYM)
C     CALL XGEMM('N','N',N,NPERT,N,ONE,AMMAT,N,BIAM,N,AZERO,BIMNEW,N)
      CALL XGEMM('N','N',NVOS(MCOMS),1,NVOS(MCOMS),ONE,
     X AMMAT(NIJS2(MCOMS)+1),NVOS(MCOMS),BIAM(1,IP),NVOS(MCOMS),AZERO,
     X BIMNEW(1,IP),NVOS(MCOMS))
CCC     CALL VMXM(AMMAT(NIJS2(MCOMS)+1),BIAM(1,IP),BIMNEW(1,IP),NVOSYM)
      DO 91 I=1,NVOSYM
      IO=IOCCS(I,MCOMS)
      IV=IVRTS(I,MCOMS)
      BIPNEW(I,IP)=(BIPNEW(I,IP)+OMEGA*BIAM(I,IP))
     X /(EVAL(IO)-EVAL(IV))
      BIMNEW(I,IP)=(BIMNEW(I,IP)+OMEGA*BIAP(I,IP))
     X /(EVAL(IO)-EVAL(IV))
   91 CONTINUE
C ....... Mada Taishousei wa haitte inai ........
      ELSE
      DO 92 IP=1,NPERT
      CALL DENSP(NBASIS,N,IVRT,IOCC,EVEC,BIAP(1,IP),DENP)
      CALL DENSM(NBASIS,N,IVRT,IOCC,EVEC,BIAM(1,IP),DENM)
      IF(IINDO.EQ.0) THEN
      CALL FNOK(DENP,EVEC,FP,NBASIS,NUMSCF,XX,IX,NINTMX,IA)
      CALL FNOL(DENM,EVEC,FM,NBASIS,NUMSCF,XX,IX,NINTMX,IA)
      ELSE
      CALL FINDO(NBASIS,N,IVRT,IOCC,EVEC,DENP,FP)
      CALL FIMDO(NBASIS,N,IVRT,IOCC,EVEC,DENM,FM)
      END IF
      DO 92 I=1,N
      IO=IOCC(I)
      IV=IVRT(I)
      BIPNEW(I,IP)=FP(IV,IO)
      BIMNEW(I,IP)=FM(IV,IO)
   92 CONTINUE
      DO 90 IP=1,NPERT
      DO 90 I=1,N
      BIPNEW(I,IP)= (BIPNEW(I,IP)+OMEGA*BIAM(I,IP))
     X /(EVAL(IOCC(I))-EVAL(IVRT(I)))
      BIMNEW(I,IP)= (BIMNEW(I,IP)+OMEGA*BIAP(I,IP))
     X /(EVAL(IOCC(I))-EVAL(IVRT(I)))
C     IF(IP.EQ.3.AND.K.LE.5.AND.ABS(BIAP(I,IP)).GT.1.D-6)
C    X write(6,*) IOCC(I),IVRT(I),BIAP(I,IP),BIAM(I,IP),IP
   90 CONTINUE
      END IF
C
C    FORM ELEMENTS OF MATRIX ASMALL
C
      DO 20 IPERT=1,NPERT
      MCOMS=IPRSYM(IPERT+IPN)
      NVOSYM=NVOS(MCOMS)
      DO 100 L=1,K
CCC     ASMALL(L,K,IPERT)=SDOT(N,UPDATE(1,IPERT,L,1),1,BIPNEW(1,IPERT),1)
      ASMALL(L,K,IPERT)
     X  =SDOT(NVOSYM,UPDATE(1,IPERT,L,1),1,BIPNEW(1,IPERT),1)
      ASMALL(L,K,IPERT) = ASMALL(L,K,IPERT) +
CCC    X  SDOT(N,UPDATE(1,IPERT,L,2),1,BIMNEW(1,IPERT),1)
     X  SDOT(NVOSYM,UPDATE(1,IPERT,L,2),1,BIMNEW(1,IPERT),1)
100   CONTINUE
      IF(K.GT.1) ASMALL(K,K-1,IPERT)=ASQUARE(K,IPERT)
C
C    ORTHOGONALIZE new vectors(BIPNEW-BIMNEW) TO PREVIOUS VECTORS
C
      DO 200 L=1,K
      SCALE=-ASMALL(L,K,IPERT)/ASQUARE(L,IPERT)
CCC     CALL SAXPY(N,SCALE,UPDATE(1,IPERT,L,1),1,BIPNEW(1,IPERT),1)
      CALL SAXPY(NVOSYM,SCALE,UPDATE(1,IPERT,L,1),1,BIPNEW(1,IPERT),1)
      SCALE=-ASMALL(L,K,IPERT)/ASQUARE(L,IPERT)
CCC     CALL SAXPY(N,SCALE,UPDATE(1,IPERT,L,2),1,BIMNEW(1,IPERT),1)
      CALL SAXPY(NVOSYM,SCALE,UPDATE(1,IPERT,L,2),1,BIMNEW(1,IPERT),1)
200   CONTINUE
C
CCC     ASQUARE(K+1,IPERT)=SDOT(N,BIPNEW(1,IPERT),1,BIPNEW(1,IPERT),1)
      ASQUARE(K+1,IPERT)
     X  =SDOT(NVOSYM,BIPNEW(1,IPERT),1,BIPNEW(1,IPERT),1)
      ASQUARE(K+1,IPERT)= ASQUARE(K+1,IPERT) +
CCC    X  SDOT(N,BIMNEW(1,IPERT),1,BIMNEW(1,IPERT),1)
     X  SDOT(NVOSYM,BIMNEW(1,IPERT),1,BIMNEW(1,IPERT),1)
20    CONTINUE
      write(6,*) K+1,(ASQUARE(K+1,IPERT),IPERT=1,NPERT)
c YAU : old
c     CALL ICOPY(IINTFP*N*NPERT,BIPNEW,1,BIAP,1)
c     CALL ICOPY(IINTFP*N*NPERT,BIPNEW,1,UPDATE(1,1,K+1,1),1)
c     CALL ICOPY(IINTFP*N*NPERT,BIMNEW,1,BIAM,1)
c     CALL ICOPY(IINTFP*N*NPERT,BIMNEW,1,UPDATE(1,1,K+1,2),1)
c YAU : new
      CALL DCOPY(N*NPERT,BIPNEW,1,BIAP,1)
      CALL DCOPY(N*NPERT,BIPNEW,1,UPDATE(1,1,K+1,1),1)
      CALL DCOPY(N*NPERT,BIMNEW,1,BIAM,1)
      CALL DCOPY(N*NPERT,BIMNEW,1,UPDATE(1,1,K+1,2),1)
c YAU : end
C
C  CHECK FOR CONVERGENCE OF THE CREATED ITERATIVE SUBSPACE
C
      SUM=AZERO
      DO 30 IPERT=1,NPERT
      MCOMS=IPRSYM(IPERT+IPN)
      NVOSYM=NVOS(MCOMS)
CCC     TEST=ASQUARE(K+1,IPERT)/N
      TEST=ASQUARE(K+1,IPERT)/NVOSYM
      IF(TEST.LE.SMALL) THEN
       ASQUARE(K+1,IPERT)=ONE
       IF(ICONV(IPERT).EQ.0)ICONV(IPERT)=K
      ENDIF
      SUM=SUM+TEST
30    CONTINUE
      IF(SUM.LT.CUTOFF) THEN
C
C      ITERATIVE EXPANSION HAS CONVERGED, EXIT THE LOOP
C
       GO TO 300
      ENDIF
1000  CONTINUE
C
C  IF WE REACH THIS POINT, THE ITERATIVE EXPANSION HAS NOT CONVERGED
C
      WRITE(6,3000) KMAX
3000  FORMAT(' @-LINEQ1-I, TDHF did not converge after ',I4,
     X ' cycles,',' abort !')
      WRITE(6,3001) TEST
3001  FORMAT(' @-LINEQ1-I, Convergence is : ',E20.10)
CC     CALL ERREX
C
C   NOW INVERT THE ASMALL MATRIX
C
  300 CONTINUE
C
      WRITE(6,3002) K
3002  FORMAT(' @-LINEQ1-I, TDHF  converged after ',I3,' iterations.')
C
C  SUBTRACT THE DIAGONAL PART 
C
C  NOTE THE ASMALL MATRIX CONSISTS OF SEVERAL PARTS
C
C  FIRST THE  UPPER TRIANGLE WITH L LT K
C 
C    THAT'S SIMPLY    Y(L)  A Y(K)
C
C  THE DIAGONAL ELEMENTS
C
C   THAT'S   Y(K) A Y(K) - Y(K) Y(K)
C
C  THE UPPER TRIANGLE WITH L GT K+1
C
C  THESE ARE ZERO SINCE Y(L) SPANS A DIMENSION NOT COVERED BY A Y(K)
C
C  THE LOWER TRIANGLE WITH L EQ K+1
C
C  THESE ARE  Y(K+1) A(K) Y(K) =  Y(K+1) Y(K+1) = ASQUARE(K+1)
C
      CALL ZERO(BIAP,N*NPERT)
      CALL ZERO(BIAM,N*NPERT)
C
      DO 40 IPERT=1,NPERT
      MCOMS=IPRSYM(IPERT+IPN)
      NVOSYM=NVOS(MCOMS)
C
      K1=K
      IF(ICONV(IPERT).NE.0) K1=ICONV(IPERT)
C
      DO 310 I=1,K1
       ASMALL(I,I,IPERT)=ASMALL(I,I,IPERT)-ASQUARE(I,IPERT)
310   CONTINUE
C
C  INVERT A (XIANEW IS HERE USED AS SCRATCH AND NO LONGER USED
C  FOR HOLDING A*Y
C
      CALL MINV(ASMALL(1,1,IPERT),K1,KMAX,BIPNEW,DET,TOL,0,1)
C
      DO 330 I=1,K1
       ASQUARE(I,IPERT)=-ASCALE(IPERT)*ASMALL(I,1,IPERT)
330   CONTINUE
C
C     NOW FORM SOLUTION IN XIA
C
      DO 340 I=1,K1
CCC      CALL SAXPY(N,ASQUARE(I,IPERT),UPDATE(1,IPERT,I,1),1,
       CALL SAXPY(NVOSYM,ASQUARE(I,IPERT),UPDATE(1,IPERT,I,1),1,
     & BIAP(1,IPERT),1)
CCC      CALL SAXPY(N,ASQUARE(I,IPERT),UPDATE(1,IPERT,I,2),1,
       CALL SAXPY(NVOSYM,ASQUARE(I,IPERT),UPDATE(1,IPERT,I,2),1,
     & BIAM(1,IPERT),1)
340   CONTINUE
40    CONTINUE 
C
C   ALL DONE, RETURN
C
      RETURN
      END
