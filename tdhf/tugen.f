      SUBROUTINE TUGEN(UP,UM,APVEC,AMVEC,APVEC1,AMVEC1,ABP,ABM,ABPM
     X ,UVAL,UVEC,WVAL,WVEC,PORT,SCR,SVEC,TVEC,ZVEC,YVEC,REDVEC,
     X IVRT,IOCC,IVRTS,IOCCS,DENP,DENM
     X ,FP,FM,F,E,IA,HMO,EVAL,EVEC,ENRG,UPDATE,ASMALL,ASQUARE,ASCALE
     X ,ICONV,OMEGA,MCOMP,XX,IX,NIREP,NSIZ1,NSIZ3,NSIZO,NSIZVO,NINTMX)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      CHARACTER*1 AXYZ 
      DIMENSION IVRT(NSIZVO),IOCC(NSIZVO),IVRTS(NSIZVO,NIREP)
     X ,IOCCS(NSIZVO,NIREP)
      DIMENSION UP(NSIZ1,NSIZO,MCOMP),UM(NSIZ1,NSIZO,MCOMP)
     X ,ABP(1),ABM(1),ABPM(1),APVEC(NSIZVO,MCOMP),AMVEC(NSIZVO,MCOMP)
     X ,APVEC1(NSIZVO,MCOMP),AMVEC1(NSIZVO,MCOMP)
     X ,EVAL(NSIZ1),EVEC(NSIZ1,NSIZ1),ENRG(3,MCOMP)
     X ,UVAL(1),UVEC(1),WVAL(1),WVEC(1),PORT(1)
      DIMENSION DENP(1),DENM(1),F(NSIZ1,NSIZ1,MCOMP)
     X ,E(NSIZO,NSIZO,MCOMP),HMO(NSIZ3,3),IA(1),FP(1),FM(1),SCR(1)
      DIMENSION SVEC(1),TVEC(1),ZVEC(1),YVEC(1),REDVEC(1)
      DIMENSION XX(NINTMX),IX(NINTMX)
      DIMENSION UPDATE(1),ASMALL(1),ASQUARE(1),ASCALE(1),ICONV(1)
      DIMENSION AXYZ(3),L1(9),L2(9)
      COMMON/INFOA/NBASIS,NUMSCF,NX,NMO2,NOC,NVT,NVO     
      COMMON/INFSYM/NSYMHF,NSO(8),NOCS(8),NVTS(8),IDPR(8,8),NVOS(8)
     X ,NIJS(8),NIJS2(8),NRDS(8),NIJSR(8)
      COMMON/INFPRS/IPRSYM(12),NPRSYM(8),JPRSYM(8,12)
      COMMON/IPRNT/ IOPEV,IOPDA,IOPU,IOPFE,IOPPR,IWRPA
      COMMON/THRES/ TOLPER,DEGEN,EPSI
      COMMON/THRE1/ NITER,MAXIT
      COMMON/LRDUCE/ CONVI
      COMMON/LRDUC1/ KMAX
      COMMON/SWPPP/INP,IAMO,IFAMO,IINDO,IORTH         
      COMMON /TIMEINFO/ TIMEIN, TIMENOW, TIMETOT, TIMENEW     
C
      DATA ZERO,TWO,FOUR/0.D0,2.D0,4.D0/ 
C ........................  (xx,yy,zz,xy,yz,zx,yx,zy,xz) ......
      DATA AXYZ/'x','y','z'/,L1/1,2,3,1,2,3,2,3,1/,
     X                       L2/1,2,3,2,3,1,1,2,3/
C ... one root required 
C ..... scratch should have length of 2*NVO at least
      WRITE(6,*) ' now in TUGEN'
      SQRT2= SQRT(TWO)
C     WRITE(6,*) ' A+B matrix '
C     CALL OUTMXD(ABP,NSIZVO,NVO,NSIZIV)       
       IF(NITER.NE.0) THEN       
      DO 47 MCOM=1,MCOMP
      MCOMS=IPRSYM(MCOM+3)
      NVOSYM=NVOS(MCOMS)
      DO 42 I=1,NVOSYM
      APVEC1(I,MCOM)=ZERO
      AMVEC1(I,MCOM)=ZERO
      APVEC1(I,MCOM)= UP(IVRTS(I,MCOMS),IOCCS(I,MCOMS),MCOM)
     X   +UM(IVRTS(I,MCOMS),IOCCS(I,MCOMS),MCOM)
      AMVEC1(I,MCOM)= UP(IVRTS(I,MCOMS),IOCCS(I,MCOMS),MCOM)
     X   -UM(IVRTS(I,MCOMS),IOCCS(I,MCOMS),MCOM)
   42 CONTINUE
   47 CONTINUE
      IF(NITER.GE.2) THEN
C ....... reduced linear equation solver
      CONV = 1.D-5
      IF(CONVI.NE.0.) CONV = CONVI
C .... KMAX=NITER .....
      DO 91 MCOM=1,MCOMP
      MCOMS=IPRSYM(MCOM+3)
      NVOSYM=NVOS(MCOMS)
C     write(6,*) ' MCOM,MCOMS = ',MCOM,MCOMS
      DO 91 I=1,NVOSYM
      APVEC(I,MCOM)=ZERO
      AMVEC(I,MCOM)=ZERO
      APVEC(I,MCOM) = APVEC1(I,MCOM)/(EVAL(IOCCS(I,MCOMS))
     X    -EVAL(IVRTS(I,MCOMS)))
      AMVEC(I,MCOM) = AMVEC1(I,MCOM)/(EVAL(IOCCS(I,MCOMS))
     X    -EVAL(IVRTS(I,MCOMS)))
C     write(6,*) I,IVRTS(I,MCOMS),IOCCS(I,MCOMS),APVEC(I,MCOM)
C    X ,AMVEC(I,MCOM)
   91 CONTINUE
      CALL TIMER(0) 
      CALL LINEQ0(IVRT,IOCC,IVRTS,IOCCS,OMEGA,MCOMP,3,ABP,ABM
     X ,APVEC,AMVEC,APVEC1,AMVEC1,UPDATE,ASMALL,ASQUARE,ASCALE
C    X ,ICONV,EVAL,EVEC,NUMSCF,NIREP,FP,FM,DENP,DENM,CONV,NVO,KMAX)
     X ,ICONV,EVAL,EVEC,NUMSCF,NIREP,FP,FM,DENP,DENM,CONV,NVO,KMAX
     X ,XX,IX,IA,NINTMX)
      CALL TIMER(1)
C     write(6,*) ' Timing of LINEQ0 for MCOMP = ',MCOMP,TIMENEW
      DO 92 MCOM=1,MCOMP
      MCOMS=IPRSYM(MCOM+3)
      NVOSYM=NVOS(MCOMS)
      DO 92 I=1,NVOSYM
      APVEC(I,MCOM) = APVEC(I,MCOM)/SQRT2
      AMVEC(I,MCOM) = AMVEC(I,MCOM)/SQRT2
   92 CONTINUE
      ELSE
      DO 12 MCOM=1,MCOMP
      MCOMS=IPRSYM(MCOM+3)
      NVOSYM=NVOS(MCOMS)
      NREDUC=NRDS(MCOMS)
C     CALL FINVMX(ABP(NIJS2(MCOMS)+1),ABM(NIJS2(MCOMS)+1),ABPM(NIJS2
C    X(MCOMS)+1),UVAL(NIJS(MCOMS)+1),UVEC(NIJS2(MCOMS)+1),WVAL(NIJS
C    X(MCOMS)+1),WVEC(NIJS2(MCOMS)+1),PORT(NIJS2(MCOMS)+1),SCR,
C    X APVEC(1,MCOM),AMVEC(1,MCOM),APVEC1(1,MCOM),AMVEC1(1,MCOM),OMEGA
C    X ,1,NVOSYM,NREDUC)
      DO 22 I=1,NVOSYM
      APVEC1(I,MCOM)= UP(IVRTS(I,MCOMS),IOCCS(I,MCOMS),MCOM)
      AMVEC1(I,MCOM)= UM(IVRTS(I,MCOMS),IOCCS(I,MCOMS),MCOM)
   22 CONTINUE
      CALL PRPA(SVEC(NIJSR(MCOMS)+1),TVEC(NIJSR(MCOMS)+1),ZVEC(NIJSR
     X (MCOMS)+1),YVEC(NIJSR(MCOMS)+1),REDVEC,WVAL(NIJS(MCOMS)+1),
     X APVEC(1,MCOM),AMVEC(1,MCOM),APVEC1(1,MCOM),AMVEC1(1,MCOM),
     X OMEGA,NVOSYM,NREDUC)
   12 CONTINUE
C  ..... non iterative no owari .............
      END IF
       ELSE
      DO 30 MCOM=1,MCOMP
      DO 11 I=1,NVO
      APVEC(I,MCOM)= ZERO
      AMVEC(I,MCOM)= ZERO
   11 CONTINUE
   30 CONTINUE
      ITER =0
   40 IF(ITER.GE.MAXIT) GO TO 41
      ITER=ITER+1
      IDIF=0
C     CALL MXM(ABP,NSIZVO,ABP(1,NI1),NSIZVO,ABP(1,NI2),MCOMP) 
C     CALL MXM(ABM,NSIZVO,ABM(1,NI1),NSIZVO,ABM(1,NI2),MCOMP) 
      DO 35 MCOM=1,MCOMP
      MCOMS=IPRSYM(MCOM+3)
      NVOSYM=NVOS(MCOMS)
      CALL MXM(ABP(NIJS2(MCOMS)+1),NVOS(MCOMS),APVEC(1,MCOM)
     X ,NVOS(MCOMS),APVEC1(1,MCOM),1)
      CALL MXM(ABM(NIJS2(MCOMS)+1),NVOS(MCOMS),AMVEC(1,MCOM)
     X ,NVOS(MCOMS),AMVEC1(1,MCOM),1)
      ENRGP=ZERO
      ENRGM=ZERO
      DO 36 I=1,NVOSYM
      IVT= IVRTS(I,MCOMS)
      IOC= IOCCS(I,MCOMS)
      VOLDP= APVEC(I,MCOM)
      VOLDM= AMVEC(I,MCOM)
      FTP = (APVEC1(I,MCOM)+AMVEC1(I,MCOM))/SQRT2
      FTM = (APVEC1(I,MCOM)-AMVEC1(I,MCOM))/SQRT2
      VNEWP =(FTP+UP(IVT,IOC,MCOM))/(EVAL(IOC)-EVAL(IVT)-OMEGA)
      VNEWM =(FTM+UM(IVT,IOC,MCOM))/(EVAL(IOC)-EVAL(IVT)+OMEGA)
C ....  VNEWP=X=U(+)(a,i)    VNEWM=Y=-U(+)(i,a)=U(-)(a,i)  :::: tabun!
      APVEC(I,MCOM)= (VNEWP+VNEWM)/SQRT2
      AMVEC(I,MCOM)=(VNEWP-VNEWM)/SQRT2
      APVEC1(I,MCOM)= VOLDP
      AMVEC1(I,MCOM)= VOLDM
      IJ = (IVT-1)*IVT/2 + IOC
C     ENRGP= ENRGP+VNEWP*HMO(IJ,3)
C     ENRGM= ENRGM+VNEWM*HMO(IJ,3)
      DIFP = ABS(APVEC(I,MCOM)-APVEC1(I,MCOM))
      DIFM = ABS(AMVEC(I,MCOM)-AMVEC1(I,MCOM))
      IF(DIFP.GT.TOLPER.OR.DIFM.GT.TOLPER) IDIF=1
   36 CONTINUE
C     ENERG2= (ENRGP+ENRGM)*TWO
C     IF(MCOM.EQ.3)WRITE(6,*) ' energy = ',ENERG2,MCOM,ITER
   35 CONTINUE
      IF(IDIF.EQ.0) GO TO 41
      GO TO 40
   41 CONTINUE
      WRITE(6,*) ' ITERATION = ',ITER
       END IF
      DO 31 MCOM=1,MCOMP     
      MCOMS=IPRSYM(MCOM+3)
      NVOSYM=NVOS(MCOMS)
      DO 15 I=1,NX
      DENP(I)=ZERO
   15 DENM(I)=ZERO
      DO 16 I=1,NVO
      IVT=IVRT(I)
      IOC=IOCC(I)
      UP(IVT,IOC,MCOM)=ZERO
   16 UM(IVT,IOC,MCOM)=ZERO
      WRITE(6,*) ' Solution for the linear equation '
      DO 20 I=1,NVOSYM
      IVT=IVRTS(I,MCOMS)
      IOC=IOCCS(I,MCOMS)
      UP(IVT,IOC,MCOM)=(APVEC(I,MCOM)+AMVEC(I,MCOM))/SQRT2
      UM(IVT,IOC,MCOM)=(APVEC(I,MCOM)-AMVEC(I,MCOM))/SQRT2
      IJD=(IVT-1)*IVT/2+IOC
      DENP(IJD)= APVEC(I,MCOM)*TWO 
      DENM(IJD)= AMVEC(I,MCOM)*TWO
C     write(6,*) I,IVT,IOC,APVEC(I,MCOM),AMVEC(I,MCOM)
   20 CONTINUE
      DO 18 M=1,3
      ENRGS= ZERO
      DO 19 I=1,NVO
      IJD=(IVRT(I)-1)*IVRT(I)/2+IOCC(I)
      ENRGS = ENRGS +
     X (UP(IVRT(I),IOCC(I),MCOM)+UM(IVRT(I),IOCC(I),MCOM))*HMO(IJD,M)
   19 CONTINUE
      ENRGS = ENRGS*TWO
      ENRG(M,MCOM)=ENRG(M,MCOM)+ENRGS
   18 CONTINUE
      WRITE(6,*) ' - Beta '
C     WRITE(6,*) ' component for ',MCOM
C     WRITE(6,*) ' - Beta = ',(ENRG(M,MCOM),M=1,3)
      WRITE(6,200) AXYZ(1),AXYZ(L1(MCOM)),AXYZ(L2(MCOM)),
     X  ENRG(1,MCOM),AXYZ(2),AXYZ(L1(MCOM)),AXYZ(L2(MCOM))
     X ,ENRG(2,MCOM),AXYZ(3),AXYZ(L1(MCOM)),AXYZ(L2(MCOM)),
     X  ENRG(3,MCOM)
  200 FORMAT(1H ,3A1,' = ',F20.7,'  ',3A1,' = ',F20.7,'  ',
     X3A1,' = ',F20.7)
      IF(IOPU.NE.0) THEN
      WRITE(6,*) ' UP '
      CALL OUTMXD(UP(1,1,MCOM),NSIZ1,NUMSCF,NOC)
      WRITE(6,*) ' UM '
      CALL OUTMXD(UM(1,1,MCOM),NSIZ1,NUMSCF,NOC)
      END IF
      IF(IFAMO.EQ.0) THEN
      NIJ= NUMSCF*(NUMSCF+1)/2
      DO 25 IJ=1,NIJ
      FP(IJ)=ZERO
      FM(IJ)=ZERO
   25 CONTINUE
      CALL FMOK(DENP,FP,XX,IX,NINTMX,IA)
      CALL FMOL(DENM,FM,XX,IX,NINTMX,IA)
      ELSE
      CALL DENSP(NBASIS,NVO,IVRT,IOCC,EVEC,APVEC(1,MCOM),DENP)
      CALL DENSM(NBASIS,NVO,IVRT,IOCC,EVEC,AMVEC(1,MCOM),DENM)
      IF(IINDO.EQ.0) THEN
      CALL FNOK(DENP,EVEC,FP,NBASIS,NSIZ1,XX,IX,NINTMX,IA)
      CALL FNOL(DENM,EVEC,FM,NBASIS,NSIZ1,XX,IX,NINTMX,IA)
      ELSE
      CALL FINDO(NBASIS,NVO,IVRT,IOCC,EVEC,DENP,FP)
      CALL FIMDO(NBASIS,NVO,IVRT,IOCC,EVEC,DENM,FM)
      END IF
      END IF
      IJ=0
      DO 27 I=1,NUMSCF
      DO 27 J=1,I
      IJ=IJ+1
      IJL=(J-1)*NUMSCF+I
      IF(IFAMO.EQ.0) IJL=IJ
      IF(I.EQ.J) THEN
      F(I,J,MCOM)=FP(IJL)/SQRT2+F(I,J,MCOM)
      ELSE
      F(I,J,MCOM)=(FP(IJL)+FM(IJL))/SQRT2+F(I,J,MCOM)
      F(J,I,MCOM)=(FP(IJL)-FM(IJL))/SQRT2+F(J,I,MCOM)
      END IF
C     write(6,*) I,J,' F ',FP(IJ),FM(IJ),F(I,J,MCOM),F(J,I,MCOM)
   27 CONTINUE
      IF(IOPFE.NE.0) THEN
      write(6,*) ' F matrix ',MCOM
      CALL OUTMXD(F(1,1,MCOM),NSIZ1,NUMSCF,NUMSCF)
      END IF
      DO 26 I=1,NOC
      DO 26 J=1,NOC
      E(I,J,MCOM)=E(I,J,MCOM)+F(I,J,MCOM)
   26 CONTINUE
      IF(IOPFE.GE.2) THEN
      write(6,*) ' E matrix ',MCOM
      CALL OUTMXD(E(1,1,MCOM),NSIZO,NOC,NOC)
      END IF
   31 CONTINUE
      RETURN
      END
