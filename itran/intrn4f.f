
      SUBROUTINE INTRN4F(EVEC,AOINT,BUF1,RHF,NBASIS,NBAS,NMO,
     &                   NSTART,NEND,ISIZE,IOFFN,NSIZE,ISPIN,
     &                   IREORD)
C
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
      LOGICAL RHF
      CHARACTER*80 FNAME
      INTEGER DIRPRD,DISZAO,DISZMO
C
      DIMENSION EVEC(1),AOINT(1),BUF1(1),BUF2(1),IREORD(1)
      DIMENSION NBAS(8),NMO(8),ISIZE(8),IOFFN(8,2)
      DIMENSION NSTART(8),NEND(8)
C
      COMMON/MACHSP/IINTLN,IFLTLN,IINTFP,IALONE,IBITWD
      COMMON/AOOFST/INDOCC(8,2)   
      COMMON/SYMINF/NDUMMY,NIRREP,IRREPA(255,2),DIRPRD(8,8)
C
      DATA AZERO,ONE/0.D0,1.D0/
C
      IF(.NOT.RHF) CALL GFNAME('HALFT   ',FNAME,ILENGTH)
C
C LOOP OVER ALL IRREPS
C
      IOFF2=1
      IOFF3=1
C
      DO 1000 IRREP1=4,NIRREP
C
       NMO1=NMO(IRREP1)
       NAO1=NBAS(IRREP1)
       NSTART1=NSTART(IRREP1)
       NEND1=NEND(IRREP1)
C
       DO 2000 IRREP2=1,NIRREP
C
        IF(IRREP2.GE.IRREP1) GO TO 2000
C
        IOFF3I=IOFF3
C
        IRREP12=DIRPRD(IRREP1,IRREP2)
C
        NAO2=NBAS(IRREP2)
        NMO2=NMO(IRREP2)
C
        NUMDIS=NMO2*(NEND1-NSTART1+1) 
C
        DISZAO=0
        DO 3000 IRREP3=2,NIRREP
         IF(IRREP3.LT.IRREP1.AND.IRREP3.NE.IRREP2) THEN
          IRREP4=DIRPRD(IRREP12,IRREP3)
          IF(IRREP4.LT.IRREP3) THEN
           DISZAO=DISZAO+NBAS(IRREP3)*NBAS(IRREP4)
          ENDIF
         ENDIF
3000    CONTINUE
C
C LOOP OVER ALL OCCUPIED ORBITALS
C
         IOFFC2=INDOCC(IRREP2,ISPIN)
C
         DO 100 IMO=NSTART1,NEND1
C
C  TRANSFORM SECOND INDEX  (Mu I | SIGMA RHO) --> (P I | SIGMA RHO )
C
          CALL XGEMM('T','N',NMO2,DISZAO,NAO2,ONE,EVEC(IOFFC2),
     &               NAO2,AOINT(IOFF2),NAO2,AZERO,BUF1,NMO2)
C
          CALL TRANSP(BUF1,AOINT(IOFF3),DISZAO,NMO2)
C
          IOFF2=IOFF2+NAO2*DISZAO
          IOFF3=IOFF3+NMO2*DISZAO
C
100      CONTINUE
C
C  NOW WE HAVE THE (PI,SIGMA RHO) INTEGRALS ORDERED AS   X X P I 
C
C  FOR UHF, WRITE INTEGRALS TO DISK SINCE WE WILL USE THEM AGAIN
C
         IF(.NOT.RHF) THEN
C
          OPEN(UNIT=79,FORM='UNFORMATTED',STATUS='UNKNOWN',
     &         ACCESS='SEQUENTIAL',FILE=FNAME(1:ILENGTH))
          REWIND(UNIT=79)
C
          IOFFW=IOFF3I
          DO 101 I=1,NUMDIS
           WRITE(79) (AOINT(IND),IND=IOFFW,IOFFW+DISZAO-1)
           IOFFW=IOFFW+DISZAO
101       CONTINUE
C
          REWIND(UNIT=79)
C
         ENDIF
C
C NOW TRANSFORM NEW LHS TO RS, SPIN CASE ISPIN,ISPIN
C
         IOFF4=IOFF3I
         IOFF5=IOFF3I
C
         DO 200 IDIS=1,NUMDIS
C
          DO 4000 IRREP3=2,NIRREP
           IF(IRREP1.GT.IRREP3.AND.IRREP2.NE.IRREP3) THEN
            IRREP4=DIRPRD(IRREP12,IRREP3)
            IF(IRREP4.LT.IRREP3) THEN
             NAO3=NBAS(IRREP3)
             NAO4=NBAS(IRREP4)
             NMO3=NMO(IRREP3)
             NMO4=NMO(IRREP4)   
C
             IOFFC3=INDOCC(IRREP3,ISPIN)
             IOFFC4=INDOCC(IRREP4,ISPIN)
C
             CALL GHTRAN(AOINT(IOFF4),AOINT(IOFF5),EVEC,IOFFC4,
     &                   IOFFC3,1,1,BUF1,
     &                   0,1,NAO4,NAO3,NMO4,NMO3)
C
             IOFF4=IOFF4+NAO3*NAO4
             IOFF5=IOFF5+NMO3*NMO4
C 
            ENDIF
           ENDIF
4000      CONTINUE
C
200      CONTINUE
C
C DUMP INTEGRALS TO HF2
C
         ILNBUF=600
         IOFF=1+ILNBUF
         CALL DHF24F(AOINT(IOFF3I),BUF1,BUF1(IOFF),ILNBUF,IRREP1,
     &               IRREP2,NSTART1,NEND1,NMO2,NMO,IOFFN(1,ISPIN),
     &               IOFFN(1,ISPIN),IREORD,RHF,ISPIN)
         IF(.NOT.RHF) THEN
          IOFFW=IOFF3I
          DO 1101 I=1,NUMDIS
           READ(79) (AOINT(IND),IND=IOFFW,IOFFW+DISZAO-1)
           IOFFW=IOFFW+DISZAO
1101      CONTINUE
C 
          CLOSE(UNIT=79,STATUS='DELETE')
C
C NOW TRANSFORM NEW LHS TO RS, SPIN CASE ISPIN,ISPIN
C
          IOFF4=IOFF3I
          IOFF5=IOFF3I
C
          DO 1200 IDIS=1,NUMDIS
C
          DO 14000 IRREP3=2,NIRREP
           IF(IRREP1.GT.IRREP3.AND.IRREP2.NE.IRREP3) THEN
            IRREP4=DIRPRD(IRREP12,IRREP3)
            IF(IRREP4.LT.IRREP3) THEN
             NAO3=NBAS(IRREP3)
             NAO4=NBAS(IRREP4)
             NMO3=NMO(IRREP3)
             NMO4=NMO(IRREP4)   
C
             IOFFC3=INDOCC(IRREP3,3-ISPIN)
             IOFFC4=INDOCC(IRREP4,3-ISPIN)
C
             CALL GHTRAN(AOINT(IOFF4),AOINT(IOFF5),EVEC,IOFFC4,
     &                   IOFFC3,1,1,BUF1,
     &                   0,1,NAO4,NAO3,NMO4,NMO3)
C
             IOFF4=IOFF4+NAO3*NAO4
             IOFF5=IOFF5+NMO3*NMO4
C 
            ENDIF
           ENDIF
14000     CONTINUE
C
1200     CONTINUE
C
C
C DUMP INTEGRALS TO HF2
C
         ILNBUF=600
         IOFF=1+ILNBUF
         CALL DHF24F(AOINT(IOFF3I),BUF1,BUF1(IOFF),ILNBUF,IRREP1,
     &               IRREP2,NSTART1,NEND1,NMO2,NMO,IOFFN(1,ISPIN),
     &               IOFFN(1,3-ISPIN),IREORD,RHF,ISPIN+2)
        ENDIF
2000   CONTINUE
1000  CONTINUE
C
      RETURN
      END
