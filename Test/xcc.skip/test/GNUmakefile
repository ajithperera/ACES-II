
# IF YOU DON'T KNOW WHAT THIS WILL DO, RUN `gmake debug` AND LEARN!!!

# The useable goals:
#    all         - (default) compiles source, builds library, links executable
#    debug       - (USE THIS OFTEN) lists the behavior make will take when
#                  treating each and every file
#    install     - ${INSTALL}s the library, binary, and/or *.mod files to the
#                  directories specified by DIR_INST*
#                  NOTE: currbin and currlib are dependcies of install so
#                  `gmake install` will attempt to make the library and
#                  binary if they do not exist. This is in line with the
#                  standard GNU `make install` convention.
#    clean       - removes everything that can be generated by make
#    barelyclean - removes the current executable
#    mostlyclean - removes the current executable and library
#    sortaclean  - removes the current executable, library, and intermediates
#                  (source files from sources with pre-processor directives --
#                  for use when you want to change defines or include files)
#    distclean   - removes all intermediates used to make the library
#                  and binary, i.e., all objects, dependency makefiles,
#                  processed source, and junk
#    backup (*)  - (USE BEFORE `gmake clean`) copies ${SLUDGE} to backup.${DATE}
#    archive (*) - puts source and ./include into ${CURR}.tgz compressed archive
#    (*) these goals have BASIC capabilites and are not for normal use
# And, don't forget the chain rule:
#    `gmake clean all install CLI_VAR="some value"`

# To jump through the file, search for any of the following headers:
#    DEFAULT ENVIRONMENT VARIABLES
#    COMMON MAKEFILE.SRC VARIABLES
#    ADVANCED MAKEFILE.SRC VARIABLES
#    PORTING VARIABLES
#    ACES VARIABLES
#    NOT FOR THE WEAK-KNEED
#    THE TARGETS
#    FLAG FUN
#    PUTTING IT ALL TOGETHER
#    ACTUAL MAKEFILE
#    TODO
#    INDEX OF CONFIGURABLE VARIABLES

BANNER = ACES Makefile for GNU make - Version 4.5.7
TECHSUPPORT = yau@qtp.ufl.edu

# Here is a quick rundown of a standard compile environment for ${CURR}
# and its product files:
#
# Src/
#     bin/
#         x${CURR}
#     include/
#             *.[h,mod]
#     module/
#            *.[F95,F90,f95,f90]
#     lib/
#         libacesmods.a,lib${CURR}.a
#     ${CURR}/
#             include/
#                     *.[h,mod]
#             module/
#                    *.[F95,F90,f95,f90]
#             lib/
#                 lib${CURR}mods.a,libprivatelib.a
#             privatelib/
#                        ...recursive directory structure...
#
# Why do we do this? Well, there are a number of ways to build huge and complex
# programs. One way is to have a different Makefile for every AME and ASL
# (ACES Member Executable and ACES Shared Library) but that would require
# everyone to learn how to write, maintain, and debug Makefiles not to mention
# the work required to add a few subroutines or reorganize a directory
# structure. Abiding by the directory heirarchy means one Makefile can be
# used for all the executables and libraries with minimal customization
# (accomplished via Makefile.src).
# The main problem with this implementation is active porting. Anyone wishing
# to port the code to another machine, architecture or operating system, will
# have to investigate which tools are available for building and archiving.
# If someone had the time and willingness, GNU's autoconf and automake could be
# used to make porting trivial.

#

# NOTES_ON_EDITING

# Edit this file ONLY if you are porting the code to a new computer or
# if you find a bug, which should be reported to ACES technical support;
# otherwise, PLEASE create and edit a Makefile.src file since it will
# override any variable found in the initialization section(s) anyway.

# This Makefile is designed specifically for GNU make and will certainly
# not work (yet) with standard make.

# Referencing variables:
# GNU make allows two forms of variable reference:
#    ${variable} and $(variable).
# Since make doesn't care one way or the other for most of these, we will use
# a convention such that the offset characters have meaning. The convention
# we choose to use is {} for expanded reference and () for stored reference.
# This means: if a variable is to be referenced and its contents are a simple
# string, then call it ${simple_variable}; however, if a variable's contents
# are updated at the moment it is referenced, then call it $(JIT_variable).
# Functions and commands are also offset with parentheses instead of braces.

# Selecting cases for variables:
# GNU make is case sensitive but humans tend not to be; however, if we force
# all variables to be upper or lower case, then we will have many variables
# whose names are derived from other variables like BUILDBIN and INT_BUILDIN
# for the user-defineable variable and the name of its internal variable. So,
# to decrease the amount of programming needed, variables in all caps will
# be reserved for user variables like those found in Makefile.src and those
# specified on the command line and variables in lower case will be for the
# internal Makefile equivalents. The best example of this is BUILDBIN and
# buildbin. If the user sets BUILDBIN on the command line, then the internal
# logic based on it will be completely screwed up since its value will never
# be changed; therefore, we evaluate BUILDBIN once and set buildbin based on
# it.

# END NOTES_ON_EDITING

#

# NOTES_ON_STYLE

# For some reason, a few terminals don't respond well to scrolling
# two consecutive carriage returns; however, a few blank lines are
# more visually appealing than horizontal rules. Therefore, a hash
# should be used to break up such sequences.

# There are many configurable variables, some have default settings and
# some don't. Every now and then, to decrease obfuscation, the default
# value will be listed in brackets following the variable and a hash. E.G.,
# tmp := ${DIR_INSTINC} # [../lib]
# BUT, an anomoly was found in which adding the default value in a comment
# caused the error message "test: syntax error" every time a file was compiled.

# The more programming languages this file needs to support, the more
# complicated the flag parsing becomes. Already we support C++, C, and
# three FORTRANs. If anyone can think of a better way to divide and
# conquer all these possibilities, please, send the suggestions to
# ${TECHSUPPORT}.

# END NOTES_ON_STYLE

#

# Get the machine name or some other appropriate indentifier.
# Beware when `uname -n` returns the entire DNS name. Since a properly
# networked computer can't have periods in its name, we'll select only
# the first word.

uname := $(subst ., , $(shell uname -n))
uname := $(word 1, ${uname})
uname := $(strip ${uname})
MACHNAME := ${uname}

# Glean machine, location, and OS dependent variables. These three variables
# are used for including other Makefiles or conditionals in the porting section.

QTP_SPARC_SUNOS  = crunch scream% sred% swhite% sblue%
QTP_X86_SUNOS    = solx   icream% ired% iwhite% iblue%
QTP_POWER_AIX    = whirl hum brisk swift \
                   kwik \
                   quanta% \
                   xena%
CRAY_UNICOS      = vlsc pk larry osca
NDU_ALPHA_OSF1   = medial
TAMU_SGI_IRIX64  = terminator
RUTGERS_HPUX10   = r2d2 hpcgauss miles
GNU_TOOLS        = crisp ntcrim10 rolex brucat8

tmp =

ifndef tmp
   tmp := $(filter ${QTP_SPARC_SUNOS}, ${MACHNAME})
   ifdef tmp
      LOC    = qtp
      OPSYS  = sunos
      COMPLR = forte
   endif
endif

ifndef tmp
   tmp := $(filter ${QTP_X86_SUNOS}, ${MACHNAME})
   ifdef tmp
      LOC    = qtp
      OPSYS  = sunos
      COMPLR = pg
   endif
endif

ifndef tmp
   tmp := $(filter ${QTP_POWER_AIX}, ${MACHNAME})
   ifdef tmp
      LOC    = qtp
      OPSYS  = aix
      COMPLR = xl
   endif
endif

ifndef tmp
   tmp := $(filter ${CRAY_UNICOS}, ${MACHNAME})
   ifdef tmp
      LOC    = anywhere
      OPSYS  = unicos
      COMPLR = cray
   endif
endif

ifndef tmp
   tmp := $(filter ${NDU_ALPHA_OSF1}, ${MACHNAME})
   ifdef tmp
      LOC    = ndu
      OPSYS  = osf
      COMPLR = digital
   endif
endif

ifndef tmp
   tmp := $(filter ${TAMU_SGI_IRIX64}, ${MACHNAME})
   ifdef tmp
      LOC    = tamu
      OPSYS  = irix
      COMPLR = sgi
   endif
endif

ifndef tmp
   tmp := $(filter ${RUTGERS_HPUX10}, ${MACHNAME})
   ifdef tmp
      LOC    = rutgers
      OPSYS  = hpux
      COMPLR = hp
   endif
endif

ifndef tmp
   tmp := $(filter ${GNU_TOOLS}, ${MACHNAME})
   ifdef tmp
      LOC    = anywhere
      OPSYS  = gnu
      COMPLR = gnu
   endif
endif

#

# build the code only if the machine is recognized

ifndef tmp

.PHONY: all
all: not-configured
.PHONY: install
install: not-configured
.PHONY: clean
clean: not-configured
.PHONY: distclean
distclean: not-configured
.PHONY: mostlyclean
mostlyclean: not-configured
.PHONY: barelyclean
barelyclean: not-configured
.PHONY: sortaclean
sortaclean: not-configured
.PHONY: debug
debug: not-configured
.PHONY: backup
backup: not-configured
.PHONY: FORCE
FORCE: ;

.PHONY: not-configured
not-configured: FORCE
	@echo
	@echo "   ${BANNER}"
	@echo
	@echo "   The ACES GNU Makefile has not been ported to ${MACHNAME}."
	@echo "   Contact technical support at ${TECHSUPPORT}."
	@echo
	@exit 1

else

#

# continue only if GNU make is recent enough

ifndef MAKE_VERSION
   MAKE_VERSION := 0.0
endif
tmp := $(subst ., , ${MAKE_VERSION})
tmp := $(word 2, ${tmp})
ifdef tmp
 # This will have to be changed once 4.x comes out.
   tmp := $(shell if test ${tmp} -ge 79 ; then echo YES ; fi)
endif

ifndef tmp

.PHONY: all
all: old-gmake
.PHONY: install
install: old-gmake
.PHONY: clean
clean: old-gmake
.PHONY: distclean
distclean: old-gmake
.PHONY: mostlyclean
mostlyclean: old-gmake
.PHONY: barelyclean
barelyclean: old-gmake
.PHONY: sortaclean
sortaclean: old-gmake
.PHONY: debug
debug: old-gmake
.PHONY: backup
backup: old-gmake
.PHONY: FORCE
FORCE: ;

.PHONY: old-gmake
old-gmake: FORCE
	@echo
	@echo "   ${BANNER}"
	@echo
	@echo "   The GNU make you are using is too old. This GNUmakefile is"
	@echo "   heavily dependent on syntax from at least version 3.79."
	@echo "   The most recent GNU make can always be downloaded from:"
	@echo "      ftp://ftp.gnu.org/pub/gnu/make"
	@echo
	@exit 1

else

#

###################################
## DEFAULT ENVIRONMENT VARIABLES ##
###################################

SHELL = /bin/sh
TOUCH = touch
ECHO  = echo # used only in the Makefile commands, not in $(shell ...)'s
XARGS = xargs

RM       = rm -f
MV       = mv -f
CP       = cp -p
MKDIR    = mkdir
INSTALL := ${CP} # `gmake install` compares the installed object with the
                 # local one. Moving during install will always consider
                 # the installed object(s) out-of-date.

# Source file extensions
#    There are two main reasons for this feature:
#     1) C++ source can have multiple file extensions and
#     2) FAT16, FAT32, and NTFS are not case sensitive
EXT_cxx = cpp # C++ source (usually cc, C, or cpp)
EXT_c   = c   # C source
EXT_F95 = F95 # FORTRAN 95 source with preprocessor directives
EXT_f95 = f95 # FORTRAN 95 source
EXT_F90 = F90 # FORTRAN 90 source with preprocessor directives
EXT_f90 = f90 # FORTRAN 90 source
EXT_F   = F   # FORTRAN 77 source with preprocessor directives
EXT_f   = f   # FORTRAN 77 source
EXT_d   = d   # dependency makefile rules
EXT_mod = mod # FORTRAN 9X module definitions
EXT_o   = o   # linkable objects

# Source preprocessor
#    Yes, FORTRAN 9x defines (or comes with) a dedicated preprocessor called
#    fpp, but the parsing behavior is almost exactly the same as the one used
#    by cpp; therefore, we choose to use only one for all languages.
CPP            = cpp # [$(CC) -E]
CPPFLAGS       =
CPPFLAGS_EXTRA =
DEFINES        = # command line overrides all other defines
DEFINES_EXTRA  = # command line is added to other defines
CPPFLAG_DEPEND = -M # tells ${CPP} to list file dependencies as a make rule

# C++ compiler
CXX            = CC -c # [g++]
CXXFLAGS       =
CXXFLAGS_EXTRA =

# C compiler
#   Since C++ is a superset of C, we'll use the C++ compiler for both unless
#   the programmer chooses otherwise. Don't set these with ":=" because we
#   want them to reset along with any changes to the C++ variables.
CC           = ${CXX} # [cc]
CFLAGS       = ${CXXFLAGS}
CFLAGS_EXTRA = ${CXXFLAGS_EXTRA}

# FORTRAN 9X compiler
F9XC           = f95 -c
F9XFLAGS       =
F9XFLAGS_EXTRA =
MODDIRS_PREFIX = -M # prepends to ${MODDIRS} when compiling (usually -M or -I)

# FORTRAN 77 compiler
#  o Since FORTRAN 9x is a superset of FORTRAN 77, we'll use the latest
#    compiler for all FORTRAN code unless the programmer chooses otherwise.
#    Don't set these with ":=" because we want them to reset along with any
#    changes to the FORTRAN 9x variables.
#  o In order to pass a flag to one generation and not the other, redefine
#    both sets in Makefile.src, e.g.,
#       F9XFLAGS = -free
#       FFLAGS   =
FC           = ${F9XC} # [f77]
FFLAGS       = ${F9XFLAGS}
FFLAGS_EXTRA = ${F9XFLAGS_EXTRA}

# Archive-maintaining program (without ranlib)
AR         = ar
ARFLAGS    = rv # not used currently
AR_REPLACE = r
AR_EXTRACT = x # only used if the main object comes from the library
LORDER     = lorder

# linker variables
#    ACES makes extensive use of FORTRAN much more than C, so we'll link with
#    the FORTRAN compiler instead. Again, don't use ":=".
LD              = $(filter-out -c, ${F9XC}) # [ld]
LDFLAGS         = ${F9XFLAGS}
LDFLAGS_EXTRA   = ${F9XFLAGS_EXTRA}
LDFLAGS_NUMLIBS = -L/usr/local/lib -llapack -lblas

# tape archiving program
TAR      = tar
TAR_GZIP = -z
TAR_CF   = -c -f
EXT_tgz  = tgz # compressed archive

STRIP = strip

# other common flags and defines
#    Most of these have two parts, a variable assignment and a switch to use it.
#    The switch can take any normally accepted boolean value like 1, TRUE,
#    false, ON, nEgAtIvE, NO, etc.

64BIT = 0
DEFINE_64BIT = -DF_64BIT
# We're in for a world of hurt when we start adding DIR_SRCLIB64 et al.

C_SUFFIX = 0
DEFINE_C_SUFFIX = -DC_SUFFIX # append underscore to C routines

DEBUG = 0
DEFINE_DEBUG = -D_DEBUG -D_ASSERT
FLAG_DEBUG = -g
# also switches DIR_DEBUGLIB on or off

PROFILE = 0
FLAG_PROFILE = -pg
# also switches DIR_PROFLIB on or off

TEST = 0
# switches DIR_TEST* on or off

OPTIMIZE = 1
FLAG_OPTIMIZE = -O
# I'm not sure yet if we should have DIR_OPTLIBs or not.

#

###################################
## COMMON MAKEFILE.SRC VARIABLES ##
###################################

# WARNING ! WARNING ! WARNING ! WARNING ! WARNING ! WARNING ! WARNING
#
# This Makefile was written with a specific file heirarchy in mind, and
# sufficient logic has been incorporated to allow the programmer freedom.
# Straying too far from this standard can confuse GNU make. Consequently,
# choosing to buck the system signifies independence and thus transfers
# the responsibility of debugging to the programmer.

# directory variables
#
# the linking order (with the appropriate flag added) is:
#    DEF [TEST] [DEBUG] [PROF] [SRC] [EXTRA]

# default directories
DIR_DEFLIB = . ./lib     ../lib
DIR_DEFINC =   ./include ../include

# directories with test code
DIR_TESTLIB =
DIR_TESTINC =

# directories with special libraries
DIR_DEBUGLIB =
DIR_PROFLIB  =

# permanent ACES directories for a given machine
DIR_SRCLIB =
DIR_SRCINC =

# extra directories that may contain non-ACES related objects
#    Examples of such directories might be system directories or
#    special routines the programmer may have collected.
DIR_EXTRALIB =
DIR_EXTRAINC =

# `gmake install` will ${INSTALL} each item to the first writeable directory in
# the following path:
#    ${CURRBIN}:                         ${DIR_INSTBIN} ->                  .
#    ${CURRLIB}:       ${DIR_TESTLIB} -> ${DIR_INSTLIB} -> ./lib         -> .
#    *.mod:            ${DIR_TESTINC} -> ${DIR_INSTINC} -> ../../include -> .
#    lib${CURR}mods.a:                   ${DIR_INSTMOD} -> ..            -> .
#    ${CURRTGZ}:                         ${DIR_INSTTGZ}
DIR_INSTBIN = ../bin
DIR_INSTLIB = ../lib
DIR_INSTINC = ../include
DIR_INSTMOD = ../lib
DIR_INSTTGZ = ./

#

# Switches for archiving libraries and compiling binaries.
BUILDLIB = YES # this also affects building modules
BUILDBIN = YES # overridden by BUILDLIB=NO

# The name of the current directory should denote the AME. CURR is the
# most powerful variable here since setting it will determine a huge number
# of other variables (including ones for building modules).
CURR := $(notdir $(shell pwd))
# strip it in the case Makefile.src uses it
CURR := $(strip ${CURR})

# the prefix and suffix to use on ${CURR} for the name of the final library
LIB_PREFIX = lib
LIB_SUFFIX = .a
# CURRLIB = # ${LIB_PREFIX}${CURR}${LIB_SUFFIX}

# the prefix and suffix to use on ${CURR} for the name of the final executable
BIN_PREFIX = x
BIN_SUFFIX =
# CURRBIN = # ${BIN_PREFIX}${CURR}${BIN_SUFFIX}

# the compressed archive file containing the current sources
# CURRTGZ = # [${CURR}.${EXT_tgz}]

# the basename of the object file containing the current binary
# (e.g., geopt for joda)
# MAIN_OBJ = # [main -> ${CURR}]

# a semicolon-delimited list of the libraries to link against
# in order (in the case ${CURR} doesn't show up in ACES_LINK_LISTS)
# LIST_LINKLIBS = # [${CURR}:${LIST_DEF_LIBS}]

#

#####################################
## ADVANCED MAKEFILE.SRC VARIABLES ##
#####################################

# FAST controls whether include dependencies are made. I.E., if fast is
# negative then only the object file time is compared to the source time;
# otherwise, make checks the times of the include files as well.
#    There is a missing feature here. I don't know how to print a list
# of module dependencies for a given FORTRAN 9x routine. That means if a
# .mod file is dated later than a dependent .f95 or .f90 file, make won't
# necessarily recompile.
FAST = 0

# extra stuff to remove in a clean command
JUNK = *~ core

# output redirection
MAKE_OUTPUT  = make.output
MAKE_ERROR   = make.error
#REDIRECT    := 1>> ${MAKE_OUTPUT} 2>> ${MAKE_ERROR}
REDIRECT    := 1> ${MAKE_OUTPUT} 2> ${MAKE_ERROR}

#

#######################
## PORTING VARIABLES ##
#######################

# Most of the time, operating systems take with them certain tools regardless
# of hardware. Therefore, the top-level ifeq should be based on the OS, not the
# architecture (or the location).

# We may want to reconsider our DEFINES for machine dependencies. Following
# the same thinking as the preceding comment, OSes can be ported to any machine
# while retaining the same compile tools and libraries.

ifeq (${LOC}, qtp)
   DIR_SRCINC  = /ufl/qtp/rjb/progs/ACES/include
   DIR_TESTINC =
endif

ifeq (${OPSYS}, sunos) #########################################################
   DEFINES        = -D_SUNOS

   CPP      = /usr/ccs/lib/cpp
   CPPFLAGS = -P -C
   C_SUFFIX       = 1
   AR_REPLACE     = rc
   ifeq (${COMPLR},forte)
      CC = cc -c
      FC = f77 -c
      LD = f77 # could be F9xC AS LONG AS "-lF77 -lmvec" are used
      CXXFLAGS = -dalign -fnonstd
      F9XFLAGS = -dalign -fnonstd -ansi -dbl_align_all=yes
      MODDIRS_PREFIX  = -M
      LDFLAGS  = -Bstatic -xildoff
      # `man fpversion` explains the optimizing flags.
      # Also try `optisa $(isalist)`
    # We need the "-nodepend" flag since some of our loops are so obfuscated
    # that the compiler must do exactly what we say.
      FLAG_OPTIMIZE   = -fast -nodepend #\
                        #-xtarget=ultra2 -xcache=16/32/1:1024/64/1
      DIR_SRCLIB      = /ufl/qtp/rjb/progs/arch/sun4/lib
      LDFLAGS_NUMLIBS = -xlic_lib=sunperf
    # Any member executable that relies on molcas needs to link against
    # the global array library which in turn links against the OS's
    # shared object libraries.
      MOLCAS_ROOT = /camp/crunch_6/qtp/rjb/Aces2trials/Src/molcas
      ifneq (,$(filter ${CURR},vscf squint))
         LDFLAGS = -xildoff
         LDFLAGS_NUMLIBS := -L${MOLCAS_ROOT}/g/lib/SOLARIS -lma \
                            -ldl ${LDFLAGS_NUMLIBS}
      endif
    # This molcas stuff should be removed, but for the time being, since
    # we don't trust their makefile, we'll use ours.
      MOLCAS_STUFF = \
                     util1 util2 util3 \
                     aixio essl \
                     parautil getmem_ma \
                     sewutil molpro scf
      tmp := $(filter ${CURR}, ${MOLCAS_STUFF})
      ifdef tmp
         BUILDLIB=0
         BUILDBIN=0
         DIR_SRCINC := ${MOLCAS_ROOT}/include ${MOLCAS_ROOT}/g/include
         DEFINES_EXTRA := -D_SOLARIS_ -D_HAVE_UNISTD_ -D_BIG_ENDIAN_
         CXXFLAGS := ${CXXFLAGS} -ftrap=common,no%division
         F9XFLAGS := ${F9XFLAGS} -ftrap=common,no%division
         F9XFLAGS_EXTRA := -free -I. $(addprefix -I, ${DIR_SRCINC})
         FFLAGS_EXTRA := -fixed -I. -I./include $(addprefix -I, ${DIR_SRCINC})
      endif
      ifeq (${64BIT},1)
         CXXFLAGS := ${CXXFLAGS} \
                     -xtarget=ultra2 -xarch=v9a
         F9XFLAGS := ${F9XFLAGS} \
                     -xtarget=ultra2 -xarch=v9a \
                     -xtypemap=real:64,double:64,integer:64
         LDFLAGS = -xildoff
      endif
   endif
   ifeq (${COMPLR},pg)
      CXX             = pgCC -c
      CXXFLAGS        = -Mdalign
      CC              = pgcc -c
      F9XC            = pgf90 -c
      F9XFLAGS        = -Mdalign
      FC              = pgf77 -c
      FLAG_OPTIMIZE   = -fast
      DIR_SRCLIB      = #/ufl/qtp/rjb/progs/arch/i86pc/lib
      LDFLAGS_NUMLIBS = -L/usr/local/lib -llapack -lblas
   endif
endif

ifeq (${OPSYS}, aix) ###########################################################
   DEFINES = -D_AIX

   AIX_IS_SCREWED_UP=1

XLC := /usr/vac/bin/xlc
depend_F95 = ${XLC} -P -M ${cppflags} -D__fortran -D__fortran95 -D__fortran9x
depend_F90 = ${XLC} -P -M ${cppflags} -D__fortran -D__fortran90 -D__fortran9x
depend_F   = ${XLC} -P -M ${cppflags} -D__fortran -D__fortran77
depend_cxx = ${XLC} -P -M ${cppflags} -D__cplusplus
depend_c   = ${XLC} -P -M ${cppflags} -D__ansi_c

   CPP            = /usr/ccs/lib/cpp
   CPPFLAGS_EXTRA = -P -C
   CXX            = NOT_YET # waiting on Erik
   CC             = ${XLC} -c
   F9XC           = xlf90 -c
   FC             = xlf -c
   LD             = xlf
   MODDIRS_PREFIX = -I
   AR_REPLACE     = -c -s -r
   AR_EXTRACT     = -x
   LORDER         = ~yau/power2/bin/lorder # a modified shell script

   FLAG_OPTIMIZE = -O3 -qstrict -qmaxmem=-1 -Q -qfloat=hssngl #-qhot # not xlc

 # We used MACHNAME to get us through the initial filter, but maybe that was
 # set on the command line (as in, "I'm being forced to compile for quanta
 # on zap so I'll run `gmake MACHNAME=quanta16`"). Well, this -qcache=auto
 # flag will really screw us up since the compiler won't recognize -qcache=pwr
 # or something similar. Therefore, we'll add it at the end if `uname -n` is
 # equal to MACHNAME.

   DIR_SRCLIB = /ufl/qtp/rjb/progs/arch/power2/lib
   CXXFLAGS   = -qtune=pwr -qarch=pwr # maximum forward compatibility
   F9XFLAGS   = -qtune=pwr -qarch=pwr # maximum forward compatibility

   ARCH_604    = pixi
   ARCH_POWER  = voom flash
   ARCH_POWER2 = brisk hum swift whirl zap kwik \
                 quanta01 quanta02 quanta03 quanta04 \
                 quanta05 quanta06
   ARCH_POWER3 =                   quanta07 quanta08 \
                 quanta09 quanta10 quanta11 quanta12 \
                 quanta13 quanta14 quanta15 quanta16

   ifneq ($(filter ${MACHNAME},${ARCH_604}),)
      DIR_SRCLIB =
      CXXFLAGS   = -qtune=604 -qarch=604
      F9XFLAGS   = -qtune=604 -qarch=604
   endif
   ifneq ($(filter ${MACHNAME},${ARCH_POWER2}),)
      CXXFLAGS   = -qtune=pwr2 -qarch=pwr2
      F9XFLAGS   = -qtune=pwr2 -qarch=pwr2
   endif
   ifneq ($(filter xena%,${MACHNAME}),)
      CXXFLAGS   = -qtune=pwr2 -qarch=pwr2
      F9XFLAGS   = -qtune=pwr2 -qarch=pwr2
   endif
   ifneq ($(filter ${MACHNAME},${ARCH_POWER3}),)
      DIR_SRCLIB = /ufl/qtp/rjb/progs/arch/power3/lib
      CXXFLAGS   = -qtune=pwr3 -qarch=pwr3
      F9XFLAGS   = -qtune=pwr3 -qarch=pwr3
      archive_objects = ${AR} ${AR_REPLACE} ${currlib} *.o
   endif

   ifeq (${uname},${MACHNAME})
      CXXFLAGS  := ${CXXFLAGS} -qcache=auto
      F9XFLAGS  := ${F9XFLAGS} -qcache=auto
   endif

   MEM_1GB = kwik
   MEM_2GB = \
                               quanta07 quanta08 \
             quanta09 quanta10 quanta11 quanta12
   MEM_4GB = quanta13 quanta14 quanta15 quanta16
   #ifneq ($(filter ${MACHNAME},${MEM_1GB}),)
   #   LDFLAGS_EXTRA := ${LDFLAGS_EXTRA} -bmaxdata:0x40000000
   #endif
   #ifneq ($(filter ${MACHNAME},${MEM_2GB}),)
   ifneq ($(filter ${MACHNAME},${ARCH_POWER2}),)
      LDFLAGS_EXTRA := ${LDFLAGS_EXTRA} -bmaxdata:0x7FFFFFFF
   endif
   #ifneq ($(filter ${MACHNAME},${MEM_4GB}),)
   ifneq ($(filter ${MACHNAME},${ARCH_POWER3}),)
      #LDFLAGS_EXTRA := ${LDFLAGS_EXTRA} -bmaxdata:0xFFFFFFFF
      LDFLAGS_EXTRA := ${LDFLAGS_EXTRA} -bmaxdata:0x7FFFFFFF
   endif

   LDFLAGS_NUMLIBS=
   ifneq ($(filter ${MACHNAME},${ARCH_POWER2}),)
      LDFLAGS_NUMLIBS = -L/usr/local/lib -llapackp2 -L/lib -lesslp2
   endif
   ifneq ($(filter ${MACHNAME},${ARCH_POWER3}),)
      LDFLAGS_NUMLIBS = -L/usr/local/lib -llapackp3 -L/lib -lessl
   endif
   ifndef LDFLAGS_NUMLIBS
      LDFLAGS_NUMLIBS = -L/usr/local/lib -llapack   -L/lib -lessl
   endif

 # This is technically a bug. 64BIT is a switch, but we don't evaluate until
 # after including GNUmakefile.src. Therefore, you could build with
 # `gmake 64BIT=YES` and the following would not be included.
   ifeq (${64BIT},1)
      DIR_SRCLIB     = /ufl/qtp/rjb/progs/arch/power3_64b/lib
      CXXFLAGS       = -q64 -qtune=pwr3 -qarch=pwr3
      F9XFLAGS       = -q64 -qtune=pwr3 -qarch=pwr3 -qintsize=8
      LDFLAGS_EXTRA := ${LDFLAGS_EXTRA} -b64
      AR_REPLACE     = -r -c -s -X64
      LORDER         = lorder -X64
      STRIP          = strip -X64
   endif

   REDIRECT := # There is a bug with the redirection under AIX.
endif

ifeq (${OPSYS}, unicos) ########################################################
   DEFINES = -D_UNICOS
   64BIT   = 1 # BEWARE! If you compile your own BLAS, then make sure
               # not to use -D_32BIT_BLAS

   CPP            = cpp
   CPPFLAGS_EXTRA = -C -P
   CC             = cc -c
   F9XC           = f90 -c
   FFLAGS         = -dp -e0
   LD             = f90
   FLAG_OPTIMIZE  = -O scalar2 -O vector2
   AR_REPLACE     = rc
   LDFLAGS_NUMLIBS := -L../../lib -llinpack -llb
endif

ifeq (${OPSYS}, osf) ###########################################################
   DEFINES=-D_OSF -D_RECL_IS_WORDS_ -D_CHAR_IS_ACHAR
   CPP            = cpp
   C_SUFFIX       = 1
   CPPFLAGS_EXTRA = -P -C
   CC             = cc -c
   FC             = f77 -c
   FFLAGS         = -align dcommons -warn noalignments -fpe1 -static
   AR_REPLACE     = rc
   FLAG_OPTIMIZE  = -O4 -tune host
   LD             = f77
   LDFLAGS        = -align dcommons -warn noalignments
   LDFLAGS_NUMLIBS = -L/usr/lib/ -ldxml
endif

ifeq (${OPSYS}, irix) ##########################################################
   DEFINES=-D_IRIX -D_RECL_IS_WORDS_

   CPP            = /usr/lib/cpp
   CPPFLAGS_EXTRA = -P -C
   CC             = cc -c
   FC             = f77 -c
   FFLAGS         = -mips4 -r12000 -static
   AR_REPLACE     = rc
   FLAG_OPTIMIZE  = -O3 -OPT:IEEE_arith=3:round=3 -IPA
   LD             = f77
endif

ifeq (${OPSYS}, hpux) ##########################################################
   DEFINES=-D_HPUX # -D_RECL_IS_WORDS_ # Someone needs to find this out...

   AR_REPLACE    = rc
   FC            = fort77 -c
   FFLAGS        = +apollo -K
   LD            = fort77
   FLAG_OPTIMIZE = +O2
endif

ifeq (${OPSYS}, gnu) ###########################################################
   DEFINES=-D_GNU # This is bad. It should be _SYSV or _BSD

   #CPP = /usr/local/bin/cpp -traditional
   CPP = cpp -traditional
   CPPFLAGS_EXTRA = -P -C # omit hashed comments and pass C-style comments
   CPPFLAG_DEPEND = -MM # do not check system includes
   C_SUFFIX = 1

   CXX = g++ -c
   CC  = gcc -c
   FC  = g77 -c
 # make sure the other compilers f9x, cc, and CC all get double alignment
   CFLAGS  = -malign-double
   FFLAGS  = -malign-double -Wall -fno-second-underscore -finit-local-zero
   LDFLAGS = -malign-double
   AR_REPLACE = rs
   LD  = g77
   FLAG_OPTIMIZE = -O2 -funroll-loops
   #LDFLAGS_NUMLIBS := -lg2c -lm # use if LD=ld
   ifeq (${MACHNAME},crisp)
      LDFLAGS_NUMLIBS := -L/home/aces/lib -llinpack -llb
      FLAG_OPTIMIZE += -march=i686 -pipe
      DEFINES_EXTRA += -D_TRAPFPE
   endif
endif

#

####################
## ACES VARIABLES ##
####################

# the names of all the ACES executables
ACES_BINS = \
   aces2 \
   aces3 \
   anti \
   bcktrn \
   ccsdtq \
   cphf \
   dens \
   dtran \
   findif \
   fsip \
   hfdft \
   intgrt \
   intprc \
   intpack \
   joda \
   lambda \
   mrcc \
   nmr \
   props \
   squint \
   symcor \
   tdhf \
   vcc \
   vcc5q \
   vcc5t \
   vcceh \
   vdint \
   vea \ \
   vee \
   vksdint \
   vmol \
   vmol2ja \
   vprops \
   vscf \
   vtran
# (this string is not used anywhere since every directory is assumed
#  to contain an executable)
ACES_BINS :=

# the names of all the ACES stand-alone libraries
# If ${CURR} is in this string, then BUILDBIN=NO.
ACES_LIBS = \
   tools linpack lapack blas lb \
   acescore libr crust ecp libr2 librt3 trp librv \
   libra3 \
   diagtools symtools omm imm \
   mrcca3 mrcccore apg apg2 cse eomprocs mbdirect mbgrad mbtest mbtools \
   molcas

# lists of library dependencies for compiling AMEs
# (The first element in each sublist is ${CURR}.  The remaining elements are
# libraries the binary needs to be linked against in order.)
ACES_LINK_LISTS = \
   ccsdtq:vcc:trp:librt3:libr2:libr:tools \
   dens:libr2:crust:libr:tools \
   findif:joda:ecp:libr:tools \
   intgrt:libra3 \
   intpack:libra3 \
   joda:ecp:libr:tools \
   lambda:librt3:libr2:libr:tools \
   mrcc:mrcclibs:mrcca3:tools \
   nmr:libr2:libr:tools \
   squint:libr2:libr:tools:molcas:ma \
   tdhf_ks:libra3 \
   vcc:trp:librt3:libr2:crust:libr:tools \
   vcc5q:librt3:vcc:libr2:libr:tools \
   vcc5t:librt3:libr2:libr:tools \
   vcceh:libr2:crust:libr:tools \
   vdint:ecp:libr:tools \
   vea:libr2:libr:tools \
   vee:libr2:crust:libr:tools \
   vksdint:libra3 \
   vmol:ecp:libr:tools \
   vmol2ja:ecp:libr:tools \
   vscf_ks:intgrt:libra3 \
   vscf:libr:tools:molcas:ma \
   xcc:diagtools:symtools:imm:omm:acescore:tools

# default libraries to link against when compiling an unlisted AME
LIST_DEF_LIBS = libr:acescore:tools

# the names of the main objects for each of the "problem" binaries
# [A name may be omitted if the main object has the same name as ${CURR}]
ACES_MAIN_OBJS = \
   dens:vdens \
   dtran:dtran2 \
   fsip:fs \
   intprc:intproc \
   joda:geopt \
   lambda:vlamcc \
   props:prop \
   squint:nsquint \
   tdhf_ks:tdhf \
   vcc5q:t4 \
   vcc5t:nonit3 \
   vea:eaeom \
   vmol:molecu \
   vmol2ja:v2ja \
   vprops:props \
   vscf_ks:vscf

# more-or-less permanent defines that are ACES related that must be used
DEFINES_ACES = -D_DOIT_THE_GWALTNEY_WAY -D_NAMN_THROUGH_CHRTMP

#

############################
## NOT FOR THE WEAK-KNEED ##
############################
##   MAKEFILE.SRC CAN'T   ##
##   SAVE YOU ANYMORE!!   ##
############################

# read in Makefile.src if it exists
makefile_exists := $(shell if test -r GNUmakefile.src ; then echo YES ; fi)
ifeq (${makefile_exists}, YES)
   include GNUmakefile.src
endif
makefile_exists := $(shell if test -r Makefile.src ; then echo YES ; fi)
ifeq (${makefile_exists}, YES)
   include Makefile.src
endif

#

# binary possibilities (we'll use $(upcase) to capitalize the strings)
positive = 1 POSITIVE ON  YES TRUE
negative = 0 NEGATIVE OFF NO  FALSE

# Extra functions with arguments: file, files, dir, dirs

# These settings just prevent the following functions from
# complaining during initialization.
file  = .
files = .
dir   = .
dirs  = .
str   = .

# return the $(files) that exist, null otherwise
files_exist = $(foreach file, $(files), \
   $(shell if test -f $(file) ; then echo $(file) ; fi) )

# return $(dir) if it exists, null otherwise
dir_exists = \
   $(shell if test -d $(dir) ; then echo $(dir) ; fi)

# returns a list of directories from $(dirs) which exist
dirs_exist = \
   $(foreach dir, $(dirs), $(dir_exists))

# return $(dir) if it exists and is writeable
dir_writeable = \
   $(shell if test -d $(dir) ; then if test -w $(dir) ; then echo $(dir) ; \
           fi ; fi)

# return $(dir)/$(file) if it exists, null otherwise
file_exists = \
   $(shell if test -f $(dir)/$(file) ; then echo $(dir)/$(file) ; fi)

# searches the directories $(dirs) for each one that contains $(file) and
# returns the full path.
find_files = \
   $(foreach dir, $(dirs), $(file_exists))

# searches for each file in $(files) in each of the directories $(dirs)
# and returns the full path to the first one found.  Any file not found in
# any of the directories is omitted.
find_first_file = \
   $(foreach file, $(files), $(word 1, $(find_files)))

# return $(str) uppercased/lowercased
lc = abcdefghijklmnopqrstuvwxyz
uc = ABCDEFGHIJKLMNOPQRSTUVWXYZ
upcase   = $(shell echo $(str) | sed -e "y/${lc}/${uc}/")
downcase = $(shell echo $(str) | sed -e "y/${uc}/${lc}/")

#

##############
## SWITCHES ##
##############

# Undefine all negative switches. In the safest environment, we would check
# for both negative and not positive, but since "ifdef C_SUFFIX" is true for
# "C_SUFFIX = a_dead_cat" then we assume people know what they're talking
# about when they write "C_SUFFIX = NO".

str := ${64BIT}
tmp := $(filter $(upcase), ${negative})
ifdef tmp
   64bit =
else
   64bit = 1
endif

str := ${C_SUFFIX}
tmp := $(filter $(upcase), ${negative})
ifdef tmp
   c_suffix =
else
   c_suffix = 1
endif

str := ${DEBUG}
tmp := $(filter $(upcase), ${negative})
ifdef tmp
   debug =
else
   debug = 1
endif

str := ${PROFILE}
tmp := $(filter $(upcase), ${negative})
ifdef tmp
   profile =
else
   profile = 1
endif

str := ${TEST}
tmp := $(filter $(upcase), ${negative})
ifdef tmp
   test =
else
   test = 1
endif

str := ${OPTIMIZE}
tmp := $(filter $(upcase), ${negative})
ifdef tmp
   optimize =
else
   optimize = 1
endif

str := ${FAST}
tmp := $(filter $(upcase), ${negative})
ifdef tmp
   fast =
else
   fast = 1
endif

#

#################
## THE TARGETS ##
#################

# From here on out, the user should have little to no ability to specify
# variables. Every now and then we'll use a conditional define (?=) in case
# the user really knows what they're doing. This is why we use lowercase
# variable names for the equivalent user-specified variable.

curr := $(strip ${CURR})

# the library
#    buildmod is a switch for installing the library and definitions to
#    directories other than DIR_INSTLIB; otherwise, make treats the source
#    exactly like a vanilla library.
buildmod=
str := ${BUILDLIB}
tmp := $(filter $(upcase), ${negative})
ifdef tmp
   buildlib=
   currlib=
   buildbin=0
else
   buildlib=1
   lib_prefix := $(strip ${LIB_PREFIX})
   lib_suffix := $(strip ${LIB_SUFFIX})
   ifeq (${curr}, module)
      # get the name of the parent directory and call the library
      # lib${curr}mods.a or something specified by the user
      tmp      := $(notdir $(dir $(shell pwd)))
      tmp      := $(strip ${tmp})
      CURRLIB  ?= ${lib_prefix}${tmp}mods${lib_suffix}
      buildmod  = 1
      buildbin  = 0
   else
      # See if we're in a directory called "module" in the event CURR
      # is defined.
      tmp := $(notdir $(shell pwd))
      ifeq (${tmp}, module)
         CURRLIB  ?= ${lib_prefix}${curr}mods${lib_suffix}
         buildmod  = 1
         buildbin  = 0
      else
         # If ${curr} is an ACES stand-alone library then there is no binary.
         tmp := $(filter ${curr}, ${ACES_LIBS})
         ACES_LIBS :=
         ifdef tmp
            buildbin = 0
         endif
         CURRLIB ?= ${lib_prefix}${curr}${lib_suffix}
      endif
   endif
   currlib := $(strip ${CURRLIB})
endif

# the binary
ifeq (${buildbin}, 0) # set in the previous section
   buildbin=
else
   str := ${BUILDBIN}
   tmp := $(filter $(upcase), ${negative})
   ifdef tmp
      buildbin=
      currbin=
   else
      buildbin=1
      bin_prefix := $(strip ${BIN_PREFIX})
      bin_suffix := $(strip ${BIN_SUFFIX})
      CURRBIN ?= ${bin_prefix}${curr}${bin_suffix}
      currbin := $(strip ${CURRBIN})
   endif
endif

# the archive
ext_tgz := $(strip ${EXT_tgz})
CURRTGZ ?= ${CURR}.${ext_tgz}
currtgz := $(strip ${CURRTGZ})

#

# the source and its objects

# prepare the extensions
ext_cxx := $(strip ${EXT_cxx})
ext_c   := $(strip ${EXT_c})
ext_F95 := $(strip ${EXT_F95})
ext_f95 := $(strip ${EXT_f95})
ext_F90 := $(strip ${EXT_F90})
ext_f90 := $(strip ${EXT_f90})
ext_F   := $(strip ${EXT_F})
ext_f   := $(strip ${EXT_f})
ext_d   := $(strip ${EXT_d})
ext_mod := $(strip ${EXT_mod})
ext_o   := $(strip ${EXT_o})

F95_F95 := $(wildcard *.${ext_F95})             # all F95 files
F95_d   := $(F95_F95:.${ext_F95}=.${ext_d})     # dependency makefiles
F95_f95 := $(F95_F95:.${ext_F95}=.${ext_f95})   # processed source code
F95_mod := $(F95_F95:.${ext_F95}=.${ext_mod})   # module description files
F95_o   := $(F95_F95:.${ext_F95}=.${ext_o})     # compiled objects

f95_f95 := $(wildcard *.${ext_f95})             # all f95 files
f95_f95 := $(filter-out ${F95_f95}, ${f95_f95}) # parentless f95 files
f95_mod := $(f95_f95:.${ext_f95}=.${ext_mod})   # module description files
f95_o   := $(f95_f95:.${ext_f95}=.${ext_o})     # compiled objects

F90_F90 := $(wildcard *.${ext_F90})             # all F90 files
F90_d   := $(F90_F90:.${ext_F90}=.${ext_d})     # dependency makefiles
F90_f90 := $(F90_F90:.${ext_F90}=.${ext_f90})   # processed source code
F90_mod := $(F90_F90:.${ext_F90}=.${ext_mod})   # module description files
F90_o   := $(F90_F90:.${ext_F90}=.${ext_o})     # compiled objects

f90_f90 := $(wildcard *.${ext_f90})             # all f90 files
f90_f90 := $(filter-out ${F90_f90}, ${f90_f90}) # parentless f90 files
f90_mod := $(f90_f90:.${ext_f90}=.${ext_mod})   # module description files
f90_o   := $(f90_f90:.${ext_f90}=.${ext_o})     # compiled objects

F_F     := $(wildcard *.${ext_F})               # all F files
F_d     := $(F_F:.${ext_F}=.${ext_d})           # dependency makefiles
F_f     := $(F_F:.${ext_F}=.${ext_f})           # processed source code
F_o     := $(F_F:.${ext_F}=.${ext_o})           # compiled objects

f_f     := $(wildcard *.${ext_f})               # all f files
f_f     := $(filter-out ${F_f}, ${f_f})         # parentless f files
f_o     := $(f_f:.${ext_f}=.${ext_o})           # compiled objects

cxx_cxx := $(wildcard *.${ext_cxx})             # all C++ files
cxx_d   := $(cxx_cxx:.${ext_cxx}=.${ext_d})     # dependency makefiles
cxx_o   := $(cxx_cxx:.${ext_cxx}=.${ext_o})     # compiled objects

c_c     := $(wildcard *.${ext_c})               # all C files
c_d     := $(c_c:.${ext_c}=.${ext_d})           # dependency makefiles
c_o     := $(c_c:.${ext_c}=.${ext_o})           # compiled objects

f9x_mod := $(wildcard *.${ext_mod})             # all mod files
mod_o   := $(f9x_mod:.${ext_mod}=.${ext_o})     # compiled module objects

# Throw out the *_d variables if building fast since some environments
# are too small, viz., IRIX and AIX.

ifdef fast
   F95_d :=
   F90_d :=
   F_d   :=
   cxx_d :=
   c_d   :=
endif

# There is a potential hole here. If the programmer has a nested module and
# no ${CURR}/lib directory or ${CURR}/include directory, then all the .mod and
# .o files from the module directory will be installed in ${CURR}. If the
# programmer builds the code in ${CURR}, it will see those .mod and .o files,
# try to archive the .o files in ${CURRLIB}, and install them with the
# library. MAKE SPECIAL NOTE: If you choose to start using modules, then be
# sure to keep track of all the module files, because they will ultimately
# end up everywhere with carelessness.

OBJ ?= ${F95_o} ${F90_o} ${F_o} \
       ${f95_o} ${f90_o} ${f_o} \
       ${cxx_o} ${c_o} ${mod_o}
obj := $(strip ${OBJ})
OBJ :=

#

##############
## FLAG FUN ##
##############

# switch-based flags

strip := ${STRIP} # altered by DEBUG and PROFILE

ifdef 64bit
   define_64bit := ${DEFINE_64BIT}
else
   define_64bit =
endif

ifdef c_suffix
   define_c_suffix := ${DEFINE_C_SUFFIX}
else
   define_c_suffix =
endif

ifdef debug
   define_debug := ${DEFINE_DEBUG}
   flag_debug := ${FLAG_DEBUG}
   dir_debuglib := ${DIR_DEBUGLIB}
   strip := ${TOUCH}
else
   define_debug =
   flag_debug =
   dir_debuglib =
endif

ifdef profile
   flag_profile := ${FLAG_PROFILE}
   dir_proflib := ${DIR_PROFLIB}
   strip := ${TOUCH}
else
   flag_profile =
   dir_proflib =
endif

ifdef test
   dir_testlib := ${DIR_TESTLIB}
   dir_testinc := ${DIR_TESTINC}
else
   dir_testlib =
   dir_testinc =
endif

ifdef optimize
   flag_optimize := ${FLAG_OPTIMIZE}
else
   flag_optimize =
endif

# set preprocessor flags for ${CPP}, ${CXX}, and $(CC)

DEFINES := ${define_64bit} ${define_c_suffix} ${define_debug} \
           ${DEFINES} ${DEFINES_EXTRA} ${DEFINES_ACES} \
           -D__CURR__=\"${CURR}\"
defines := $(strip ${DEFINES})
DEFINES :=

dirs    := ${DIR_DEFINC} ${dir_testinc} ${DIR_SRCINC} ${DIR_EXTRAINC}
INCDIRS ?= $(dirs_exist)
FLAG_INCLUDES ?= $(addprefix -I, ${INCDIRS})
flag_includes := $(strip ${FLAG_INCLUDES})
FLAG_INCLUDES :=

FLAG_PREPROC ?= ${defines} ${flag_includes}
flag_preproc := $(strip ${FLAG_PREPROC})
FLAG_PREPROC :=

# set module include path for FORTRAN 9X

moddirs_prefix := $(strip ${MODDIRS_PREFIX})
ifeq (${moddirs_prefix}, -I)
   # we've already picked up the directories
   FLAG_MODULES ?=
else
   FLAG_MODULES ?= $(addprefix ${moddirs_prefix}, ${INCDIRS})
endif
flag_modules := $(strip ${FLAG_MODULES})
FLAG_MODULES :=

# set compiler optimization flags

FLAG_OPT ?= ${flag_debug} ${flag_profile} ${flag_optimize}
flag_opt := $(strip ${FLAG_OPT})
FLAG_OPT :=

#

# Combine preprocessor, compiler, and linker flags. The line order is very
# important due to dependencies from the beginning of the Makefile.
# Here is the first time $() and ${} can be seen side-by-side in a sensical way.

# Here is another conundrum. If a user runs:
#    gmake CXXFLAGS=-DMY_DEF all
# Should that override all the other defines, includes, and optimization
# flags? According to the GNU make manual, yes. To accomodate both styles,
# we've added *FLAGS_EXTRA so you can add a flag on the command line and
# retain all other flags.

CPPFLAGS :=             ${flag_preproc} ${CPPFLAGS} ${CPPFLAGS_EXTRA}
LDFLAGS  := ${flag_opt}                 $(LDFLAGS)  $(LDFLAGS_EXTRA)
FFLAGS   := ${flag_opt}                 $(FFLAGS)   $(FFLAGS_EXTRA)
F9XFLAGS := ${flag_opt} ${flag_modules} ${F9XFLAGS} ${F9XFLAGS_EXTRA}
CFLAGS   := ${flag_opt} ${flag_preproc} $(CFLAGS)   $(CFLAGS_EXTRA)
CXXFLAGS := ${flag_opt} ${flag_preproc} ${CXXFLAGS} ${CXXFLAGS_EXTRA}

cppflags := $(strip ${CPPFLAGS})
cxxflags := $(strip ${CXXFLAGS})
cflags   := $(strip ${CFLAGS})
f9xflags := $(strip ${F9XFLAGS})
fflags   := $(strip ${FFLAGS})
ldflags  := $(strip ${LDFLAGS})

CPPFLAGS :=
LDFLAGS  :=
FFLAGS   :=
F9XFLAGS :=
CFLAGS   :=
CXXFLAGS :=

#

#############################
## PUTTING IT ALL TOGETHER ##
#############################

# define the methods for building each object
#    I have been tormented by these variables. On the one hand, I could define
#    them like
# ${CPP} ${CPPFLAGS} ${CPPFLAG_DEPEND} $< $@ ${REDIRECT}
#    but then I can't think of an easy way to reuse this line in the debug
#    target since the automatic variables $< and $@ become meaningless.
#    The other option, currently employed, is to define them like so
# ${CPP} ${CPPFLAGS} ${CPPFLAG_DEPEND}
#    This way, it is easy to echo the whole command when running `gmake debug`
#    but a gaping hole exists, viz., more complicated commands like $(LD)
#    have variables that must appear after the object like ${FLAG_LIBS}.
#    Anyone modifying this file must be aware of that and make sure to update
#    both occurances.

process_F95 ?= ${CPP}  ${cppflags} -D__fortran -D__fortran95 -D__fortran9x
process_F90 ?= ${CPP}  ${cppflags} -D__fortran -D__fortran90 -D__fortran9x
process_F   ?= ${CPP}  ${cppflags} -D__fortran -D__fortran77
compile_cxx ?= ${CXX}  ${cxxflags} # -D__cplusplus
compile_c   ?= $(CC)   ${cflags}   -D__ansi_c
compile_f9x ?= ${F9XC} ${f9xflags}
compile_f   ?= $(FC)   ${fflags}

process_F95 := $(strip ${process_F95})
process_F90 := $(strip ${process_F90})
process_F   := $(strip ${process_F})
compile_cxx := $(strip ${compile_cxx})
compile_c   := $(strip ${compile_c})
compile_f9x := $(strip ${compile_f9x})
compile_f   := $(strip ${compile_f})

depend_F95 ?= ${process_F95}                   ${CPPFLAG_DEPEND}
depend_F90 ?= ${process_F90}                   ${CPPFLAG_DEPEND}
depend_F   ?= ${process_F}                     ${CPPFLAG_DEPEND}
depend_cxx ?= ${CPP} ${cppflags} ${CPPFLAG_DEPEND} # -D__cplusplus
depend_c   ?= ${CPP} ${cppflags} -D__ansi_c    ${CPPFLAG_DEPEND}

depend_F95 := $(strip ${depend_F95})
depend_F90 := $(strip ${depend_F90})
depend_F   := $(strip ${depend_F})
depend_cxx := $(strip ${depend_cxx})
depend_c   := $(strip ${depend_c})

#

# build and install the library

ifdef buildlib

   # lorder looks for TMPDIR from the environment
   lorder ?= $(strip ${LORDER})
   TMPDIR ?= /tmp
   dir    := ${TMPDIR}
   tmpdir := $(dir_exists)
   ifndef tmpdir
      tmpdir := $(shell mkdir ${TMPDIR})
   endif

   archive_objects ?= \
      ${AR} ${AR_REPLACE} ${currlib} \
      `${lorder} *.o 2> /dev/null | grep -v "annot open" | tsort`
   strip_library   ?= ${strip} ${currlib}

   # WARNING: If DIR_TESTLIB is defined and TEST is positive, then setting
   # DIR_INSTLIB on the command line will override the default behavior.
   # The crazy logic here is used to preserve the dir_writeable check.
   DIR_INSTLIB := ${dir_testlib} ${DIR_INSTLIB} ./lib
   dirs        := ${DIR_INSTLIB}
   tmp         := $(foreach dir, ${dirs}, $(dir_writeable))
   dir_instlib := $(word 1, ${tmp})
   dir_instlib := $(strip ${dir_instlib})

   ifdef dir_instlib
      install_library ?= ${INSTALL} ${currlib} ${dir_instlib}
   else
      install_library ?= ${ECHO} ${currlib} is installed in ./
   endif

   archive_objects := $(strip ${archive_objects})
   strip_library   := $(strip ${strip_library})
   install_library := $(strip ${install_library})

endif

#

# install the module components
# NOTE: This "feature" has not been fully checked since no one seems to use
# FORTRAN 9x modules.

ifdef buildmod

   DIR_INSTMOD := ${DIR_INSTMOD} ..
   dirs        := ${DIR_INSTMOD}
   tmp         := $(foreach dir, ${dirs}, $(dir_writeable))
   dir_instmod := $(word 1, ${tmp})
   dir_instmod := $(strip ${dir_instmod})

   ifdef dir_instmod
      install_mod_library ?= ${INSTALL} ${currlib} ${dir_instmod}
   else
      install_mod_library ?= ${ECHO} ${currlib} is installed in ./
   endif

   DIR_INSTINC := ${dir_testinc} ${DIR_INSTINC} ../../include
   dirs        := ${DIR_INSTINC}
   tmp         := $(forearch dir, ${dirs}, $(dir_writeable))
   dir_instinc := $(word 1, ${tmp})
   dir_instinc := $(strip ${dir_instinc})

   ifdef dir_instinc
      install_mods ?= \
         ${INSTALL} ${F95_mod} ${f95_mod} ${F90_mod} ${f90_mod} ${dir_instinc}
   else
      install_mods ?= ${ECHO} The mod files are installed in ./
   endif

   install_mod_library := $(strip ${install_mod_library})
   install_mods        := $(strip ${install_mods})

endif

#

# build and install the binary

ifdef buildbin

   # define the main object
   list := $(filter ${curr}:%, ${ACES_MAIN_OBJS}) # joda:geopt
   ACES_MAIN_OBJS :=
   list := $(strip ${list})
   ifndef list
      tmp := $(wildcard main.*)
      ifdef tmp
         list := ${curr}:main                     # vscf:main
      else
         list := ${curr}:${curr}                  # vscf:vscf
      endif
   endif
   list := $(subst :, , ${list})                  # joda geopt
   tmp  := $(word 2, ${list})                     # geopt
   MAIN_OBJ ?= $(addsuffix .o, ${tmp})            # geopt.o
   main_obj := $(strip ${MAIN_OBJ})

   # build the directory search path for linking libraries
   LIBDIRS ?= ${DIR_DEFLIB} \
              ${dir_testlib} \
              ${dir_debuglib} ${dir_proflib} \
              ${DIR_SRCLIB} ${DIR_EXTRALIB}
   dirs    := $(strip ${LIBDIRS})
   libdirs := $(dirs_exist)
   libdirs := $(strip ${libdirs})
   LIBDIRS :=

   # AME dependencies (self-inclusive)
   ifndef LIST_LINKLIBS
      # tag each ${curr} in ${ACES_LINK_LISTS} for easy parsing, e.g.,
      #    joda:ecp:libr        -> xxxxxjoda:exp:libr        # curr  = joda
      #    findif:joda:ecp:libr -> xxxxxfindif:joda:ecp:libr # curr != joda
      X    := xxxxx
      list := $(addprefix ${X}, ${ACES_LINK_LISTS})
      ACES_LINK_LISTS :=
      list := $(filter ${X}${curr}:%, ${list})
      list := $(patsubst ${X}%, %, ${list})
      list := $(strip ${list})
      ifdef list
         LIST_LINKLIBS := ${list}
      else
         LIST_LINKLIBS := ${curr}:${LIST_DEF_LIBS}
      endif
      LIST_LINKLIBS := ${LIST_LINKLIBS}:${curr}mods
   endif
   list_linklibs := $(subst :, , ${LIST_LINKLIBS})
   LIST_LINKLIBS :=
   LINKLIBS      ?= $(strip ${list_linklibs})

   # Now that we have a library search path and some potential libraries
   # to look for, verify each library actually exists.
   dir  = .
   file = .
   verify_exist = \
      $(shell if test -f $(dir)/$(file) ; then echo $(file) ; fi)

   ifndef libdirs
      dirs := .
   else
      dirs := ${libdirs}
   endif
   tmp   := $(addprefix ${lib_prefix}, ${LINKLIBS})
   files := $(addsuffix ${lib_suffix}, ${tmp})

   tmp := $(foreach file, $(files), \
            $(word 1, \
              $(foreach dir, $(dirs), $(verify_exist) \
               ) \
             ) \
           )
   ifneq (${currlib}, $(word 1, ${tmp}))
      tmp := ${currlib} ${tmp} # the current library doesn't exist yet
   endif

   linklibs := $(patsubst lib%.a, %, ${tmp})
   LINKLIBS :=

   # make the library flags for $(LD)
   tmp       := $(addprefix -L, ${libdirs}) $(addprefix -l, ${linklibs})
   FLAG_LIBS ?= ${tmp} ${LDFLAGS_NUMLIBS}
   flag_libs := $(strip ${FLAG_LIBS})
   FLAG_LIBS :=

   extract_main_obj ?= ${AR} ${AR_EXTRACT} ${currlib} ${main_obj}
   link_binary      ?= \
      $(LD) ${ldflags} -o ${currbin} ${main_obj} ${flag_libs}
   strip_binary     ?= ${strip} ${currbin}

   dir         := ${DIR_INSTBIN}
   dir_instbin := $(dir_writeable)
   dir_instbin := $(strip ${dir_instbin})

   ifdef dir_instbin
      install_binary ?= ${INSTALL} ${currbin} ${dir_instbin}
   else
      install_binary ?= ${ECHO} ${currbin} is installed in ./
   endif

   extract_main_obj := $(strip ${extract_main_obj})
   link_binary      := $(strip ${link_binary})
   strip_binary     := $(strip ${strip_binary})
   install_binary   := $(strip ${install_binary})

endif

#

# build/install the archive

dir         := ${DIR_INSTTGZ}
dir_insttgz := $(dir_writeable)
dir_insttgz := $(strip ${dir_insttgz})
ifndef dir_insttgz
   dir_insttgz := .
endif

archive_source := ${TAR} ${TAR_GZIP} ${TAR_CF} \
                  ${dir_insttgz}/${currtgz} \
                  ${F95_F95} ${f95_f95} \
                  ${F90_F90} ${f90_f90} \
                  ${F_F}     ${f_f}     \
                  ${cxx_cxx}            \
                  ${c_c}

dir := ./include
tmp := $(dir_exists)
archive_source := ${archive_source} ${tmp}

ifneq ($(filter archive,${MAKECMDGOALS}),)
   archive_source := $(strip ${archive_source})
else
   archive_source :=
endif

#

#####################
## ACTUAL MAKEFILE ##
#####################

export

.SUFFIXES:
.SUFFIXES: .${ext_cxx} .${ext_c}   \
           .${ext_F95} .${ext_f95} \
           .${ext_F90} .${ext_f90} \
           .${ext_F}   .${ext_f}   \
           .${ext_d}   .${ext_o}  .a

#

.PHONY: all \
        install install_lib install_bin \
        clean tabula_rasa mostlyclean barelyclean distclean sortaclean \
        debug \
        backup \
        FORCE

all: tabula_rasa ${obj} ${currlib} ${currbin}

FORCE: ;

tabula_rasa: FORCE
	@${RM} ${MAKE_OUTPUT}
	@${RM} ${MAKE_ERROR}

########################
# build the object files

${f95_o} : %.${ext_o} : %.${ext_f95}
	@${ECHO} ${CURR}\($<\): compiling at `date +%H:%M:%S`
	@${compile_f9x} $< ${REDIRECT}

${f90_o} : %.${ext_o} : %.${ext_f90}
	@${ECHO} ${CURR}\($<\): compiling at `date +%H:%M:%S`
	@${compile_f9x} $< ${REDIRECT}

${f_o} : %.${ext_o} : %.${ext_f}
	@${ECHO} ${CURR}\($<\): compiling at `date +%H:%M:%S`
	@${compile_f} $< ${REDIRECT}

ifdef fast

   ${F95_o} : %.${ext_o} : %.${ext_f95}
	@${ECHO} ${CURR}\($<\): compiling at `date +%H:%M:%S`
	@${compile_f9x} $< ${REDIRECT}

   ${F90_o} : %.${ext_o} : %.${ext_f90}
	@${ECHO} ${CURR}\($<\): compiling at `date +%H:%M:%S`
	@${compile_f9x} $< ${REDIRECT}

   ${F_o} : %.${ext_o} : %.${ext_f}
	@${ECHO} ${CURR}\($<\): compiling at `date +%H:%M:%S`
	@${compile_f} $< ${REDIRECT}

   ${cxx_o} : %.${ext_o} : %.${ext_cxx}
	@${ECHO} ${CURR}\($<\): compiling at `date +%H:%M:%S`
	@${compile_cxx} $< ${REDIRECT}

   ${c_o} : %.${ext_o} : %.${ext_c}
	@${ECHO} ${CURR}\($<\): compiling at `date +%H:%M:%S`
	@${compile_c} $< ${REDIRECT}

   ${F95_f95} : %.${ext_f95} : %.${ext_F95}
	@${ECHO} ${CURR}\($<\): processing
	@${process_F95} $< $@ ${REDIRECT}

   ${F90_f90} : %.${ext_f90} : %.${ext_F90}
	@${ECHO} ${CURR}\($<\): processing
	@${process_F90} $< $@ ${REDIRECT}

# .INTERMEDIATE : $(addprefix F, ${})

   ${F_f} : %.${ext_f} : %.${ext_F}
	@${ECHO} ${CURR}\($<\): processing
#      ifeq (${OPSYS}, aix)
#	@${process_F} $< ${REDIRECT}
#	@${MV} F$< $<
#      else
	@${process_F} $< $@ ${REDIRECT}
#      endif

else

   ${F95_o} ${F90_o} ${F_o} ${cxx_o} ${c_o} : %.${ext_o} : %.${ext_d}
	@${MAKE} --no-print-directory -s -f $<

   # If you use syntax highlighting, note the apostrophes in prefix and suffix.
   define depend_prefix
      ${SHELL} -ec '
   endef #'
   ifdef AIX_IS_SCREWED_UP
      define depend_F95_suffix
         $< 1> /dev/null; sed "s/$*\.o/$*\.${ext_f95}/" $*.u >> $@; rm $*.[iu]'
      endef #'
      define depend_F90_suffix
         $< 1> /dev/null; sed "s/$*\.o/$*\.${ext_f90}/" $*.u >> $@; rm $*.[iu]'
      endef #'
      define depend_F_suffix
         $< 1> /dev/null; sed "s/$*\.o/$*\.${ext_f}/"   $*.u >> $@; rm $*.[iu]'
      endef #'
      define depend_cxx_suffix
         $< 1> /dev/null; mv $*.u $@; rm $*.i'
      endef #'
      define depend_c_suffix
         $< 1> /dev/null; mv $*.u $@; rm $*.i'
      endef #'
   else
      define depend_F95_suffix
         $< | sed "s/$*\.o/$*\.${ext_f95}/" >> $@'
      endef #'
      define depend_F90_suffix
         $< | sed "s/$*\.o/$*\.${ext_f90}/" >> $@'
      endef #'
      define depend_F_suffix
         $< | sed "s/$*\.o/$*\.${ext_f}/"   >> $@'
      endef #'
      define depend_cxx_suffix
         $< > $@'
      endef #'
      define depend_c_suffix
         $< > $@'
      endef #'
   endif

   ${F95_d} : %.${ext_d} : %.${ext_F95} FORCE
	@${ECHO} ${CURR}\($@\): creating
	+@${ECHO} '$*.o : $*.${ext_f95}' > $@
	+@${ECHO} '	@${ECHO} ${CURR}\($$<\): compiling at `date +%H:%M:%S`'\
	          >> $@
	+@${ECHO} '	@${compile_f95} $$< ${REDIRECT}' >> $@
	+@${ECHO} >> $@
	+@${depend_prefix} ${depend_F95} ${depend_F95_suffix}
	+@${ECHO} '	@${ECHO} ${CURR}\($<\): processing' >> $@
	+@${ECHO} '	@${process_F95} $< $*.${ext_f95} ${REDIRECT}' >> $@

   ${F90_d} : %.${ext_d} : %.${ext_F90} FORCE
	@${ECHO} ${CURR}\($@\): creating
	+@${ECHO} '$*.o : $*.${ext_f90}' > $@
	+@${ECHO} '	@${ECHO} ${CURR}\($$<\): compiling at `date +%H:%M:%S`'\
	          >> $@
	+@${ECHO} '	@${compile_f90} $$< ${REDIRECT}' >> $@
	+@${ECHO} >> $@
	+@${depend_prefix} ${depend_F90} ${depend_F90_suffix}
	+@${ECHO} '	@${ECHO} ${CURR}\($<\): processing' >> $@
	+@${ECHO} '	@${process_F90} $< $*.${ext_f90} ${REDIRECT}' >> $@

   ${F_d} : %.${ext_d} : %.${ext_F} FORCE
	@${ECHO} ${CURR}\($@\): creating
	+@${ECHO} '$*.o : $*.${ext_f}' > $@
	+@${ECHO} '	@${ECHO} ${CURR}\($$<\): compiling at `date +%H:%M:%S`'\
	          >> $@
	+@${ECHO} '	@${compile_f} $$< ${REDIRECT}' >> $@
	+@${ECHO} >> $@
	+@${depend_prefix} ${depend_F} ${depend_F_suffix}
	+@${ECHO} '	@${ECHO} ${CURR}\($<\): processing' >> $@
	+@${ECHO} '	@${process_F} $< $*.${ext_f} ${REDIRECT}' >> $@

   ${cxx_d} : %.${ext_d} : %.${ext_cxx} FORCE
	@${ECHO} ${CURR}\($@\): creating
	+@${depend_prefix} ${depend_cxx} ${depend_cxx_suffix}
	+@${ECHO} '	@${ECHO} ${CURR}\($<\): compiling at `date +%H:%M:%S`' \
	          >> $@
	+@${ECHO} '	@${compile_cxx} $< ${REDIRECT}' >> $@

   ${c_d} : %.${ext_d} : %.${ext_c} FORCE
	@${ECHO} ${CURR}\($@\): creating
	+@${depend_prefix} ${depend_c} ${depend_c_suffix}
	+@${ECHO} '	@${ECHO} ${CURR}\($<\): compiling at `date +%H:%M:%S`' \
	          >> $@
	+@${ECHO} '	@${compile_c} $< ${REDIRECT}' >> $@

endif

##########################################
# build and install the library and binary

install: install_lib install_bin

ifdef buildlib

   parentless_objs := $(filter-out ${obj}, $(wildcard *.o))

   ${currlib}: ${obj}
	@${ECHO}
	@${ECHO} Object files are up-to-date.
      ifdef parentless_objs
	@${ECHO}
	@${ECHO} WARNING: The following source-less object files may \
	                  contaminate the library:
	@${ECHO} "   ${parentless_objs}"
      endif
      ifndef tmpdir
	@${ECHO} \
	   'NOTE: $$TMPDIR does not exist and this may cause lorder to crash.'
      endif
	@${ECHO}
	@${ECHO} Archiving objects
	@${archive_objects} ${REDIRECT}
#	@${ECHO} Stripping library if necessary
#	@${strip_library} ${REDIRECT}

   ifdef buildmod
      install_lib: FORCE
	@${ECHO}
	@${ECHO} Installing the mod files in:
	@${ECHO} "   ${dir_instinc}"
	@${install_mods} ${REDIRECT}
	@${ECHO} Installing the module object library as:
	@${ECHO} "   ${dir_instmod}/${currlib}"
	@${install_mod_library} ${REDIRECT}

   else
      ifdef dir_instlib
         install_lib: ${dir_instlib}/${currlib} FORCE
	@${ECHO}
	@${ECHO} The installed library is up-to-date.

         ${dir_instlib}/${currlib}: ${currlib}
	@${ECHO}
	@${ECHO} Installing the library as:
	@${ECHO} "   ${dir_instlib}/${currlib}"
	@${install_library} ${REDIRECT}
# Some OSes truncate the value of seconds in the time when copying.
# Touching the installed library prevents gmake from gratuitous recopying.
	@${TOUCH} ${dir_instlib}/${currlib}

      else
         install_lib: FORCE
	@${ECHO}
	@${ECHO} Leaving the library as:
	@${ECHO} "   `pwd`/${currlib}"

      endif

   endif

else
   install_lib: FORCE
	@${ECHO}
	@${ECHO} BUILDLIB is negative so the library is not installed.

endif

ifdef buildbin
   ${currbin}: ${currlib}
	@${ECHO}
	@if [ ! -f ${main_obj} ] ; then \
	    ${ECHO} Extracting main object; \
	    ${extract_main_obj} ${REDIRECT}; \
	fi
	@${ECHO} Linking binary
	@${link_binary} ${REDIRECT}
	@${ECHO} Stripping binary if necessary
	@${strip_binary} ${REDIRECT}

   ifdef dir_instbin
      install_bin: ${dir_instbin}/${currbin} FORCE
	@${ECHO}
	@${ECHO} The installed binary is up-to-date.

      ${dir_instbin}/${currbin}: ${currbin}
	@${ECHO}
	@${ECHO} Installing the binary as:
	@${ECHO} "   ${dir_instbin}/${currbin}"
	@${install_binary} ${REDIRECT}
	@${TOUCH} ${dir_instbin}/${currbin}

   else
      install_bin: FORCE
	@${ECHO}
	@${ECHO} Leaving the binary as:
	@${ECHO} "   `pwd`/${currbin}"

   endif

else
   install_bin: FORCE
	@${ECHO}
	@${ECHO} BUILDBIN is negative so the binary is not installed.

endif

##########
# cleaning

clean: tabula_rasa distclean FORCE
   ifneq ($(strip ${F95_mod} ${f95_mod} ${F90_mod} ${f90_mod}),)
	@${ECHO}
	@${ECHO} Removing module files
	@${ECHO} ${F95_mod} ${f95_mod} | ${XARGS} ${RM}
	@${ECHO} ${F90_mod} ${f90_mod} | ${XARGS} ${RM}
   endif
	@${ECHO}
	@${ECHO} Remaining files:
	@/bin/ls -F
	@${ECHO}

distclean: mostlyclean FORCE
	@${ECHO}
	@${ECHO} Removing objects, intermediates, and junk
	@${ECHO} ${F_d} ${F90_d}   ${F95_d}   ${c_d} ${cxx_d} | ${XARGS} ${RM}
	@${ECHO} ${F_f} ${F90_f90} ${F95_f95}                 | ${XARGS} ${RM}
	@${ECHO} ${obj} ${main_obj}                           | ${XARGS} ${RM}
	@${ECHO} ${JUNK}                                      | ${XARGS} ${RM}

sortaclean: mostlyclean FORCE
	@${ECHO}
	@${ECHO} Removing children of files with pre-processing directives
	@${ECHO} ${F_d} ${F90_d}   ${F95_d}   ${c_d} ${cxx_d} | ${XARGS} ${RM}
	@${ECHO} ${F_f} ${F90_f90} ${F95_f95}                 | ${XARGS} ${RM}
	@${ECHO} ${F_o} ${F90_o}   ${F95_o}   ${c_o} ${cxx_o} | ${XARGS} ${RM}

mostlyclean: barelyclean FORCE
   ifdef currlib
	@${ECHO}
	@${ECHO} Removing ${currlib}
	@${RM} ${currlib}
   endif

barelyclean: FORCE
   ifdef currbin
	@${ECHO}
	@${ECHO} Removing ${currbin}
	@${RM} ${currbin}
   endif

#########
# archive

archive: FORCE
	@${ECHO}
	@if [ -f ${dir_insttgz}/${currtgz} ] ; then \
	    ${ECHO} Removing old archive ; \
	    ${RM} ${dir_insttgz}/${currtgz} ; \
	 fi
	@${ECHO} Archiving source files
	@${archive_source}

########
# backup

DATE ?= $(shell date +%m%d)
date := $(strip ${DATE})
BACKUPDIR ?= backup.${date}
backupdir := $(strip ${BACKUPDIR})

backup: FORCE
	@${ECHO}
	@if [ ! -d ${backupdir} ] ; then \
	    ${ECHO} Attempting to ${MKDIR} ${backupdir} ; \
	    ${MKDIR} ${backupdir} ; \
	 else \
	    ${ECHO} ${backupdir} already exists ; \
	 fi
	@${ECHO} Backing-up sludge
#	@${CP} ${sludge} ${backupdir}
#begin AIX cheat
	@${CP} ${currlib} ${currbin} ${main_obj} \
	       ${obj} \
	       ${F_d} ${F90_d}   ${F95_d}   ${c_d} ${cxx_d} \
	       ${F_f} ${F90_f90} ${F95_f95} \
	       ${F95_mod} ${f95_mod} \
	       ${F90_mod} ${f90_mod} ${backupdir}
#end AIX cheat
	@${ECHO}

#######
# debug

debug: FORCE
	@${ECHO} "   ${BANNER}"
	@${ECHO}
	@${ECHO} "   If you are having MAJOR problems, please contact"
	@${ECHO} "   ACES technical support at ${TECHSUPPORT}."
	@${ECHO} "***************************************************"
	@${ECHO}
	@${ECHO} "   HARDWARE:"
	@${ECHO}
	@${ECHO} "location       : ${LOC}"
	@${ECHO} "OS             : ${OPSYS}"
	@${ECHO} "compiler       : ${COMPLR}"
	@${ECHO} "effective name : ${MACHNAME}"
   ifneq (${MACHNAME},$(word 1, ${uname}))
	@${ECHO} "(real name     : $(word 1, ${uname}))"
   endif
   ifdef 64bit
	@${ECHO} "integer spec   : 64 bits"
   else
	@${ECHO} "integer spec   : 32 bits"
   endif
#   ifeq (${OPSYS}, aix)
#	@${ECHO} "cache spec   : ${CACHE}"
#   endif
	@${ECHO}
	@${ECHO} "   SWITCH STATES:"
	@${ECHO}
	@${ECHO} DEBUG=${DEBUG}, PROFILE=${PROFILE}, OPTIMIZE=${OPTIMIZE}, \
	         FAST=${FAST}, TEST=${TEST}, 64BIT=${64BIT}
	@${ECHO}
	@${ECHO} "   COMPILING SOURCE CODE:"
	@${ECHO}
	@${ECHO} "${compile_cxx} %.${ext_cxx} %.${ext_o}"
	@${ECHO}
	@${ECHO} "${compile_c} %.${ext_c} %.${ext_o}"
	@${ECHO}
	@${ECHO} "${process_F95} %.${ext_F95} %.${ext_f95}"
	@${ECHO}
	@${ECHO} "${compile_f9x} %.${ext_f95} %.${ext_o}"
	@${ECHO}
	@${ECHO} "${process_F90} %.${ext_F90} %.${ext_f90}"
	@${ECHO}
	@${ECHO} "${compile_f9x} %.${ext_f90} %.${ext_o}"
	@${ECHO}
	@${ECHO} "${process_F} %.${ext_F} %.${ext_f}"
	@${ECHO}
	@${ECHO} "${compile_f} %.${ext_f} %.${ext_o}"
	@${ECHO}
   ifdef buildmod
	@${ECHO} "   MODULES:"
	@${ECHO}
	@${ECHO} ${install_mods}
	@${ECHO}
	@${ECHO} ${install_mod_library}
	@${ECHO}
   endif
   ifdef buildlib
	@${ECHO} "   THE LIBRARY:"
	@${ECHO}
	@${ECHO} '${archive_objects}'
	@${ECHO}
	@${ECHO} \`gmake install\` will:
	@${ECHO} ${install_library}
	@${ECHO}
   endif
   ifdef buildbin
	@${ECHO} "   THE BINARY:"
	@${ECHO}
	@${ECHO} ${extract_main_obj}
	@${ECHO}
	@${ECHO} ${link_binary}
	@${ECHO}
	@${ECHO} ${strip_binary}
	@${ECHO}
	@${ECHO} \`gmake install\` will:
	@${ECHO} ${install_binary}
	@${ECHO}
   endif

#ifndef tmp <- closes the "if GNU make is recent" conditional
endif

#ifndef tmp <- closes the "if machine is recognized" conditional
endif

#

##########
## TODO ##
##########

# Create installdirs goal.

# Have object directories for debugged, profiled, optimized, and plain
# objects for immediate testing of source.

# Add module dependencies for FAST=0 and FORTRAN 9x source.

# Create curr(some.o) rules so objects can be deleted.

#

#####################################
## INDEX OF CONFIGURABLE VARIABLES ##
#####################################

# Machine dependent variables
#    MACHNAME - the hostname (e.g., "crunch") used as a handle for setting
#               LOC, MACH, and OPSYS.
#    LOC   } These variables are primarily used in the porting section
#    MACH  } for setting various flags, directories, and commands unique to
#    OPSYS } each environment. If MACH is undefined then make does nothing.

# Basic UNIX commands
#    SHELL, TOUCH, ECHO
#    RM, MV, CP, MKDIR, INSTALL

# Common file extensions
#    EXT_cxx, EXT_c,
#    EXT_F95, EXT_f95, EXT_F90, EXT_f90, EXT_F, EXT_f,
#    EXT_d, EXT_mod, EXT_o
#    EXT_tgz

# Automatic variable controls
#    CPP, CXX, and LD have at least the following variables
#       $*            - the compiler or linker
#       $*FLAGS       - overrides all other flags (except "-c" and NUMLIBS)
#                       if set on the command line
#       $*FLAGS_EXTRA - added to the $*FLAGS
#
#    special variables for the preceding commands
#       DEFINES         - overrides all other defines if set on the CL
#       DEFINES_EXTRA   - added to ${DEFINES}
#       CPPFLAG_DEPEND  - passed to CPP for listing include dependencies
#       LDFLAGS_NUMLIBS - lists -L and -l for numerical libraries
#
#    C, F9X, and F have at least the following variables
#       $*C           - the compiler command
#       $*FLAGS       - overrides all other flags (save "-c") if set on the CL
#       $*FLAGS_EXTRA - added to $*FLAGS
#
#    special variables for the preceding commands
#       MODDIRS_PREFIX - prepends to ${INCDIRS} when compiling F9X
#
#    the object archiver
#       AR         - the archiver command
#       ARFLAGS    - not used explicitly
#       AR_REPLACE - flag for replacing objects in a library
#       AR_EXTRACT - flag for extracting objects from a library
#
#    the tape archiver
#       TAR      - the archiver command
#       TAR_GZIP - flag to pass tar stream through a compressor
#       TAR_CF   - flags for creating a tar file

# Switching behavior
#
#    STRIP - runs on CURRLIB and CURRBIN regardless of compiler commands, but
#            automatically turns to ${TOUCH} if debugging or profiling.
#
#    C_SUFFIX:
#       DEFINE_C_SUFFIX - adds -DC_SUFFIX to CPPFLAGS
#
#    DEBUG:
#       DEFINE_DEBUG - adds -D_DEBUG to CPPFLAGS
#       FLAG_DEBUG   - added to the compilers' and linker's flags
#       DIR_DEBUGLIB - added in library search path
#       DIR_PROFLIB  - added in library search path
#
#    PROFILE:
#       FLAG_PROFILE - added to the compilers' and linker's flags
#
#    TEST:
#       DIR_TESTLIB - added in library search path
#       DIR_TESTINC - added in library search path
#
#    OPTIMIZE:
#       FLAG_OPTIMIZE - added to the compilers' and linker's flags
#
#    FAST:
#       - doesn't check for updated include files
#
#    BUILDLIB:
#       LIB_PREFIX - prepends to ${CURR}
#       LIB_SUFFIX - appends to ${CURR}
#       CURRLIB    - final name of the library
#
#    BUILDBIN:
#       BIN_PREFIX - prepends to ${CURR}
#       BIN_SUFFIX - appends to ${CURR}
#       CURRBIN    - final name of the binary
#       LIST_LINKLIBS - colon-delimited list of library kernels for linking

# Common directories
#
#    DEF, SRC, and EXTRA have two directories named from them
#       DIR_$*LIB - added to library search path
#       DIR_$*INC - added to include search path
#
#    BIN, LIB, INC, MOD, and TGZ all have the following
#       DIR_INST$* - directory for installing targets to

# CURR := $(notdir $(shell pwd))

# Extra
#    JUNK        - extra files or file patterns to remove when making clean
#    MAKE_OUTPUT - the output redirection file
#    MAKE_ERROR  - the error redirection file
#    REDIRECT    - the redirection command

# The remaining variables are all conditionally set with "?=" in the file

# INCDIRS       - overrides include directories
# FLAG_INCLUDES - overrides include flags
# FLAG_PREPROC  - overrides define and include flags
# FLAG_MODULES  - overrides module flags
# FLAG_OPT      - overrides -g, -pg, and -O set by the switches

# MAIN_OBJ - overrides ${CURR}.o
# OBJ      - overrides objects to build and archive

# LIBDIRS   - overrides library search path
# LINKLIBS  - overrides libraries to link against
# FLAG_LIBS - overrides all -L and -l linker flags

# SLUDGE - overrides files to remove when making "clean"

# DATE - the extension to "backup." when backing-up ${SLUDGE}
# BACKUPDIR - overrides backup.${DATE} as the backup directory

# Advanced functions - read the file for usage
#    make_depend
#    process_F95
#    process_F90
#    process_F
#    compile_cxx
#    compile_c
#    compile_f9x
#    compile_f
#    archive_objects
#    strip_library
#    install_library
#    install_mod_library
#    install_mods
#    extract_main_obj
#    link_binary
#    strip_binary
#    install_binary

