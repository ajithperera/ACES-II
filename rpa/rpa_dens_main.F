      SUBROUTINE RPA_DENS_MAIN(IRREPX,ZVEC,NDIM,SCR,MAXCOR,IUHF)
C
C DRIVE THE CALCULATION OF EXCITED STATE RPA/TDA DENSITY MATRICES
C
CEND
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      DIMENSION SCR(MAXCOR), ZVEC(NDIM)
      COMMON/SYMPOP/IRPDPD(8,22),ISYTYP(2,500),ID(18)
#include "machsp.com"
#include "sym.com"
#include "syminf.com"
C
C READ SINGLE EXCITATION VECTORS

      CALL UPDMOI(8,NFMI(1),8,91,0,0)
      CALL UPDMOI(8,NFMI(2),9,91,0,0)
      CALL UPDMOI(8,NFEA(1),8,92,0,0)
      CALL UPDMOI(8,NFEA(2),9,92,0,0)

      IOFF = 1
      DO 10 ISPIN=1,1+IUHF

       LEN=IRPDPD(IRREPX,8+ISPIN)
       IRREPD=1
       IDOO=1
       IDVV=IDOO+IRPDPD(IRREPD,20+ISPIN)
       IVEC=IDVV+IRPDPD(IRREPD,18+ISPIN)
CYCP-b
       IDOO2=IVEC
       IDVV2=IDOO2+IRPDPD(IRREPD,20+ISPIN)
       ICMO =IDVV2+IRPDPD(IRREPD,18+ISPIN)
       CALL GETREC(20, 'JOBARC', 'NBASTOT ', 1, NBAS)
       ICMO2=ICMO+NBAS*NBAS*IINTFP
       IVEC =ICMO2+NBAS*NBAS*IINTFP
CYCP-e
       ITOP=IVEC+LEN
       IF (ITOP .GT. MAXCOR) CALL INSMEM("@-RPA_DENS_MAIN",ITOP,
     &                                    MAXCOR)
       CALL ZERO(SCR,ITOP)

       IOFF = IOFF + (ISPIN-1)*IRPDPD(IRREPX,9)
C
C CALCULATE DENSITY MATRIX CONTRIBUTIONS      
C
       CALL CALC_RPA_DENS(ZVEC(IOFF),SCR(IDOO),SCR(IDVV),IRREPX,
     &                    ISPIN,IUHF)
C
C GET NATURAL TRANSITION ORBITALS (NTO)
C
       CALL GET_NTO(SCR(IDOO),SCR(IDVV),SCR(IDOO2),SCR(IDVV2),
     &      SCR(ICMO),SCR(ICMO2),IRREPX,ISPIN,IUHF)
10    CONTINUE
C
      IONE=1
      CALL PUTREC(20,'JOBARC','IOPTSYM ',IONE,IRREPX)
C
      RETURN
      END
