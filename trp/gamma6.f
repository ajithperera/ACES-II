      SUBROUTINE GAMMA6(ICORE,MAXCOR,IUHF)
C
C
C  THIS ROUTINE COMPUTES THE GAMMA INTERMEDIATE 6
C
C  GAMMA 6 IS ONLY REQUIRED FOR FOURTH ORDER MBPT AND    
C  ALL CC METHODS WHICH INVOLVE SINGLES
C
C MBPT(4) :
C
C  G(IJ,KA) = - SUM E T(K,E) T(IJ,EA)
C
C QCISD :
C
C  G(IJ,KA) = - 1/2 SUM E T(K,E) L(IJ,EA) - 1/2 SUM E L(K,E) T(IJ,EA)
C
C CCSD :
C
C  G(IJ,KA) = - 1/2 SUM E T(K,E) L(IJ,EA) - 1/2 SUM E L(K,E) TAU(IJ,EA)
C
C             + 1/2 SUM M V(IJ,KM) T(M,A)
C
C             + 1/2 P(IJ) H(KF,IA) T(J,F)
C
C             - 1/2 P(IJ) G(IK) T(J,A)
C
C  NOTE THAT ACTUALLY THE NEGATIVE OF H(KF,IA) IS STORED ON DISK.
C
C  THE FOLLOWING SPIN CASES HAVE TO BE CONSIDERED
C
C  AAAA    AA    AAAA    (UHF ONLY)
C  BBBB    BB    BBBB    (UHF ONLY)
C  ABBA    BB    BAAB    (UHF ONLY) STORED WITH NEGATIVE SIGN)
C  ABAB    AA    ABAB
C
C  THIS ROUTINE USES EXPLICITELY SYMMETRY
C
CEND
C
C  CODED AUGUST/90   JG
C
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
      INTEGER DIRPRD,DISSYT,DISSYG,DISSYH,DISSYH1,DISSYH2,POP,VRT
      LOGICAL LAMBDA,MBPT4,TAU
      LOGICAL DENS,GRAD,QRHF,NONHF,ROHF,SEMI,CANON,TRIP1,TRIP2
      LOGICAL MBPT2,MBPT3,M4DQ,M4SDQ,M4SDTQ,CCD,QCISD,CCSD,UCC
      DIMENSION ICORE(MAXCOR)
      COMMON/MACHSP/ IINTLN,IFLTLN,IINTFP,IALONE,IBITWD
      COMMON/METH/ MBPT2,MBPT3,M4DQ,M4SDQ,M4SDTQ,CCD,QCISD,CCSD,UCC
CJ      COMMON/DERIV/DENS,GRAD,QRHF,NONHF,ROHF,SEMI,CANON,TRIP1,
CJ     &             TRIP2
      COMMON/SYMINF/NSTART,NIRREP,IRREPA(255,2),DIRPRD(8,8)
      COMMON/SYMPOP/IRPDPD(8,22),ISYTYP(2,500),NTOT(18)
      COMMON/SYM/POP(8,2),VRT(8,2),NTAA,NTBB,NF1(2),NF2(2)
C
      COMMON /LISWI/  LWIC11,LWIC12,LWIC13,LWIC14,
     1                LWIC15,LWIC16,LWIC17,LWIC18,
     1                LWIC21,LWIC22,LWIC23,LWIC24,
     1                LWIC25,LWIC26,LWIC27,LWIC28,
     1                LWIC31,LWIC32,LWIC33,
     1                LWIC34,LWIC35,LWIC36,
     1                LWIC37,LWIC38,LWIC39,LWIC40,LWIC41,LWIC42
C
      DATA ONE,ONEM,HALF,HALFM /1.0D0,-1.D0,0.5D0,-0.5D0/
C
      MXCOR=MAXCOR
CJ      LAMBDA=CCSD.OR.QCISD
CJ      TAU=CCSD
CJ      MBPT4=M4SDQ.OR.M4SDTQ
      LAMBDA = .FALSE.
      TAU    = .FALSE.
      TRIP1  = .TRUE.
C
C  ALLOCATE FIRST MEMORY FOR T1-AMPLITUDES
C
      I0T1A=MXCOR+1-NTAA*IINTFP
      MXCOR=MXCOR-NTAA*IINTFP
      CALL GETLST(ICORE(I0T1A),1,1,1,1,90)  
CJ      IF(LAMBDA) THEN
CJ       I0T2A=I0T1A-NTAA*IINTFP
CJ       MXCOR=MXCOR-NTAA*IINTFP
CJ       CALL GETLST(ICORE(I0T2A),1,1,2,1,190)
CJ      ELSE
       I0T2A=I0T1A
CJ      ENDIF
      IF(IUHF.EQ.0) THEN
       I0T1B=I0T1A
       I0T2B=I0T2A 
      ELSE
       I0T1B=I0T2A-NTBB*IINTFP
       MXCOR=MXCOR-NTBB*IINTFP
       CALL GETLST(ICORE(I0T1B),1,1,1,2,90)
CJ       IF(LAMBDA) THEN
CJ        I0T2B=I0T1B-NTBB*IINTFP
CJ        MXCOR=MXCOR-NTBB*IINTFP
CJ        CALL GETLST(ICORE(I0T2B),1,1,2,2,190)
CJ       ELSE
        I0T2B=I0T1B
CJ       ENDIF
      ENDIF
C
C  NOW PERFORM MULTIPLICATION
C
      DO 1000 ISPIN=1,IUHF+1
C
      IF(ISPIN.EQ.1) THEN
       IOFFT=I0T2A
       I0T1=I0T1A
       I0T2=I0T1B
       NT=NTAA
      ELSE
       IOFFT=I0T2B
       I0T1=I0T1B
       I0T2=I0T1A
       NT=NTBB
      ENDIF
      IF(IUHF.EQ.1) THEN
C
C  FIST PERFORM AAAA MULTIPLICATION
C
C  NOTE THAT THE ACTUAl SIGN MUST HERE THE NEGATIVE OF THE
C  SIGN GIVEN ABOVE BECAUSE WE ARE SWITCHING INDICES
C
CJ      LISTG=106+ISPIN
      IF(ISPIN.EQ.1)THEN
       LISTG = LWIC21
      ELSE
       LISTG = LWIC22
      ENDIF
CJ      IF(MBPT4) THEN
CJ       LISTT=43+ISPIN
      LISTT = 13 + ISPIN
       FACT=ONEM
CJ      ELSE IF(LAMBDA) THEN
CJ       LISTT=43+ISPIN
CJ       LISTL=143+ISPIN
CJ       FACT=HALF
CJ      ENDIF
CJ      IF(CCSD) THEN
CJ       LISTH=53+ISPIN
CJ       LISTG1=161+ISPIN
CJ       FACTH=HALFM  
CJ      ENDIF
C
      DO 100 IRREP=1,NIRREP
C
       NOCCSQ=0
       NVRTSQ=0
       DO 101 IRREPJ=1,NIRREP
        IRREPI=DIRPRD(IRREP,IRREPJ)
        NVRTSQ=NVRTSQ+VRT(IRREPJ,ISPIN)*VRT(IRREPI,ISPIN)
        NOCCSQ=NOCCSQ+POP(IRREPJ,ISPIN)*POP(IRREPI,ISPIN)
101    CONTINUE
       DISSYT=IRPDPD(IRREP,ISYTYP(1,LISTT))
       NUMSYT=IRPDPD(IRREP,ISYTYP(2,LISTT))
       DISSYG=IRPDPD(IRREP,ISYTYP(1,LISTG))
       NUMSYG=IRPDPD(IRREP,ISYTYP(2,LISTG))
C
C  FOR CCSD CALCULATE FIRST THE CONTRBUTION OF H4 TO GAMMA6
C
CJ       IF(CCSD) THEN
CJ        DISSYH=IRPDPD(IRREP,ISYTYP(1,LISTH))
CJ        NUMSYH=IRPDPD(IRREP,ISYTYP(2,LISTH))
CJ        I001=1
CJ        I002=I001+IINTFP*MAX(NUMSYH*DISSYH,DISSYG*NUMSYG)
CJ        I003=I002+IINTFP*MAX(NUMSYH*DISSYH,NOCCSQ*NUMSYG)
CJ        I004=I003+3*IINTFP*MAX(NUMSYG,DISSYG,NUMSYH,DISSYH)
CJ        IF(I004.LT.MXCOR) THEN
CJ         CALL H4G6AA(ICORE(I001),ICORE(I002),ICORE(I002),
CJ     &               ICORE(I001),ICORE(I0T1),FACTH,DISSYH,
CJ     &               DISSYG,NUMSYH,NUMSYG,NOCCSQ,POP(1,ISPIN),
CJ     &               VRT(1,ISPIN),LISTH,LISTG,IRREP,ICORE(I003),
CJ     &               TRIP1,LISTG1)
CJ        ELSE
CJ         CALL INSMEM('H4G6AA',I004,MXCOR)
CJ        ENDIF
CJ       ENDIF
C 
       I001=1
       I002=I001+IINTFP*MAX(NVRTSQ*NUMSYT,NUMSYT*NOCCSQ,NF1(ISPIN))
       I003=I002+IINTFP*NUMSYT*DISSYT
       I004=I003+IINTFP*NUMSYG*DISSYG
       IF(MIN(NUMSYT,NUMSYG,DISSYG).NE.0) THEN
        I005=I004+3*IINTFP*MAX(NUMSYG,DISSYG,NUMSYT,DISSYT)
        IF(MXCOR.GT.I005) THEN
         CALL G6AA(ICORE(I001),ICORE(I002),ICORE(I003),
     &             ICORE(IOFFT),ICORE(I0T1),ICORE(I001),FACT,
     &             LAMBDA,TAU,TRIP1,ISPIN,POP(1,ISPIN),
     &             VRT(1,ISPIN),NT,DISSYT,NUMSYT,DISSYG,NUMSYG,
     &             LISTT,LISTL,LISTG,IRREP,ICORE(I004))
        ELSE
         CALL INSMEM('G6AA',I005,MXCOR)
        ENDIF
       ENDIF
100   CONTINUE
      ENDIF
C
C  AB SPIN CASE
C
CJ      LISTG=111-ISPIN
      IF(ISPIN.EQ.1)THEN
       LISTG = LWIC24
      ELSE
       LISTG = LWIC23
      ENDIF
CJ      IF(MBPT4) THEN
CJ       LISTT=46
      LISTT = 16
       FACT=ONE
CJ      ELSE IF(LAMBDA) THEN
CJ       LISTT=46
CJ       LISTL=146 
CJ       FACT=HALFM
CJ      ENDIF
CJ      IF(CCSD) THEN
CJ       LISTH1=55+ISPIN
CJ       LISTH2=59-ISPIN+IUHF
CJ       LISTG1=165-ISPIN  
CJ       FACTH=HALFM
CJ      ENDIF
C
C  LOOP OVER IRREPS
C
      DO 200 IRREP=1,NIRREP
C
       DISSYT=IRPDPD(IRREP,ISYTYP(1,LISTT))
       NUMSYT=IRPDPD(IRREP,ISYTYP(2,LISTT))
       DISSYG=IRPDPD(IRREP,ISYTYP(1,LISTG))
       NUMSYG=IRPDPD(IRREP,ISYTYP(2,LISTG))
C
C  FOR CCSD CALCULATE FIRST THE CONTRIBUTION OF H4 TO GAMMA6
C
CJ       IF(CCSD) THEN
CJ        DISSYH1=IRPDPD(IRREP,ISYTYP(1,20+ISPIN))
CJ        DISSYH2=IRPDPD(IRREP,ISYTYP(1,LISTH2))
CJ        NUMSYH1=IRPDPD(IRREP,ISYTYP(2,20+ISPIN))
CJ        NUMSYH2=IRPDPD(IRREP,ISYTYP(2,LISTH2))
CJ        I001=1
CJ        I002=I001+IINTFP*MAX(NUMSYH1*DISSYH1,NUMSYH2*DISSYH2,
CJ     &                       DISSYG*NUMSYG)
CJ        I003=I002+IINTFP*MAX(NUMSYH2*DISSYH2,NUMSYH1*DISSYH1)
CJ        I004=I003+IINTFP*NUMSYG*DISSYG
CJ        I005=I004+3*IINTFP*MAX(NUMSYH1,NUMSYH2,NUMSYG,DISSYH1,
CJ     &                         DISSYH2,DISSYG)
CJ        IF(I005.LT.MXCOR) THEN
CJ         CALL H4G6AB(ICORE(I001),ICORE(I002),ICORE(I002),ICORE(I003),
CJ     &               ICORE(I001),ICORE(I0T1),ICORE(I0T2),FACTH,
CJ     &               DISSYH1,DISSYH2,DISSYG,NUMSYH1,NUMSYH2,NUMSYG,
CJ     &               POP(1,ISPIN),POP(1,3-ISPIN),VRT(1,ISPIN),
CJ     &               VRT(1,3-ISPIN),LISTH1,LISTH2,LISTG,ISPIN,
CJ     &               IRREP,IUHF,ICORE(I005),TRIP1,LISTG1)
CJ        ELSE
CJ         CALL INSMEM('H4G6AB',I005,MXCOR)
CJ        ENDIF
CJ       ENDIF
C
       I001=1
       I002=I001+IINTFP*MAX(NUMSYT*NUMSYT,NUMSYT*DISSYT,NF1(ISPIN))
       I003=I002+IINTFP*NUMSYT*DISSYT
       I004=I003+IINTFP*NUMSYG*DISSYG
c       IF(MIN(NUMSYT,NUMSYG,DISSYT,DISSYG).NE.0) THEN
       IF(MIN(NUMSYT,NUMSYG,DISSYG).NE.0) THEN
        I005=I004+3*IINTFP*MAX(NUMSYG,NUMSYT,DISSYG,DISSYT)
        IF(MXCOR.GT.I005) THEN
         CALL G6AB(ICORE(I001),ICORE(I002),ICORE(I003),
     &             ICORE(IOFFT),ICORE(I0T1A),ICORE(I0T1B),
     &             ICORE(I001),FACT,LAMBDA,TAU,TRIP1,ISPIN,
     &             POP(1,ISPIN),POP(1,3-ISPIN),VRT(1,ISPIN),
     &             VRT(1,3-ISPIN),NT,DISSYT,NUMSYT,DISSYG,
     &             NUMSYG,LISTT,LISTL,LISTG,IRREP,ICORE(I004))
        ELSE 
         CALL INSMEM('G6AB',I005,MXCOR)
        ENDIF
       ENDIF
200   CONTINUE
1000  CONTINUE
C
C ALL DONE
C
c      CALL CHECKGAM(ICORE,10,110,2.)
c      IF(IUHF.EQ.1) THEN
c       CALL CHECKGAM(ICORE,7,107,2.)
c       CALL CHECKGAM(ICORE,8,108,2.)
c       CALL CHECKGAM(ICORE,9,109,2.)
c      ENDIF
C
      RETURN
      END
