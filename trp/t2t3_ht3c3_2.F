      SUBROUTINE T2T3_HT3C3_2(T3,W,ICORE,VIJBB,VIKAB,VJKAB,VIKAB2,
     &                       VJKAB2,IADT3,IADW,IRPI,IRPJ,IRPK,IRPIJ,
     &                       IRPIK,IRPJK,IRPIJK,I,J,K,LNVOIJ,LNVOIK,
     &                       LNVOJK,LNVOIK2,LNVOJK2,LAMBDA)
      IMPLICIT INTEGER (A-Z)
      LOGICAL LAMBDA
      DOUBLE PRECISION T3(1),W(1),ICORE(1)
      DOUBLE PRECISION VIJBB(LNVOIJ,1),
     1                 VIKAB(LNVOIK,1),VIKAB2(LNVOIK2,1),
     1                 VJKAB(LNVOJK,1),VJKAB2(LNVOJK2,1)
      DIMENSION IADW(8),IADT3(8)
      DIMENSION IADV(8),LENV(8)

      COMMON /MACHSP/ IINTLN,IFLTLN,IINTFP,IALONE,IBITWD
      COMMON /SYMINF/ NSTART,NIRREP,IRREPA(255),IRREPB(255),
     1                DIRPRD(8,8)
      COMMON /SYMPOP/ IRPDPD(8,22),ISYTYP(2,500),ID(18)
      COMMON /SYM/    POP(8,2),VRT(8,2),NTAA,NTBB,NF1AA,NF2AA,
     1                NF1BB,NF2BB
      COMMON /INFO/   NOCCO(2),NVRTO(2)
C
      COMMON /T3OFF/  IOFFVV(8,8,10),IOFFOO(8,8,10),IOFFVO(8,8,4)
      COMMON /T2ILIS/ LIST2I1,LIST2I2,LIST2I3
C
      INDEX(I) = I*(I-1)/2
C     List offset
      IF (LAMBDA) THEN
         LISTOFF=200
      ELSE
         LISTOFF=0
      ENDIF
C
C     ROUTINE TO COMPUTE INCLUSION OF T3 BBA TO T2 BB AND T2 AB
C
C      AB  AB                      ABC
C     D   T    =  - SUM  <JK//MC> T       I<J<K   T3(AB,C) * V(C)
C      IM  IM       J<K            IJK
C                    C
C
C      BB  BB             BA  BA   BBA
C      BB  BB                      BBA
C
C
C     SET ADDRESSES FOR INTEGRALS/INTERMEDIATES.
C
      DO   10 IRPM=1,NIRREP
      IRPC = DIRPRD(IRPM,IRPJK)
      LENV(IRPM) = VRT(IRPC,1)*POP(IRPM,2)
      IF(IRPM.EQ.1)THEN
      IADV(IRPM) = 1
      ELSE
      IADV(IRPM) = IADV(IRPM-1) + LENV(IRPM-1)
      ENDIF
   10 CONTINUE
C
C     SET ADDRESS FOR T2 MATRIX.
C
      IOFFT2 = IADV(NIRREP) + LENV(NIRREP)
C
      JK = (J-1)*POP(IRPK,1) + K
C
      DO   50 IRPM=1,NIRREP
      IF(POP(IRPM,2).EQ.0) GOTO 50
C
      IRPIM = DIRPRD(IRPI,IRPM)
      IF(IRPM.GT.IRPI)THEN
      DO   20 M=1,POP(IRPM,2)
      IM = IOFFOO(IRPM,IRPIM,2) + (M-1)*POP(IRPI,2) + I
      CALL GETLST(ICORE(IOFFT2),IM,1,1,IRPIM,LIST2I2+LISTOFF)
C
      IRPC = DIRPRD(IRPM,IRPJK)
      IRPAB = DIRPRD(IRPC,IRPIJK)
      CALL MATVEC(T3(IADT3(IRPC)),
     1            VJKAB(IADV(IRPM) + (M-1)*VRT(IRPC,1),JK),
     1            ICORE(IOFFT2),IRPDPD(IRPAB,2),VRT(IRPC,1),0,1)
C
      CALL PUTLST(ICORE(IOFFT2),IM,1,1,IRPIM,LIST2I2+LISTOFF)
   20 CONTINUE
      ENDIF
      IF(IRPM.LT.IRPI)THEN
      DO   30 M=1,POP(IRPM,2)
      IM = IOFFOO(IRPI,IRPIM,2) + (I-1)*POP(IRPM,2) + M
      CALL GETLST(ICORE(IOFFT2),IM,1,1,IRPIM,LIST2I2+LISTOFF)
C
      IRPC = DIRPRD(IRPM,IRPJK)
      IRPAB = DIRPRD(IRPC,IRPIJK)
      CALL MATVEC(T3(IADT3(IRPC)),
     1            VJKAB(IADV(IRPM) + (M-1)*VRT(IRPC,1),JK),
     1            ICORE(IOFFT2),IRPDPD(IRPAB,2),VRT(IRPC,1),0,0)
C
      CALL PUTLST(ICORE(IOFFT2),IM,1,1,IRPIM,LIST2I2+LISTOFF)
   30 CONTINUE
      ENDIF
      IF(IRPM.EQ.IRPI)THEN
      DO   40 M=1,POP(IRPM,2)
      IF(M.GT.I)THEN
      IM = IOFFOO(IRPM,IRPIM,2) + INDEX(M-1) + I
      CALL GETLST(ICORE(IOFFT2),IM,1,1,IRPIM,LIST2I2+LISTOFF)
C
      IRPC = DIRPRD(IRPM,IRPJK)
      IRPAB = DIRPRD(IRPC,IRPIJK)
      CALL MATVEC(T3(IADT3(IRPC)),
     1            VJKAB(IADV(IRPM) + (M-1)*VRT(IRPC,1),JK),
     1            ICORE(IOFFT2),IRPDPD(IRPAB,2),VRT(IRPC,1),0,1)
C
      CALL PUTLST(ICORE(IOFFT2),IM,1,1,IRPIM,LIST2I2+LISTOFF)
      ENDIF
      IF(M.LT.I)THEN
      IM = IOFFOO(IRPI,IRPIM,2) + INDEX(I-1) + M
      CALL GETLST(ICORE(IOFFT2),IM,1,1,IRPIM,LIST2I2+LISTOFF)
C
      IRPC = DIRPRD(IRPM,IRPJK)
      IRPAB = DIRPRD(IRPC,IRPIJK)
      CALL MATVEC(T3(IADT3(IRPC)),
     1            VJKAB(IADV(IRPM) + (M-1)*VRT(IRPC,1),JK),
     1            ICORE(IOFFT2),IRPDPD(IRPAB,2),VRT(IRPC,1),0,0)
C
      CALL PUTLST(ICORE(IOFFT2),IM,1,1,IRPIM,LIST2I2+LISTOFF)
      ENDIF
   40 CONTINUE
      ENDIF
   50 CONTINUE
C
C      AB  AB                      ABC
C     D   T    =    SUM  <IK//MC> T       I<J<K   T3(AB,C) * V(C)
C      JM  JM       I<K            IJK
C                    C
C
C      BB  BB             BA  BA   BBA
C      BB  BB                      BBA
C
C
C     SET ADDRESSES FOR INTEGRALS/INTERMEDIATES.
C
      DO  110 IRPM=1,NIRREP
      IRPC = DIRPRD(IRPM,IRPIK)
      LENV(IRPM) = VRT(IRPC,1)*POP(IRPM,2)
      IF(IRPM.EQ.1)THEN
      IADV(IRPM) = 1
      ELSE
      IADV(IRPM) = IADV(IRPM-1) + LENV(IRPM-1)
      ENDIF
  110 CONTINUE
C
C     SET ADDRESS FOR T2 MATRIX.
C
      IOFFT2 = IADV(NIRREP) + LENV(NIRREP)
C
      IK = (I-1)*POP(IRPK,1) + K
C
      DO  150 IRPM=1,NIRREP
      IF(POP(IRPM,2).EQ.0) GOTO 150
C
      IRPJM = DIRPRD(IRPJ,IRPM)
      IF(IRPM.GT.IRPJ)THEN
      DO  120 M=1,POP(IRPM,2)
      JM = IOFFOO(IRPM,IRPJM,2) + (M-1)*POP(IRPJ,2) + J
      CALL GETLST(ICORE(IOFFT2),JM,1,1,IRPJM,LIST2I2+LISTOFF)
C
      IRPC = DIRPRD(IRPM,IRPIK)
      IRPAB = DIRPRD(IRPC,IRPIJK)
      CALL MATVEC(T3(IADT3(IRPC)),
     1            VIKAB(IADV(IRPM) + (M-1)*VRT(IRPC,1),IK),
     1            ICORE(IOFFT2),IRPDPD(IRPAB,2),VRT(IRPC,1),0,0)
C
      CALL PUTLST(ICORE(IOFFT2),JM,1,1,IRPJM,LIST2I2+LISTOFF)
  120 CONTINUE
      ENDIF
      IF(IRPM.LT.IRPJ)THEN
      DO  130 M=1,POP(IRPM,2)
      JM = IOFFOO(IRPJ,IRPJM,2) + (J-1)*POP(IRPM,2) + M
      CALL GETLST(ICORE(IOFFT2),JM,1,1,IRPJM,LIST2I2+LISTOFF)
C
      IRPC = DIRPRD(IRPM,IRPIK)
      IRPAB = DIRPRD(IRPC,IRPIJK)
      CALL MATVEC(T3(IADT3(IRPC)),
     1            VIKAB(IADV(IRPM) + (M-1)*VRT(IRPC,1),IK),
     1            ICORE(IOFFT2),IRPDPD(IRPAB,2),VRT(IRPC,1),0,1)
C
      CALL PUTLST(ICORE(IOFFT2),JM,1,1,IRPJM,LIST2I2+LISTOFF)
  130 CONTINUE
      ENDIF
      IF(IRPM.EQ.IRPJ)THEN
      DO  140 M=1,POP(IRPM,2)
      IF(M.GT.J)THEN
      JM = IOFFOO(IRPM,IRPJM,2) + INDEX(M-1) + J
      CALL GETLST(ICORE(IOFFT2),JM,1,1,IRPJM,LIST2I2+LISTOFF)
C
      IRPC = DIRPRD(IRPM,IRPIK)
      IRPAB = DIRPRD(IRPC,IRPIJK)
      CALL MATVEC(T3(IADT3(IRPC)),
     1            VIKAB(IADV(IRPM) + (M-1)*VRT(IRPC,1),IK),
     1            ICORE(IOFFT2),IRPDPD(IRPAB,2),VRT(IRPC,1),0,0)
C
      CALL PUTLST(ICORE(IOFFT2),JM,1,1,IRPJM,LIST2I2+LISTOFF)
      ENDIF
      IF(M.LT.J)THEN
      JM = IOFFOO(IRPJ,IRPJM,2) + INDEX(J-1) + M
      CALL GETLST(ICORE(IOFFT2),JM,1,1,IRPJM,LIST2I2+LISTOFF)
C
      IRPC = DIRPRD(IRPM,IRPIK)
      IRPAB = DIRPRD(IRPC,IRPIJK)
      CALL MATVEC(T3(IADT3(IRPC)),
     1            VIKAB(IADV(IRPM) + (M-1)*VRT(IRPC,1),IK),
     1            ICORE(IOFFT2),IRPDPD(IRPAB,2),VRT(IRPC,1),0,1)
C
      CALL PUTLST(ICORE(IOFFT2),JM,1,1,IRPJM,LIST2I2+LISTOFF)
      ENDIF
  140 CONTINUE
      ENDIF
  150 CONTINUE
C
C      BC  BC                      ABC
C     D   T    =  - SUM  <IJ//MA> T       I<J<K   W(A,BC) * V(A)
C      MK  MK       I<J            IJK
C                    A
C
C      BA  BA             BB  BB   BBA
C      BA  BA                      BBA
C
C
C     SET ADDRESSES FOR INTEGRALS/INTERMEDIATES.
C
      DO  210 IRPM=1,NIRREP
      IRPA = DIRPRD(IRPM,IRPIJ)
      LENV(IRPM) = VRT(IRPA,2)*POP(IRPM,2)
      IF(IRPM.EQ.1)THEN
      IADV(IRPM) = 1
      ELSE
      IADV(IRPM) = IADV(IRPM-1) + LENV(IRPM-1)
      ENDIF
  210 CONTINUE
C
C     SET ADDRESS FOR T2 MATRIX.
C
      IOFFT2 = IADV(NIRREP) + LENV(NIRREP)
C
      IF(IRPI.EQ.IRPJ)THEN
      IJ = INDEX(J-1) + I
      ELSE
      IJ = (J-1)*POP(IRPI,2) + I
      ENDIF
C
      DO  250 IRPM=1,NIRREP
      IF(POP(IRPM,2).EQ.0) GOTO 250
C
      IRPMK = DIRPRD(IRPM,IRPK)
      DO  220 M=1,POP(IRPM,2)
      MK = IOFFOO(IRPM,IRPMK,5) + (M-1)*POP(IRPK,1) + K
      CALL GETLST(ICORE(IOFFT2),MK,1,1,IRPMK,LIST2I3+LISTOFF)
C
      IRPA = DIRPRD(IRPM,IRPIJ)
      IRPBC = DIRPRD(IRPA,IRPIJK)
C      CALL VECMAT(VIJBB(IADV(IRPM) + (M-1)*VRT(IRPA,2),IJ),
C     1            W(IADW(IRPA)),ICORE(IOFFT2),
C     1            VRT(IRPA,2),IRPDPD(IRPBC,13),0,0)
      CALL MATVEC(W(IADW(IRPA)),
     1            VIJBB(IADV(IRPM) + (M-1)*VRT(IRPA,2),IJ),
     1            ICORE(IOFFT2),
     1            IRPDPD(IRPBC,13),VRT(IRPA,2),0,0)
C
      CALL PUTLST(ICORE(IOFFT2),MK,1,1,IRPMK,LIST2I3+LISTOFF)
  220 CONTINUE
  250 CONTINUE
C
 1000 CONTINUE
C
C      BC  BC                      ABC
C     D   T    =    SUM  <JK//AM> T       I<J<K   W(A,BC) * V(A)
C      IM  IM       J<K            IJK
C                    A
C
C      BA  BA             BA  BA   BBA
C      BA  BA                      BBA
C
C
C     SET ADDRESSES FOR INTEGRALS/INTERMEDIATES.
C
      DO  310 IRPM=1,NIRREP
      IRPA = DIRPRD(IRPM,IRPJK)
      LENV(IRPM) = VRT(IRPA,2)*POP(IRPM,1)
      IF(IRPM.EQ.1)THEN
      IADV(IRPM) = 1
      ELSE
      IADV(IRPM) = IADV(IRPM-1) + LENV(IRPM-1)
      ENDIF
  310 CONTINUE
C
C     SET ADDRESS FOR T2 MATRIX.
C
      IOFFT2 = IADV(NIRREP) + LENV(NIRREP)
C
      JK = (J-1)*POP(IRPK,1) + K
C
      DO  350 IRPM=1,NIRREP
      IF(POP(IRPM,1).EQ.0) GOTO 350
C
      IRPIM = DIRPRD(IRPI,IRPM)
      DO  320 M=1,POP(IRPM,1)
      IM = IOFFOO(IRPI,IRPIM,5) + (I-1)*POP(IRPM,1) + M
      CALL GETLST(ICORE(IOFFT2),IM,1,1,IRPIM,LIST2I3+LISTOFF)
C
      IRPA = DIRPRD(IRPM,IRPJK)
      IRPBC = DIRPRD(IRPA,IRPIJK)
C      CALL VECMAT(VJKAB2(IADV(IRPM) + (M-1)*VRT(IRPA,2),JK),
C     1            W(IADW(IRPA)),ICORE(IOFFT2),
C     1            VRT(IRPA,2),IRPDPD(IRPBC,13),0,0)
      CALL MATVEC(W(IADW(IRPA)),
     1            VJKAB2(IADV(IRPM) + (M-1)*VRT(IRPA,2),JK),
     1            ICORE(IOFFT2),
     1            IRPDPD(IRPBC,13),VRT(IRPA,2),0,0)
      CALL PUTLST(ICORE(IOFFT2),IM,1,1,IRPIM,LIST2I3+LISTOFF)
  320 CONTINUE
  350 CONTINUE
C
C      BC  BC                      ABC
C     D   T    =  - SUM  <IK//AM> T       I<J<K   W(A,BC) * V(A)
C      JM  JM       I<K            IJK
C                    A
C
C      BA  BA             BA  BA   BBA
C      BA  BA                      BBA
C
C
C     SET ADDRESSES FOR INTEGRALS/INTERMEDIATES.
C
      DO  410 IRPM=1,NIRREP
      IRPA = DIRPRD(IRPM,IRPIK)
      LENV(IRPM) = VRT(IRPA,2)*POP(IRPM,1)
      IF(IRPM.EQ.1)THEN
      IADV(IRPM) = 1
      ELSE
      IADV(IRPM) = IADV(IRPM-1) + LENV(IRPM-1)
      ENDIF
  410 CONTINUE
C
C     SET ADDRESS FOR T2 MATRIX.
C
      IOFFT2 = IADV(NIRREP) + LENV(NIRREP)
C
      IK = (I-1)*POP(IRPK,1) + K
C
      DO  450 IRPM=1,NIRREP
      IF(POP(IRPM,1).EQ.0) GOTO 450
C
      IRPJM = DIRPRD(IRPJ,IRPM)
      DO  420 M=1,POP(IRPM,1)
      JM = IOFFOO(IRPJ,IRPJM,5) + (J-1)*POP(IRPM,1) + M
      CALL GETLST(ICORE(IOFFT2),JM,1,1,IRPJM,LIST2I3+LISTOFF)
C
      IRPA = DIRPRD(IRPM,IRPIK)
      IRPBC = DIRPRD(IRPA,IRPIJK)
C      CALL VECMAT(VIKAB2(IADV(IRPM) + (M-1)*VRT(IRPA,2),IK),
C     1            W(IADW(IRPA)),ICORE(IOFFT2),
C     1            VRT(IRPA,2),IRPDPD(IRPBC,13),0,1)
      CALL MATVEC(W(IADW(IRPA)),
     1            VIKAB2(IADV(IRPM) + (M-1)*VRT(IRPA,2),IK),
     1            ICORE(IOFFT2),
     1            IRPDPD(IRPBC,13),VRT(IRPA,2),0,1)
      CALL PUTLST(ICORE(IOFFT2),JM,1,1,IRPJM,LIST2I3+LISTOFF)
  420 CONTINUE
  450 CONTINUE
      RETURN
      END
