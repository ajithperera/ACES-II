      SUBROUTINE T3IT_TRPS3(T1A,T1B,FOVA,FOVB,D1T1A,D1T1B,S1A,S1B,
     1                 EVAL,SCR1,SCR2,SCR3,
     1                 OOOV,OOOV2,GOOOV,BUF,
     1                 T2BAB,T2BAAI,T2BAAJ,T2BBBI,T2BBBJ,
     1                 IADBLK,LENBLK,IADT2,LENT2,
     1                 IADV,LENV,OOOVAD,LENINT,
     1                 ICORE,
     1                 LNOOOV,NOCA,NOCB,NVRTA,NVRTB,NFREE,
     1                 INT1,INT2,NONHF,IUHF,T3STOR,INIT)

      IMPLICIT INTEGER (A-Z)
      LOGICAL INT1,INT2,NONHF
      LOGICAL IJEQL,NONEQL, INIT
      LOGICAL CCSDT4,CCSDT,LCCSD_T,FINAL
      LOGICAL TRIPNI,TRIPNI1,TRIPIT,T3STOR

      DOUBLE PRECISION T1A(1),T1B(1),FOVA(1),FOVB(1),
     1                 D1T1A(1),D1T1B(1),S1A(1),S1B(1), DDOT,
     1                 SCR1(1),SCR2(1),SCR3(1),EVAL(NOCA+NVRTA,2)
      DOUBLE PRECISION  OOOV(LNOOOV,4),OOOV2(LNOOOV,4),
     1                 GOOOV(LNOOOV,4),BUF(1)
      DOUBLE PRECISION T2BAB(1),T2BAAI(1),T2BAAJ(1),
     1                 T2BBBI(1),T2BBBJ(1)
      DOUBLE PRECISION ICORE(1)
C
      DOUBLE PRECISION E14, E2AAB, E2BBA
      DOUBLE PRECISION E5TEST,SDOT,E6TEST
      DOUBLE PRECISION DIJK
C
#include "maxbasfn.par"
#include "flags.h"
      DIMENSION OOOVAD(8,4),LENINT(8,4)
      DIMENSION LEN(8,8),IADBLK(8),LENBLK(8)
      DIMENSION                        IADT2(8) ,LENT2(8),
     1                                 IADV(8)  ,LENV(8)
      DIMENSION IADW(8),LENW(8)
      DIMENSION IADW2(8)
C
      COMMON /MACHSP/ IINTLN,IFLTLN,IINTFP,IALONE,IBITWD
      COMMON /SYMINF/ NSTART,NIRREP,IRREPA(255),IRREPB(255),DIRPRD(8,8)
      COMMON /SYMPOP/ IRPDPD(8,22),ISYTYP(2,500),ID(18)
      COMMON /SYM/    POP(8,2),VRT(8,2),NTAA,NTBB,NF1AA,NF2AA,
     1                NF1BB,NF2BB
      COMMON /INFO/   NOCCO(2),NVRTO(2)
      COMMON /FLAGS/  IFLAGS(100)
C
C     T3 ARRAYS
C
      COMMON /ACTORB/ ABSVRT(MAXBASFN,8,2),ABSOCC(MAXBASFN,8,2)
      COMMON /T3OFF/  IOFFVV(8,8,10),IOFFOO(8,8,10),IOFFVO(8,8,4)
      COMMON /LISWI/  LWIC11,LWIC12,LWIC13,LWIC14,
     1                LWIC15,LWIC16,LWIC17,LWIC18,
     1                LWIC21,LWIC22,LWIC23,LWIC24,
     1                LWIC25,LWIC26,LWIC27,LWIC28,
     1                LWIC31,LWIC32,LWIC33,
     1                LWIC34,LWIC35,LWIC36,
     1                LWIC37,LWIC38,LWIC39,LWIC40,LWIC41,LWIC42
      COMMON /TESTEN/ E5TEST,E6TEST
      COMMON /EDEBUG/ E14, E2AAB, E2BBA
      COMMON /T3IOOF/ IJKPOS(8,8,8,2),IJKLEN(36,8,4),IJKOFF(36,8,4),
     1                NCOMB(4)
      INDEX(I) = I*(I-1)/2
C
      WRITE(6,1015)
 1015 FORMAT(' @TRPS3-I, Spin case BBA ')
C
C     Get eigenvalues (more precisely, diagonal Fock matrix elements)
C
      CALL GETREC(20,'JOBARC','SCFEVALA',(NOCA+NVRTA)*IINTFP,
     1            EVAL(1,1))
      CALL GETREC(20,'JOBARC','SCFEVALB',(NOCB+NVRTB)*IINTFP,
     1            EVAL(1,2))
C
C     Determine the lengths and dimensions of the NIRREP**2 T2 BBA arrays.
C
C      WRITE(6,1070)
 1070 FORMAT(' @TRPS3-I, TRIPLES SYMMETRY BLOCK INFORMATION ')
      DO  100 IRPIJK=1,NIRREP
      DO   90 IRPC  =1,NIRREP
      IRPAB = DIRPRD(IRPIJK,IRPC)
      LEN(IRPC,IRPIJK) = IRPDPD(IRPAB,2) * VRT(IRPC,1)
C      WRITE(6,1080) IRPIJK,IRPC,IRPAB,LEN(IRPC,IRPIJK)
 1080 FORMAT('   FOR IJK BLOCK ',I4,/,
     1       '       C   BLOCK ',I4,' AB BLOCK ',I4,' LENGTH IS ',I6)
   90 CONTINUE
  100 CONTINUE
C
C     Compute addresses and lengths of OOOV quantities.
C
      DO  410 ISPIN=1,4
      DO  400 IRREP=1,NIRREP
      IF(ISPIN.EQ.1)THEN
      LENINT(IRREP,ISPIN) = IRPDPD(IRREP, 3) * IRPDPD(IRREP,16)
      ENDIF
      IF(ISPIN.EQ.2)THEN
      LENINT(IRREP,ISPIN) = IRPDPD(IRREP, 4) * IRPDPD(IRREP,17)
      ENDIF
      IF(ISPIN.EQ.3)THEN
      LENINT(IRREP,ISPIN) = IRPDPD(IRREP,14) * IRPDPD(IRREP,11)
      ENDIF
      IF(ISPIN.EQ.4)THEN
      LENINT(IRREP,ISPIN) = IRPDPD(IRREP,14) * IRPDPD(IRREP,18)
      ENDIF
  400 CONTINUE
  410 CONTINUE
C
      OOOVAD(1,1) = 1
      OOOVAD(1,2) = 1
      OOOVAD(1,3) = 1
      OOOVAD(1,4) = 1
      DO  430 ISPIN=1,4
      IF(NIRREP.GT.1)THEN
      DO  420 IRREP = 2,NIRREP
      OOOVAD(IRREP,ISPIN) = OOOVAD(IRREP-1,ISPIN) +
     1                      LENINT(IRREP-1,ISPIN)
  420 CONTINUE
      ENDIF
  430 CONTINUE
C      WRITE(6,1200)
 1200 FORMAT(' @TRPS3-I, OOOV ARRAY LENGTHS AND ADDRESSES ')
      DO  450 ISPIN=1,4
      DO  440 IRREP=1,NIRREP
C      WRITE(6,1210) ISPIN,IRREP,LENINT(IRREP,ISPIN),OOOVAD(IRREP,ISPIN)
 1210 FORMAT(' SPIN, IRREP, LENGTH, ADDRESS ',2I4,I6,I6)
  440 CONTINUE
  450 CONTINUE
C
      DO  460 IRREP=1,NIRREP
      CALL GETTRN(OOOV(OOOVAD(IRREP,4),4),BUF,
     1            IRPDPD(IRREP,14),IRPDPD(IRREP,18),
     1            2,IRREP,LWIC14)
C    1            2,IRREP,10)
      CALL GETTRN(OOOV(OOOVAD(IRREP,2),2),BUF,
     1            IRPDPD(IRREP, 4),IRPDPD(IRREP,17),
     1            2,IRREP,LWIC12)
C    1            2,IRREP,8)
      CALL GETTRN(OOOV(OOOVAD(IRREP,3),3),BUF,
     1            IRPDPD(IRREP,14),IRPDPD(IRREP,11),
     1            2,IRREP,LWIC13)
C    1            2,IRREP,9)
  460 CONTINUE

C
      DO  471 IRPIJ=1,NIRREP
      CALL SYMTR3(IRPIJ,POP(1,2),VRT(1,2),IRPDPD(IRPIJ,17),
     1            IRPDPD(IRPIJ,4),OOOV(OOOVAD(IRPIJ,2),2),
     1            SCR1,SCR2,SCR3)
      CALL SYMTR3(IRPIJ,VRT(1,1),POP(1,2),IRPDPD(IRPIJ,11),
     1            IRPDPD(IRPIJ,14),OOOV(OOOVAD(IRPIJ,3),3),
     1            SCR1,SCR2,SCR3)
      CALL SYMTR3(IRPIJ,POP(1,1),VRT(1,2),IRPDPD(IRPIJ,12),
     1            IRPDPD(IRPIJ,14),OOOV(OOOVAD(IRPIJ,4),4),
     1            SCR1,SCR2,SCR3)
  471 CONTINUE
C
      IF(INT2)THEN
C
      DO  9460 IRREP=1,NIRREP
      CALL GETTRN(OOOV2(OOOVAD(IRREP,4),4),BUF,
     1            IRPDPD(IRREP,14),IRPDPD(IRREP,18),
     1            2,IRREP,LWIC24)
      CALL GETTRN(OOOV2(OOOVAD(IRREP,2),2),BUF,
     1            IRPDPD(IRREP, 4),IRPDPD(IRREP,17),
     1            2,IRREP,LWIC22)
      CALL GETTRN(OOOV2(OOOVAD(IRREP,3),3),BUF,
     1            IRPDPD(IRREP,14),IRPDPD(IRREP,11),
     1            2,IRREP,LWIC23)
 9460 CONTINUE
C
      DO  9471 IRPIJ=1,NIRREP
      CALL SYMTR3(IRPIJ,POP(1,2),VRT(1,2),IRPDPD(IRPIJ,17),
     1            IRPDPD(IRPIJ,4),OOOV2(OOOVAD(IRPIJ,2),2),
     1            SCR1,SCR2,SCR3)
      CALL SYMTR3(IRPIJ,POP(1,1),VRT(1,2),IRPDPD(IRPIJ,12),
     1            IRPDPD(IRPIJ,14),OOOV2(OOOVAD(IRPIJ,4),4),
     1            SCR1,SCR2,SCR3)
 9471 CONTINUE
      ENDIF
C
C     Compute number of free double words.
      MCORE = NFREE / IINTFP
cYAU      WRITE(6,1230) NFREE,MCORE,IINTFP
 1230 FORMAT(' @TRPS3-I, Number of free integer words ',I10,/,
     1       '           Number of free double  words ',I10,/,
     1       '           Ratio                        ',I10)
C
      ISPIN1 = 2
      ISPIN2 = 1
C
      DO IRPIJK=1,NIRREP
C
      IJKVAL = 0
C
      DO  IRPK  =1,NIRREP
      IF(POP(IRPK,ISPIN2).EQ.0) GOTO 990
C
      KLOW  = 1
      KHIGH = POP(IRPK,ISPIN2)
C
      DO  IRPJ=1,NIRREP
      IF(POP(IRPJ,ISPIN1).EQ.0) GOTO 980
      IRPJK = DIRPRD(IRPJ,IRPK)
      IRPI  = DIRPRD(IRPJK,IRPIJK)
      IF(IRPI.GT.IRPJ) GOTO 980
C
      IF(POP(IRPI,ISPIN1).EQ.0) GOTO 980
C
      IJEQL  = .FALSE.
      NONEQL = .FALSE.
      IF(IRPI.EQ.IRPJ)THEN
      IJEQL  = .TRUE.
      JLOW  = 2
      JHIGH = POP(IRPJ,ISPIN1)
      ILOW  = 1
      NIJ = (POP(IRPJ,ISPIN1) * (POP(IRPJ,ISPIN1)-1))/2
      ELSE
      NONEQL = .TRUE.
      JLOW  = 1
      JHIGH = POP(IRPJ,ISPIN1)
      ILOW  = 1
      IHIGH = POP(IRPI,ISPIN1)
      NIJ =  POP(IRPI,ISPIN1) * POP(IRPJ,ISPIN1)
      ENDIF
C
      NIK = POP(IRPI,ISPIN1) * POP(IRPK,ISPIN2)
      NJK = POP(IRPJ,ISPIN1) * POP(IRPK,ISPIN2)
C
      IF(IJEQL.AND.POP(IRPJ,ISPIN1).LT.2) GOTO 980
C
      IRPIJ =  DIRPRD(IRPI,IRPJ)
      IRPIK =  DIRPRD(IRPI,IRPK)
C
C     COMPUTE ADDRESSES AND LENGTHS OF ABC SYMMETRY BLOCKS FOR
C     THIS IJK. THIS LOOP IS EFFECTIVELY OVER IRREPS OF C (IE
C     COLUMNS OF THE EVENTUAL TARGET).
C
C     MAIN CORE VECTOR ADDRESSING : (DOUBLE PRECISION WORDS)
C
C           I000   SYMMETRY PACKED T3 FOR THIS IJK BLOCK
C           I010                   W
C           I020   UNEXPANDED T2(  ,IJ) BBBB FOR THIS IJ BLOCK
C           I030   EXPANDED   T2(  ,IJ) BBBB
C           I040   T2(  ,JK) ABAB FOR THIS JK BLOCK
C           I050   T2(  ,IK) ABAB FOR THIS IK BLOCK
C           ISTART CURRENT STARTING ADDRESS OF REUSABLE CORE
C
      I000 = 1
      DO  600 IRREP=1,NIRREP
      IF(IRREP.EQ.1)THEN
      IADBLK(IRREP) = 1
      ELSE
      IADBLK(IRREP) = IADBLK(IRREP-1) + LEN(IRREP-1,IRPIJK)
      ENDIF
      LENBLK(IRREP) = LEN(IRREP,IRPIJK)
  600 CONTINUE
C
      LENABC=0
      DO  610 IRREP=1,NIRREP
      LENABC = LENABC + LENBLK(IRREP)
  610 CONTINUE
C
      I010 = I000 + LENABC
      DO  630 IRREP=1,NIRREP
      IRPA = DIRPRD(IRPIJK,IRREP)
      LENW(IRREP) = VRT(IRPA,2) * IRPDPD(IRREP,13)
  630 CONTINUE
C
      DO  640 IRREP=1,NIRREP
      IF(IRREP.EQ.1)THEN
      IADW(IRREP) = 1
      ELSE
      IADW(IRREP) = IADW(IRREP-1) + LENW(IRREP-1)
      ENDIF
  640 CONTINUE
C
      IOFFT2 = I010
      DO  641 IRREP=1,NIRREP
      IOFFT2 = IOFFT2 + LENW(IRREP)
  641 CONTINUE
C
      I020 = IOFFT2
C     GET VARIOUS "SMALL" BLOCKS OF T2 AND <IJ//KA> IN CORE, ORGANIZED
C     APPROPRIATELY.
C
C     BLOCK OF BBBB T(  ,IJ) WHERE I AND J ARE DIFFERENT SYMMETRY
C     BLOCKS. LENGTH IS IRPDPD(IRPIJ,2) * NIJ.
C
      CALL GETLST(ICORE(I020),IOFFOO(IRPJ,IRPIJ,2)+1,NIJ,1,IRPIJ,45)
C
C     EXPAND INTO A DIFFERENT REGION OF CORE SO WE KEEP UNTOUCHED T2
C     AS WELL AS EXPANDED ONE. LENGTH IS DSZEXP * NIJ.
C
      DSZ   = IRPDPD(IRPIJ,2)
      DSZEXP= IRPDPD(IRPIJ,18+ISPIN1)
      I030 = I020 + DSZ    * NIJ
      I040 = I030 + DSZEXP * NIJ
      CALL SYMEXP2(IRPIJ,VRT(1,ISPIN1),DSZEXP,DSZ,NIJ,ICORE(I030),
     1             ICORE(I020))
C
C     BLOCK OF ABAB T(  ,JK). LENGTH IS IRPDPD(IRPJK,13) * NJK
C
      I050 = I040 + IRPDPD(IRPJK,13) * NJK
      CALL GETLST(ICORE(I040),IOFFOO(IRPJ,IRPJK,5)+1,NJK,1,IRPJK,46)
C
C     BLOCK OF ABAB T(  ,IK). LENGTH IS IRPDPD(IRPIK,13) * NIK
C
      CALL GETLST(ICORE(I050),IOFFOO(IRPI,IRPIK,5)+1,NIK,1,IRPIK,46)
C
      I060 = I050 + IRPDPD(IRPIK,13) * NIK
C
      LNVOIJ  = IRPDPD(IRPIJ,10)
      LNVOIK  = IRPDPD(IRPIK,11)
      LNVOJK  = IRPDPD(IRPJK,11)
      LNVOIK2 = IRPDPD(IRPIK,12)
      LNVOJK2 = IRPDPD(IRPJK,12)
C
C     SET A STARTING ADDRESS FOR REST OF CORE, THAT PART WHICH CAN BE
C     REUSED AFTER D1T3.
C
      I070 = I060 + LENABC
C
C     If this is a CCSD(T) or QCISD(T) gradient calculation, allocate
C     memory for "disconnected" triple amplitudes.
C
      I080 = I070 + LENABC
      I090 = I080 + I020 - I010
      I100 = I090 + LENABC

      ISTART = I100
      NLEFT  = MCORE - ISTART
C
      IF(ISTART+LENABC.GE.MCORE)THEN
         CALL INSMEM('TRPS3',ISTART+LENABC,MCORE)
      ENDIF
C
C     COMPUTE DENOMINATOR ARRAY

      CALL MKD33(ICORE(I060),EVAL,IADBLK,IRPIJK,NOCA,NOCB,NVRTA,NVRTB)
C
      DO  K=KLOW,KHIGH
      DO  J=JLOW,JHIGH
      IF(IJEQL) IHIGH = J-1
      DO  I=ILOW,IHIGH
C
      CALL ZERO(ICORE(I000),LENABC)
C
      LENGTHW = 0
      DO 9647 IRREP=1,NIRREP
      LENGTHW = LENGTHW + LENW(IRREP)
 9647 CONTINUE

      CALL ZERO(ICORE(I010),LENGTHW)
C
      CALL D1T3( ICORE(I000),ICORE(I010),
     1           ICORE(I030),ICORE(I040),ICORE(I050),
     1 OOOV(OOOVAD(IRPIJ,2)+IOFFOO(IRPJ,IRPIJ,2)*IRPDPD(IRPIJ,17),2),
     1 OOOV(OOOVAD(IRPJK,4)+IOFFOO(IRPJ,IRPJK,5)*IRPDPD(IRPJK,12),4),
     1 OOOV(OOOVAD(IRPIK,4)+IOFFOO(IRPI,IRPIK,5)*IRPDPD(IRPIK,12),4),
     1 OOOV(OOOVAD(IRPJK,3)+IOFFOO(IRPJ,IRPJK,5)*IRPDPD(IRPJK,11),3),
     1 OOOV(OOOVAD(IRPIK,3)+IOFFOO(IRPI,IRPIK,5)*IRPDPD(IRPIK,11),3),
     1 ICORE(ISTART),IUHF,
     1 IADBLK,LENBLK,IADW,LENW,IADT2,LENT2,IADV,LENV,
     1 I,J,K,IRPI,IRPJ,IRPK,IRPIJ,IRPJK,IRPIK,IRPIJK,
     1 DSZEXP,IRPDPD(IRPJK,13),IRPDPD(IRPIK,13),
     1 IRPDPD(IRPIJ,17),IRPDPD(IRPJK,12),IRPDPD(IRPIK,12),
     1 IRPDPD(IRPJK,11),IRPDPD(IRPIK,11),
     1 SCR1,SCR2,SCR3,.FALSE.)

      IJKVAL = IJKVAL + 1
      IF (.NOT. INIT) THEN
C
C     CCSD(T) of non-HF (non-canonical) if semicanonical orbitals not
C     used. (ii) Occupied orbital sum.

      CALL T3FT323V(ICORE(I000),ICORE(I010),ICORE(ISTART),NFREE,IUHF,
     1              2,1,LENABC,LENGTHW,IRPIJK,IJKVAL,IADBLK,IADW)
C
C     CCSDT of non-HF (non-canonical) if semicanonical orbitals not
C     used. (ii) Occupied orbital sum.
C
      CALL T3FT323O(ICORE(I000),ICORE(ISTART),NFREE,IUHF,2,1,LENABC,
     1              IRPI,IRPJ,IRPK,IRPIJK,I,J,K)

      ENDIF 

      CALL EXPSC3(ICORE(I000),ICORE(I010),IADBLK,IADW,IRPIJK)
C
C     REMOVE DENOMINATORS
C
      DIJK = EVAL(ABSOCC(I,IRPI,2),2) + EVAL(ABSOCC(J,IRPJ,2),2)
     1     + EVAL(ABSOCC(K,IRPK,1),1)

      CALL RMD314(ICORE(I000),ICORE(I060),LENABC,DIJK)

#ifdef _DEBUG_LVLM
      write(*,*)
      call checksum("ITER-TRPS3-0", ICORE(I000), LENABC)
#endif
C
C     If this is a CCSD(T) or QCISD(T) gradient calculation, compute
C     "disconnected" triple amplitudes.  For LCCSD(T) compute
C     disconnected lambda triple amplitude.
C
      CALL ZERO(ICORE(I070),LENABC)
      CALL ZERO(ICORE(I010),IOFFT2 - I010)
      CALL S1S223(ICORE(ISTART),ICORE(I070),ICORE(I010),IADBLK,IADW,
     1            2,1,I,J,K,IRPI,IRPJ,IRPK,IRPIJ,IRPIK,IRPJK,IRPIJK,
     1            IUHF,1,.FALSE.)

#ifdef _DEBUG_LVL0
      call checksum("ITER-TRPS3-1", ICORE(I070), LENABC)
#endif
      CALL ZERO(ICORE(I090),LENABC)
      CALL ZERO(ICORE(I010),IOFFT2 - I010)
      CALL S1S223(ICORE(ISTART),ICORE(I090),ICORE(I010),IADBLK,IADW,
     1            2,1,I,J,K,IRPI,IRPJ,IRPK,IRPIJ,IRPIK,IRPJK,IRPIJK,
     1            IUHF,2,.FALSE.)
      CALL DAXPY(LENABC, 1.0D0, ICORE(I090), 1, ICORE(I070), 1)
C
      CALL RMD314(ICORE(I070),ICORE(I060),LENABC,DIJK)
      CALL DAXPY(LENABC, 1.0D0, ICORE(I070), 1, ICORE(I000),1)

      CALL E4TCTDIJK(ICORE(I000), ICORE(I070), ICORE(I060),
     &               LENABC,DIJK, E2BBBA,__FILE__)

      IF(T3STOR)THEN
      CALL PUTLIST(ICORE(I000),IJKVAL,1,1,IRPIJK,ISPIN1 + 1)
#ifdef _DEBUG_LVL0
      write(*,*)
      call checksum("T3IT_TRPS3", ICORE(I000), LENABC)
#endif
      ENDIF

      ENDDO
      ENDDO
      ENDDO

 980  CONTINUE
      ENDDO
 990  CONTINUE
      ENDDO
      ENDDO

#ifdef _DEBUG_LVL0
      WRITE(6,3000) E2BBA
 3000 FORMAT(' @TRPS3-I, E2BBA ',F20.12)
#endif
      RETURN
      END
