      SUBROUTINE FORMWL(ICORE,MAXCOR,IUHF)
C
C THIS ROUTINE FORMS THE RING INTERMEDIATES [W(mbej)] WHICH
C  ARE APPROPRIATE FOR THE CCD, QCISD, AND CCSD EQUATIONS.
C
C          W(mbej) = 2 W'(mbej) - <mb||ej>
C
C WHERE W'(mbej) IS THE INTERMEDIATE USED IN THE ENERGY CALCULATION.
C
C FOR CCSD IN ADDITION THE FOLLOWINg TERMS HAVE TO BE SUBTRACTED
C
C  W(mbej) = 2 W'(mbej) - <mb||ej> - SUM m t(m,f) <ej||fb> +
C            
C            SUM n t(n,e) <nj||mb> + SUM n SUM f t(m,f) t(n,f) <nj||fb>
C
C HOWEVER, IT IS QUITE CHEAP TO RECALCULATE ALL THE ADDITIONAL TERMS
C SINCE THEY REQUIRE ONLY AT MOST N**5 OPERATIONS
C
CEND
      IMPLICIT INTEGER (A-Z)
      LOGICAL MBPT2,MBPT3,M4DQ,M4SDQ,M4SDTQ,CCD,QCISD,CCSD,UCC,CC2
      LOGICAL bRedundant
      LOGICAL HBAR_4LCCSD,ADC2
      LOGICAL IJAB_DEBUG
      DOUBLE PRECISION ONE,TWO,ONEM
      DIMENSION ICORE(MAXCOR)
      COMMON/METH/MBPT2,MBPT3,M4DQ,M4SDQ,M4SDTQ,CCD,QCISD,CCSD,UCC,CC2
      COMMON /MACHSP/ IINTLN,IFLTLN,IINTFP,IALONE,IBITWD
      COMMON /SYMINF/ NSTART,NIRREP,IRREPA(255),IRREPB(255),DIRPRD(8,8)
      COMMON /SYMPOP/ IRPDPD(8,22),ISYTYP(2,500),ID(18)
      COMMON /FLAGS2/IFLAGS2(500)
      COMMON /FLAGS/IFLAGS(100)
      DATA ONE /1.0/
      DATA TWO /2.0/
      DATA ONEM /-1.0/

      bRedundant=IFLAGS2(155).EQ.0
#ifdef _DEBUG_LVLM
      IJAB_DEBUG=.FALSE.
      Write(6,"(a,a)") " @-FORMWL:  List 121 and 122 instead of",
     +                 " 17 and 18 is read for <MB||EJ> Ints"
#endif 
C
C DO SPIN CASE AAAA
C
      ISIZE=ISYMSZ(ISYTYP(1,54),ISYTYP(2,54))
      I000=1
      I010=I000+IINTFP*ISIZE
      I020=I010+IINTFP*ISIZE
      IF (I020.GT.MAXCOR+1) CALL INSMEM("FORMWL",(I020-1),MAXCOR)
      CALL GETALL(ICORE,ISIZE,1,54)

      CALL SSCAL(ISIZE,TWO,ICORE,1)
      CALL GETALL(ICORE(I010),ISIZE,1,23)
      CALL SAXPY(ISIZE,ONEM,ICORE(I010),1,ICORE(I000),1)
      CALL PUTALL(ICORE,ISIZE,1,54)
C
C DO SPIN CASE ABAB
C
      ISIZE=ISYMSZ(ISYTYP(1,56),ISYTYP(2,56))
      I000=1
      I010=I000+IINTFP*ISIZE
      I020=I010+IINTFP*ISIZE
      IF (I020.GT.MAXCOR+1) CALL INSMEM("FORMWL",(I020-1),MAXCOR)
      CALL GETALL(ICORE,ISIZE,1,56)
      CALL SSCAL(ISIZE,TWO,ICORE,1)
      IF(bRedundant) THEN
         IF (IJAB_DEBUG) THEN
            CALL GETALL(ICORE(I010),ISIZE,1,122)
         ELSE
            CALL GETALL(ICORE(I010),ISIZE,1,18) 
         ENDIF 
      ELSE
         CALL GETALL_NR(ICORE(I010),ICORE(I020),MAXCOR-I020+1,18,1)
      ENDIF
      CALL SAXPY(ISIZE,ONEM,ICORE(I010),1,ICORE(I000),1)
      CALL PUTALL(ICORE,ISIZE,1,56)
C
C DO SPIN CASE ABBA
C
      ISIZE=ISYMSZ(ISYTYP(1,58),ISYTYP(2,58))
      I000=1
      I010=I000+IINTFP*ISIZE
      I020=I010+IINTFP*ISIZE
      IF (I020.GT.MAXCOR+1) CALL INSMEM("FORMWL",(I020-1),MAXCOR)
      CALL GETALL(ICORE,ISIZE,1,58)
      CALL SSCAL(ISIZE,TWO,ICORE,1)
      CALL GETALL(ICORE(I010),ISIZE,1,25)
      CALL SAXPY(ISIZE,ONEM,ICORE(I010),1,ICORE(I000),1)
      CALL PUTALL(ICORE,ISIZE,1,58)
C
C REMAINDER OF ROUTINE FOR UHF ONLY
C
      IF(IUHF.EQ.1)THEN
C
C DO SPIN CASE BBBB
C
      ISIZE=ISYMSZ(ISYTYP(1,55),ISYTYP(2,55))
      I000=1
      I010=I000+IINTFP*ISIZE
      I020=I010+IINTFP*ISIZE
      IF (I020.GT.MAXCOR+1) CALL INSMEM("FORMWL",(I020-1),MAXCOR)
      CALL GETALL(ICORE,ISIZE,1,55)
      CALL SSCAL(ISIZE,TWO,ICORE,1)
      CALL GETALL(ICORE(I010),ISIZE,1,24)
      CALL SAXPY(ISIZE,ONEM,ICORE(I010),1,ICORE(I000),1)
      CALL PUTALL(ICORE,ISIZE,1,55)
C
C DO SPIN CASE BABA
C
      ISIZE=ISYMSZ(ISYTYP(1,57),ISYTYP(2,57))
      I000=1
      I010=I000+IINTFP*ISIZE
      I020=I010+IINTFP*ISIZE
      IF (I020.GT.MAXCOR+1) CALL INSMEM("FORMWL",(I020-1),MAXCOR)
      CALL GETALL(ICORE,ISIZE,1,57)
      CALL SSCAL(ISIZE,TWO,ICORE,1)
      IF(bRedundant) THEN

         IF (IJAB_DEBUG) THEN
            CALL GETALL(ICORE(I010),ISIZE,1,121)
         ELSE
            CALL GETALL(ICORE(I010),ISIZE,1,17)
         ENDIF 

      ELSE
         CALL GETALL_NR(ICORE(I010),ICORE(I020),MAXCOR-I020+1,17,1)
      ENDIF
      CALL SAXPY(ISIZE,ONEM,ICORE(I010),1,ICORE(I000),1)
      CALL PUTALL(ICORE,ISIZE,1,57)
C
C DO SPIN CASE BAAB
C
      ISIZE=ISYMSZ(ISYTYP(1,59),ISYTYP(2,59))
      I000=1
      I010=I000+IINTFP*ISIZE
      I020=I010+IINTFP*ISIZE
      IF (I020.GT.MAXCOR+1) CALL INSMEM("FORMWL",(I020-1),MAXCOR)
      CALL GETALL(ICORE,ISIZE,1,59)
      CALL SSCAL(ISIZE,TWO,ICORE,1)
      CALL GETALL(ICORE(I010),ISIZE,1,26)
      CALL SAXPY(ISIZE,ONEM,ICORE(I010),1,ICORE(I000),1)
      CALL PUTALL(ICORE,ISIZE,1,59)
C
      ENDIF
C
C FOR CCSD DEAL HERE WITH THE SINGLE CONTRIBUTIONS
C
C
C Do not do this for LINCCSD HBAR(mn,ij) because this piece was
C was not included for LCCSD when the W(mb,ej) is constructed in 
C genint called from the CC code. 05/2015, Ajith Perera
C 
       HBAR_4LCCSD = .FALSE.
       ADC2        = .FALSE. 
       HBAR_4LCCSD = (IFLAGS2(117) .EQ. 7 .OR. IFLAGS(2) .EQ. 6)
       ADC2 =  (IFLAGS(2) .EQ. 1 .AND. IFLAGS(87) .EQ. 3 .AND.
     &          IFLAGS2(117) .EQ. 10)

       IF(CCSD) THEN
C
C SUBTRACT THE T1RING CONTRBUTIONS
C
       CALL T1RING(ICORE,MAXCOR,IUHF,.TRUE.)
C
C SUBTRACT THE T1**2 CONTRIBUTION 
C
       IF (.NOT. HBAR_4LCCSD) CALL T12INW3(ICORE,MAXCOR,IUHF)
C
C FOR UHF FORM THE ABAB CONTRIBUTION
C
       IF(IUHF.EQ.0) CALL QUIKAB(ICORE,MAXCOR,IUHF)
C
      ENDIF
      RETURN
      END
